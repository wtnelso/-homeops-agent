<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>HomeOps - Mobile</title>
  
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  
  <!-- Mobile-First CSS -->
  <style>
    /* MOBILE-FIRST RESET */
    :root {
      --vh: 1vh;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      height: 100vh;
      /* iOS viewport units fix */
      height: 100dvh;
      overflow: hidden;
      touch-action: manipulation;
      /* Prevent zoom on input focus */
      -webkit-text-size-adjust: 100%;
    }
    
    /* MOBILE APP LAYOUT */
    .mobile-app {
      height: 100vh;
      height: calc(var(--vh, 1vh) * 100); /* Use custom property for iOS */
      display: flex;
      flex-direction: column;
      position: relative;
    }
    
    /* TOP HEADER */
    .mobile-header {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      min-height: 60px;
    }
    
    .logo {
      font-size: 24px;
      font-weight: 700;
      color: white;
    }
    
    /* MAIN CONTENT AREA */
    .mobile-content {
      flex: 1;
      overflow: hidden;
      position: relative;
      /* Add padding for fixed navigation */
      padding-bottom: 80px;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      height: 100vh;
      /* iOS viewport units fix */
      height: 100dvh;
      overflow: hidden;
      touch-action: manipulation;
      /* Prevent zoom on input focus */
      -webkit-text-size-adjust: 100%;
    }
    
    .mobile-view {
      display: none;
      height: 100%;
      padding: 12px;
      padding-bottom: 100px;
      overflow-y: auto;
    }
    
    .mobile-view.active {
      display: block !important;
    }
    
    /* BOTTOM NAVIGATION */
    .mobile-nav {
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(20px);
      display: flex;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      padding: 8px 0;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      min-height: 70px;
      /* iOS safe area handling */
      padding-bottom: max(8px, env(safe-area-inset-bottom));
      /* Smooth transitions */
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      /* Ensure proper stacking */
      box-shadow: 0 -2px 20px rgba(0, 0, 0, 0.2);
    }
    
    .mobile-nav.keyboard-open {
      transform: translateY(100%);
      opacity: 0;
      pointer-events: none;
    }
    
    .nav-btn {
      flex: 1;
      background: none;
      border: none;
      color: #666;
      padding: 12px 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      min-height: 60px;
    }
    
    .nav-btn.active {
      color: #fff;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      margin: 4px;
    }
    
    .nav-btn:active {
      transform: scale(0.95);
      background: rgba(255, 255, 255, 0.1);
    }
    
    .nav-icon {
      width: 24px;
      height: 24px;
      margin-bottom: 2px;
    }
    
    /* CHAT VIEW */
    #chat-mobile {
      display: flex;
      flex-direction: column;
      height: 100%;
      /* Ensure proper spacing with fixed nav */
      padding-bottom: 10px;
    }
    
    .chat-messages-mobile {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      margin-bottom: 16px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      /* Fixed height calculation for better mobile experience */
      min-height: 300px;
      max-height: calc(100vh - 220px); /* Increased to account for input area */
    }
    
    .chat-input-mobile {
      display: flex;
      gap: 12px;
      align-items: center;
      /* Ensure input area is always visible */
      position: sticky;
      bottom: 0;
      background: inherit;
      padding-top: 8px;
    }
    
    .mobile-input {
      flex: 1;
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 25px;
      padding: 12px 16px;
      color: white;
      font-size: 16px;
      outline: none;
      resize: none;
      min-height: 44px;
      max-height: 120px;
      overflow-y: auto;
      font-family: inherit;
      line-height: 1.4;
    }
    
    .mobile-input::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }
    
    .mobile-input:focus {
      border-color: rgba(255, 255, 255, 0.4);
      background: rgba(255, 255, 255, 0.2);
    }
    
    .send-btn {
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      width: 48px;
      height: 48px;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    
    .send-btn:active {
      transform: scale(0.95);
      background: rgba(255, 255, 255, 0.4);
    }
    
    /* EMAIL DECODER VIEW */
    .email-section {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 16px;
    }
    
    .section-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #fff;
    }
    
    .mobile-textarea {
      width: 100%;
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      padding: 16px;
      color: white;
      font-size: 16px;
      min-height: 120px;
      resize: vertical;
      outline: none;
      font-family: inherit;
    }
    
    .mobile-textarea::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }
    
    .mobile-textarea:focus {
      border-color: rgba(255, 255, 255, 0.4);
      background: rgba(255, 255, 255, 0.15);
    }
    
    .decode-btn-mobile {
      width: 100%;
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      padding: 16px;
      color: white;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 16px;
      transition: all 0.2s;
    }
    
    .decode-btn-mobile:active {
      transform: scale(0.98);
      background: rgba(255, 255, 255, 0.4);
    }
    
    /* CALENDAR VIEW */
    .calendar-section {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 16px;
      margin-bottom: 12px;
      max-height: calc(100vh - 100px);
      overflow-y: auto;
    }
    
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .month-nav {
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      padding: 8px 12px;
      color: white;
      cursor: pointer;
    }
    
    .events-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-height: calc(100vh - 380px);
      overflow-y: auto;
      padding-right: 4px;
    }
    
    .today-events {
      margin-bottom: 16px;
    }
    
    .event-item {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 16px;
      border-left: 4px solid rgba(255, 255, 255, 0.6);
    }
    
    .event-item:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-1px);
    }
    
    .event-title {
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .event-time {
      color: #888;
      font-size: 14px;
    }
    
    /* LOADING STATE */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 40px;
      color: #666;
    }
    
    /* SUCCESS/ERROR STATES */
    .success {
      background: rgba(34, 197, 94, 0.3);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(34, 197, 94, 0.5);
      border-radius: 8px;
      padding: 12px 16px;
      margin: 12px 0;
      font-size: 14px;
    }
    
    .error {
      background: rgba(220, 38, 38, 0.3);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(220, 38, 38, 0.5);
      border-radius: 8px;
      padding: 12px 16px;
      margin: 12px 0;
      font-size: 14px;
    }
    
    /* TASK CARD STYLES - Brand Purple Theme */
    .task-card {
      background: rgba(139, 92, 246, 0.3);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(139, 92, 246, 0.5);
      border-radius: 12px;
      padding: 16px;
      margin: 12px 0;
      color: white;
    }
    
    .task-priority {
      background: rgba(251, 191, 36, 0.4);
      color: #fbbf24;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      display: inline-block;
      margin-right: 8px;
    }
    
    .task-due {
      background: rgba(59, 130, 246, 0.4);
      color: #60a5fa;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      display: inline-block;
    }
    
    .task-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    
    .task-btn {
      background: rgba(139, 92, 246, 0.4);
      border: 1px solid rgba(139, 92, 246, 0.6);
      border-radius: 6px;
      padding: 6px 12px;
      color: white;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .task-btn:hover {
      background: rgba(139, 92, 246, 0.6);
      transform: translateY(-1px);
    }
    
    .task-btn.complete {
      background: rgba(34, 197, 94, 0.4);
      border-color: rgba(34, 197, 94, 0.6);
    }
    
    .task-btn.edit {
      background: rgba(251, 191, 36, 0.4);
      border-color: rgba(251, 191, 36, 0.6);
    }
    
    /* MOBILE EMAIL INTELLIGENCE STYLES */
    .intel-tab {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 25px;
      padding: 8px 12px;
      color: rgba(255, 255, 255, 0.7);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .intel-tab.active {
      background: rgba(255, 255, 255, 0.3);
      color: white;
      border-color: rgba(255, 255, 255, 0.4);
      transform: scale(1.05);
    }
    
    .translated-emails-mobile {
      max-height: 400px;
      overflow-y: auto;
    }

    /* ANTI-INBOX CATEGORY STYLES */
    .category-tab {
      padding: 8px 16px;
      border: none;
      border-radius: 20px;
      background: rgba(255,255,255,0.1);
      color: rgba(255,255,255,0.7);
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 12px;
      font-weight: 500;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .category-tab.active {
      background: rgba(139, 92, 246, 0.4);
      color: white;
      border: 1px solid rgba(139, 92, 246, 0.6);
    }

    .email-card {
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      border: 1px solid rgba(255,255,255,0.2);
    }

    .email-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .email-category {
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .category-family { background: rgba(34, 197, 94, 0.3); color: #22c55e; }
    .category-commerce { background: rgba(251, 146, 60, 0.3); color: #fb923c; }
    .category-priority { background: rgba(239, 68, 68, 0.3); color: #ef4444; }
    .category-work { background: rgba(59, 130, 246, 0.3); color: #3b82f6; }
    .category-noise { background: rgba(107, 114, 128, 0.3); color: #6b7280; }

    .manipulation-score {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
    }

    .score-low { color: #22c55e; }
    .score-medium { color: #fb923c; }
    .score-high { color: #ef4444; }

    .loyalty-badge {
      padding: 2px 6px;
      border-radius: 6px;
      font-size: 9px;
      font-weight: 600;
    }

    .loyalty-earned { background: rgba(34, 197, 94, 0.3); color: #22c55e; }
    .loyalty-manipulative { background: rgba(239, 68, 68, 0.3); color: #ef4444; }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Enhanced Animations for Future-Proof UI */
    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); }
      20%, 40%, 60%, 80% { transform: translateX(4px); }
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
    
    @keyframes glow {
      0%, 100% { box-shadow: 0 0 20px rgba(139, 92, 246, 0.3); }
      50% { box-shadow: 0 0 30px rgba(139, 92, 246, 0.6); }
    }
    
    /* Smart Input Focus Effects */
    .smart-input {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(10px);
    }
    
    .smart-input:focus {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(139, 92, 246, 0.3);
      border-color: rgba(139, 92, 246, 0.6);
    }
    
    /* AI Suggestion Hover Effects */
    .ai-suggestion {
      animation: slideUp 0.5s ease-out;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .ai-suggestion:hover {
      transform: translateX(4px);
      background: rgba(139, 92, 246, 0.15) !important;
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2);
    }
    
    /* Responsive Animations */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>
<body>
  <div class="mobile-app">
    <!-- Header -->
    <div class="mobile-header">
      <div class="logo">HomeOps</div>
      <div style="font-size: 14px; color: rgba(255,255,255,0.8);">Works!</div>
    </div>
    
    <!-- Content Area -->
    <div class="mobile-content">
      <!-- Chat View -->
      <div id="chat-mobile" class="mobile-view active">
        <div class="chat-messages-mobile">
          <!-- Welcome Message -->
          <div style="padding: 20px; background: rgba(255,255,255,0.1); margin: 8px 0; border-radius: 18px 18px 18px 4px; max-width: 85%; border: 1px solid rgba(255,255,255,0.1);">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #8B5CF6, #06B6D4); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <i data-lucide="home" style="width: 20px; height: 20px; color: white;"></i>
              </div>
              <div>
                <div style="font-weight: 600; margin-bottom: 2px;">HomeOps Agent</div>
                <div style="font-size: 12px; color: rgba(255,255,255,0.7);">Your Life Intelligence Assistant</div>
              </div>
            </div>
            
            <div style="line-height: 1.5; margin-bottom: 12px;">
              Hey! I'm your HomeOps Agent with multiple intelligence systems:
            </div>
            
            <div style="display: grid; gap: 8px; margin-bottom: 16px;">
              <div style="background: rgba(139, 92, 246, 0.2); padding: 8px 12px; border-radius: 8px; font-size: 13px;">
                <strong><i data-lucide="brain" style="width: 16px; height: 16px;"></i> Life Intelligence:</strong> "How can I be less anxious?" - Evidence-based frameworks
              </div>
              <div style="background: rgba(34, 197, 94, 0.2); padding: 8px 12px; border-radius: 8px; font-size: 13px;">
                <strong><i data-lucide="plane" style="width: 16px; height: 16px;"></i> Travel Intelligence:</strong> "Flight from NYC to London next week" - Real flight search
              </div>
              <div style="background: rgba(251, 191, 36, 0.2); padding: 8px 12px; border-radius: 8px; font-size: 13px;">
                <strong><i data-lucide="shopping-bag" style="width: 16px; height: 16px;"></i> Commerce Intelligence:</strong> "Find a laptop under $1000" - Product research
              </div>
              <div style="background: rgba(59, 130, 246, 0.2); padding: 8px 12px; border-radius: 8px; font-size: 13px;">
                <strong><i data-lucide="mail" style="width: 16px; height: 16px;"></i> Email Intelligence:</strong> Decode inbox manipulation & categorize signal vs noise
              </div>
            </div>
            
            <div style="font-size: 14px; color: rgba(255,255,255,0.9);">
              Try any question or explore the sections below!
            </div>
          </div>
        </div>
        
        <!-- Chat Input -->
        <div class="chat-input-mobile">
          <textarea class="mobile-input" placeholder="Type your message..." id="chatInput" rows="1"></textarea>
          <button class="send-btn" onclick="sendMessage()">
            <i data-lucide="send" style="width: 20px; height: 20px;"></i>
          </button>
        </div>
      </div>
      
      <!-- Email Decoder View -->
      <div id="email-mobile" class="mobile-view">
        <!-- Quick Intelligence Status -->
        <div style="background: rgba(139, 92, 246, 0.2); border: 1px solid rgba(139, 92, 246, 0.4); border-radius: 12px; padding: 8px; margin-bottom: 12px;">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
            <div style="font-weight: 600; display: flex; align-items: center; gap: 8px;">
              <i data-lucide="brain-circuit" style="width: 18px; height: 18px; color: #fbbf24;"></i>
              <span>Intelligence Status</span>
            </div>
            <div id="gmail-connection-indicator" style="width: 10px; height: 10px; background: rgba(255, 193, 7, 0.8); border-radius: 50%;"></div>
          </div>
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
            <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 8px; text-align: center;">
              <div style="font-size: 11px; text-transform: uppercase; margin-bottom: 2px;">Tasks</div>
              <div style="font-weight: 600; font-size: 18px;" id="extracted-tasks-count">0</div>
            </div>
            <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 8px; text-align: center;">
              <div style="font-size: 11px; text-transform: uppercase; margin-bottom: 2px;">Events</div>
              <div style="font-weight: 600; font-size: 18px;" id="extracted-events-count">0</div>
            </div>
            <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 8px; text-align: center;">
              <div style="font-size: 11px; text-transform: uppercase; margin-bottom: 2px;">Urgent</div>
              <div style="font-weight: 600; font-size: 18px;" id="urgent-items-count">0</div>
            </div>
            <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 8px; text-align: center;">
              <div style="font-size: 11px; text-transform: uppercase; margin-bottom: 2px;">Hidden</div>
              <div style="font-weight: 600; font-size: 18px;" id="hidden-labor-count">0</div>
            </div>
          </div>
        </div>

        <!-- Connection & Actions -->
        <div style="margin-bottom: 16px;">
          <button id="connect-gmail-mobile" onclick="connectGmailMobile()" 
                  style="background: rgba(34, 197, 94, 0.3); border: 1px solid rgba(34, 197, 94, 0.6); border-radius: 12px; padding: 14px; color: white; font-size: 16px; cursor: pointer; width: 100%; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 8px;">
            <i data-lucide="mail" style="width: 24px; height: 24px;"></i>
            <span>Connect Gmail & Start Intelligence</span>
          </button>
          
          <div style="display: flex; gap: 8px;">
            <button id="process-emails-mobile" onclick="loadDecoderCards()" 
                    style="background: rgba(139, 92, 246, 0.3); border: 1px solid rgba(139, 92, 246, 0.6); border-radius: 8px; padding: 12px; color: white; font-size: 14px; cursor: pointer; flex: 1; display: flex; align-items: center; justify-content: center; gap: 6px;">
              <i data-lucide="brain-circuit" style="width: 18px; height: 18px;"></i>
              <span>Load Email Cards</span>
            </button>
            
            <button onclick="testSampleParentEmail()" 
                    style="background: rgba(251, 191, 36, 0.3); border: 1px solid rgba(251, 191, 36, 0.6); border-radius: 8px; padding: 12px; color: white; font-size: 14px; cursor: pointer; flex: 1; display: flex; align-items: center; justify-content: center; gap: 6px;">
              <i data-lucide="microscope" style="width: 18px; height: 18px;"></i>
              <span>Demo: School Email</span>
            </button>
          </div>
        </div>
          
        <!-- Intelligent Email Categories -->
        <div style="margin-bottom: 16px;">
          <div style="font-weight: 600; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
            <i data-lucide="bar-chart-4" style="width: 20px; height: 20px; color: #a78bfa;"></i>
            <span>Email Categories</span>
          </div>
            
            <!-- Category Tabs -->
            <div class="category-tabs" style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; overflow-x: auto;">
              <button class="category-tab active" data-category="all" onclick="showEmailCategory('all', this)">
                <i data-lucide="inbox" style="width: 16px; height: 16px;"></i> All
              </button>
              <button class="category-tab" data-category="family" onclick="showEmailCategory('family', this)">
                <i data-lucide="users" style="width: 16px; height: 16px;"></i> Family
              </button>
              <button class="category-tab" data-category="commerce" onclick="showEmailCategory('commerce', this)">
                <i data-lucide="shopping-cart" style="width: 16px; height: 16px;"></i> Commerce
              </button>
              <button class="category-tab" data-category="priority" onclick="showEmailCategory('priority', this)">
                <i data-lucide="alert-circle" style="width: 16px; height: 16px;"></i> Priority
              </button>
              <button class="category-tab" data-category="work" onclick="showEmailCategory('work', this)">
                <i data-lucide="briefcase" style="width: 16px; height: 16px;"></i> Work
              </button>
              <button class="category-tab" data-category="noise" onclick="showEmailCategory('noise', this)">
                <i data-lucide="volume-x" style="width: 16px; height: 16px;"></i> Noise
              </button>
            </div>
          </div>

          <!-- Intelligent Email Results -->
          <div id="intelligent-email-results">
            <!-- Placeholder for no emails yet -->
            <div id="no-emails-placeholder" style="text-align: center; padding: 40px 20px; background: rgba(255,255,255,0.05); border-radius: 12px; border: 1px dashed rgba(255,255,255,0.2);">
              <div style="margin-bottom: 16px; display: flex; justify-content: center;">
                <i data-lucide="mail" style="width: 48px; height: 48px; color: #a78bfa;"></i>
              </div>
              <div style="font-weight: 600; margin-bottom: 8px; color: white;">No Emails Decoded Yet</div>
              <div style="font-size: 14px; color: rgba(255,255,255,0.7); line-height: 1.4;">
                Connect Gmail or try the demo to see how I decode and categorize your emails with intelligent analysis.
              </div>
            </div>
          </div>
          
          <!-- Processing Status -->
          <div id="processing-status" style="display: none; text-align: center; padding: 20px;">
            <div class="typing-dots" style="margin-bottom: 10px;">
              <span>.</span><span>.</span><span>.</span>
            </div>
            <div id="processing-message">Your AI Chief of Staff is decoding...</div>
          </div>
        </div>
      </div>
      
      <!-- Calendar View -->
      <div id="calendar-mobile" class="mobile-view">
        <div class="calendar-section">
          <!-- Enhanced Calendar Header with AI Status -->
          <div class="calendar-header">
            <button class="month-nav" onclick="changeMonth(-1)">â€¹</button>
            <div class="section-title" id="current-month" style="display: flex; align-items: center; gap: 8px;">
              <i data-lucide="calendar" style="width: 20px; height: 20px; color: #a78bfa;"></i>
              July 2025
            </div>
            <button class="month-nav" onclick="changeMonth(1)">â€º</button>
          </div>
          
          <!-- AI Intelligence Status -->
          <div style="background: rgba(139, 92, 246, 0.2); border: 1px solid rgba(139, 92, 246, 0.4); border-radius: 12px; padding: 6px; margin-bottom: 10px;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
              <div style="display: flex; align-items: center; gap: 6px;">
                <i data-lucide="brain-circuit" style="width: 14px; height: 14px; color: #a78bfa;"></i>
                <span style="font-weight: 600; font-size: 13px;">Smart Calendar</span>
              </div>
              <div style="display: flex; gap: 3px;">
                <i data-lucide="brain" style="width: 12px; height: 12px; color: #22c55e;" title="Life Intelligence"></i>
                <i data-lucide="shopping-bag" style="width: 12px; height: 12px; color: #fbbf24;" title="Commerce"></i>
                <i data-lucide="plane" style="width: 12px; height: 12px; color: #3b82f6;" title="Travel"></i>
                <i data-lucide="clipboard-list" style="width: 12px; height: 12px; color: #a855f7;" title="Logistics"></i>
              </div>
            </div>
          </div>
          
          <!-- Enhanced Calendar Grid -->
          <div class="calendar-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: rgba(255,255,255,0.1); border-radius: 12px; overflow: hidden; margin-bottom: 12px;">
            <!-- Day headers -->
            <div class="day-header" style="background: rgba(255,255,255,0.1); padding: 4px 4px; text-align: center; font-size: 11px; font-weight: 600;">S</div>
            <div class="day-header" style="background: rgba(255,255,255,0.1); padding: 4px 4px; text-align: center; font-size: 11px; font-weight: 600;">M</div>
            <div class="day-header" style="background: rgba(255,255,255,0.1); padding: 4px 4px; text-align: center; font-size: 11px; font-weight: 600;">T</div>
            <div class="day-header" style="background: rgba(255,255,255,0.1); padding: 4px 4px; text-align: center; font-size: 11px; font-weight: 600;">W</div>
            <div class="day-header" style="background: rgba(255,255,255,0.1); padding: 4px 4px; text-align: center; font-size: 11px; font-weight: 600;">T</div>
            <div class="day-header" style="background: rgba(255,255,255,0.1); padding: 4px 4px; text-align: center; font-size: 11px; font-weight: 600;">F</div>
            <div class="day-header" style="background: rgba(255,255,255,0.1); padding: 4px 4px; text-align: center; font-size: 11px; font-weight: 600;">S</div>
            
            <!-- Calendar days (will be populated by JS) -->
            <div id="calendar-days" style="display: contents;">
              <!-- JS will populate calendar days here -->
            </div>
          </div>
          
          <!-- Smart Today's Events -->
          <div class="today-events">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
              <div style="font-weight: 600; color: #fff; display: flex; align-items: center; gap: 8px;">
                <i data-lucide="calendar-days"></i>
                Today's Smart Events
              </div>
              <button onclick="syncWithGmailCalendar()" style="background: rgba(34, 197, 94, 0.3); border: 1px solid rgba(34, 197, 94, 0.6); border-radius: 6px; padding: 4px 8px; color: white; font-size: 11px; cursor: pointer;">
                <i data-lucide="refresh-cw"></i>
                Sync Gmail
              </button>
            </div>
            <div class="events-list" id="today-events-list">
              <!-- Smart events will be populated by renderSmartCalendar() -->
            </div>
            
            <!-- Quick Event Templates -->
            <div style="margin-top: 8px;">
              <div style="font-weight: 600; margin-bottom: 4px; color: #fff; font-size: 13px;">Quick Add Templates</div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                <button onclick="event.stopPropagation(); addQuickEvent('meeting')" style="background: rgba(59, 130, 246, 0.3); border: 1px solid rgba(59, 130, 246, 0.6); border-radius: 8px; padding: 6px; color: white; font-size: 11px; cursor: pointer;">
                  <i data-lucide="users"></i><br>
                  Meeting
                </button>
                <button onclick="event.stopPropagation(); addQuickEvent('appointment')" style="background: rgba(168, 85, 247, 0.3); border: 1px solid rgba(168, 85, 247, 0.6); border-radius: 8px; padding: 6px; color: white; font-size: 11px; cursor: pointer;">
                  <i data-lucide="stethoscope"></i><br>
                  Appointment
                </button>
                <button onclick="event.stopPropagation(); addQuickEvent('travel')" style="background: rgba(34, 197, 94, 0.3); border: 1px solid rgba(34, 197, 94, 0.6); border-radius: 8px; padding: 6px; color: white; font-size: 11px; cursor: pointer;">
                  <i data-lucide="plane"></i><br>
                  Travel
                </button>
                <button onclick="event.stopPropagation(); addQuickEvent('personal')" style="background: rgba(251, 191, 36, 0.3); border: 1px solid rgba(251, 191, 36, 0.6); border-radius: 8px; padding: 6px; color: white; font-size: 11px; cursor: pointer;">
                  <i data-lucide="heart"></i><br>
                  Personal
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Bottom Navigation -->
    <div class="mobile-nav">
      <button class="nav-btn active" onclick="showView('chat-mobile', this, event)">
        <i data-lucide="message-circle" class="nav-icon"></i>
        Chat
      </button>
      <button class="nav-btn" onclick="showView('email-mobile', this, event)">
        <i data-lucide="mail" class="nav-icon"></i>
        Email
      </button>
      <button class="nav-btn" onclick="showView('calendar-mobile', this, event)">
        <i data-lucide="calendar" class="nav-icon"></i>
        Calendar
      </button>
    </div>
  </div>
  
  <script>
    // Mobile-First JavaScript - Define functions immediately
    window.showView = function(viewId, button, event) {
      console.log('Switching to view:', viewId);
      
      // Hide all views immediately
      document.querySelectorAll('.mobile-view').forEach(view => {
        view.classList.remove('active');
        view.style.display = 'none';
      });
      
      // Remove active from all nav buttons
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Show selected view immediately
      const targetView = document.getElementById(viewId);
      if (targetView) {
        targetView.style.display = 'block';
        targetView.classList.add('active');
        
        // Initialize view-specific content
        if (viewId === 'email-mobile') {
          initializeEmailView();
        } else if (viewId === 'calendar-mobile') {
          initializeCalendarView();
        }
      }
      
      if (button) {
        button.classList.add('active');
      }
      
      // Haptic feedback (only on user interaction)
      try {
        if (navigator.vibrate && event && event.isTrusted) {
          navigator.vibrate(10);
        }
      } catch (e) {
        // Silently handle vibration API restrictions
      }
    }
    
    // Create global alias for compatibility
    window.showView = window.showView || function() { console.error('showView not loaded yet'); };
    
    function initializeEmailView() {
      console.log('Initializing email view...');
      const emailContent = document.querySelector('#email-mobile .email-content');
      if (emailContent && !emailContent.innerHTML.trim()) {
        emailContent.innerHTML = `
          <div style="padding: 20px;">
            <h2 style="margin-bottom: 20px; color: white; display: flex; align-items: center; gap: 8px;">
              <i data-lucide="mail" style="width: 24px; height: 24px;"></i>
              Email Intelligence
            </h2>
            
            <div style="background: rgba(255,255,255,0.1); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
              <h3 style="margin-bottom: 12px;">ðŸš€ Quick Start</h3>
              <div style="display: grid; gap: 8px;">
                <button onclick="testSampleEmail()" 
                        style="background: rgba(139, 92, 246, 0.3); border: 1px solid rgba(139, 92, 246, 0.6); border-radius: 8px; padding: 12px; color: white; cursor: pointer; text-align: left;">
                  ðŸ§ª Test with Sample School Email
                </button>
                <button onclick="connectGmail()" 
                        style="background: rgba(34, 197, 94, 0.3); border: 1px solid rgba(34, 197, 94, 0.6); border-radius: 8px; padding: 12px; color: white; cursor: pointer; text-align: left;">
                  <i data-lucide="link" style="width: 16px; height: 16px;"></i>
                  Connect Gmail Account
                </button>
              </div>
            </div>
            
            <div style="background: rgba(255,255,255,0.1); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
              <h3 style="margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                <i data-lucide="bar-chart-3" style="width: 20px; height: 20px;"></i>
                What Email Intelligence Does
              </h3>
              <div style="font-size: 14px; line-height: 1.6;">
                â€¢ <strong>Signal vs Noise:</strong> Separates important emails from marketing fluff<br>
                â€¢ <strong>Manipulation Detection:</strong> Rates marketing tactics on 1-10 scale<br>
                â€¢ <strong>Smart Categorization:</strong> Family, School, Work, Commerce, Priority<br>
                â€¢ <strong>Action Extraction:</strong> Pulls out what you actually need to do<br>
                â€¢ <strong>Calendar Integration:</strong> Auto-detects events and dates
              </div>
            </div>
            
            <div style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 16px; border: 1px dashed rgba(255,255,255,0.2);">
              <h3 style="margin-bottom: 12px;">ðŸ¤– Try These Chat Commands</h3>
              <div style="font-size: 14px; color: rgba(255,255,255,0.8);">
                â€¢ "Email summary this week"<br>
                â€¢ "Show important family emails"<br>
                â€¢ "Any school deadlines?"<br>
                â€¢ "Email intelligence commerce stuff"
              </div>
            </div>
          </div>
        `;
      }
    }
    
    function initializeCalendarView() {
      console.log('Initializing calendar view...');
      if (!document.getElementById('calendar-days').innerHTML) {
        renderCalendar();
      }
      // Load smart calendar events
      renderSmartCalendar();
    }
    
    async function sendMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      
      if (!message) return;
      
      const messagesDiv = document.querySelector('.chat-messages-mobile');
      
      // Add user message with better styling
      messagesDiv.innerHTML += `
        <div style="padding: 12px 20px; background: rgba(255,255,255,0.3); backdrop-filter: blur(10px); margin: 8px 0; border-radius: 18px 18px 4px 18px; max-width: 85%; margin-left: auto; border: 1px solid rgba(255,255,255,0.2);">
          ${message}
        </div>
      `;
      
      input.value = '';
      
      // Reset textarea height
      input.style.height = 'auto';
      input.style.height = '44px';
      
      // Smart action detection BEFORE sending to AI
      const actionDetected = detectAndExecuteActions(message);
      
      if (actionDetected) {
        // Action was detected and executed, no need for AI response
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        return;
      }
      
      // Only proceed with AI if no action was detected
      if (!actionDetected) {
        // Add typing indicator
        messagesDiv.innerHTML += `
          <div id="typing-indicator" style="padding: 12px 20px; background: rgba(255,255,255,0.1); margin: 8px 0; border-radius: 18px 18px 18px 4px; max-width: 85%; border: 1px solid rgba(255,255,255,0.1);">
            <div style="display: flex; align-items: center; gap: 8px; color: rgba(255,255,255,0.7);">
              <div class="typing-dots">
                <span>.</span><span>.</span><span>.</span>
              </div>
              HomeOps is thinking...
            </div>
          </div>
        `;
        
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        
        // Call real AI backend
        try {
          console.log('ðŸ“¡ Sending to AI backend:', message);
          
          // Get or create user ID for this session
          let userId = localStorage.getItem('homeops_user_id');
          if (!userId) {
            userId = 'mobile_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('homeops_user_id', userId);
          }
          
          const response = await fetch('/api/chat', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              message: message,
              userId: userId
            })
          });
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const data = await response.json();
          
          // Replace typing indicator with AI response
          const typingEl = document.getElementById('typing-indicator');
          if (typingEl && data.reply) {
            
            // Check if this is a Life Intelligence structured response
            if (data.reply.startsWith('LIFE_INTELLIGENCE_CARD:')) {
              try {
                const cardData = JSON.parse(data.reply.replace('LIFE_INTELLIGENCE_CARD:', ''));
                
                typingEl.innerHTML = `
                  <div style="background: rgba(139, 92, 246, 0.3); border: 1px solid rgba(139, 92, 246, 0.5); border-radius: 12px; padding: 16px; margin: 8px 0;">
                    <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                      <i data-lucide="brain-circuit"></i>
                      <span>Life Intelligence</span>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                      <div style="font-weight: 600; margin-bottom: 6px;">ðŸ“Š Analysis</div>
                      <div style="font-size: 14px; line-height: 1.4;">${cardData.analysis}</div>
                      <div style="font-size: 12px; color: rgba(255,255,255,0.7); margin-top: 4px; font-style: italic;">Framework: ${cardData.framework}</div>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                      <div style="font-weight: 600; margin-bottom: 8px;">ðŸŽ¯ Evidence-Based Insights</div>
                      ${cardData.insights.map(insight => `
                        <div style="margin: 6px 0; font-size: 13px; line-height: 1.4; padding-left: 12px; border-left: 2px solid rgba(139, 92, 246, 0.6);">
                          ${insight}
                        </div>
                      `).join('')}
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                      <div style="font-weight: 600; margin-bottom: 8px;">âœ… Action Protocol</div>
                      ${cardData.action_steps.map((step, index) => `
                        <div style="margin: 8px 0; font-size: 13px; line-height: 1.4; display: flex; gap: 8px;">
                          <span style="background: rgba(139, 92, 246, 0.6); color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; flex-shrink: 0;">${index + 1}</span>
                          <span>${step}</span>
                        </div>
                      `).join('')}
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                      <div style="font-weight: 600; margin-bottom: 6px;">ðŸ”„ Reframe</div>
                      <div style="font-size: 14px; line-height: 1.4; font-style: italic;">${cardData.reframe}</div>
                    </div>
                    
                    <div style="background: rgba(34, 197, 94, 0.2); border: 1px solid rgba(34, 197, 94, 0.4); padding: 12px; border-radius: 8px; margin-top: 12px;">
                      <div style="font-weight: 600; margin-bottom: 6px;">ðŸš€ Next Step (Today)</div>
                      <div style="font-size: 14px; line-height: 1.4;">${cardData.next_step}</div>
                    </div>
                    
                    <div style="font-size: 11px; color: rgba(255,255,255,0.6); text-align: center; margin-top: 12px;">
                      ðŸ§  Evidence-based guidance from clinical psychology & relationship science
                    </div>
                  </div>
                `;
                
                // Initialize Lucide icons
                setTimeout(() => {
                  if (typeof lucide !== 'undefined') {

                  }
                }, 100);
                
              } catch (error) {
                console.error('Error parsing Life Intelligence card:', error);
                // Fallback to regular display
                typingEl.innerHTML = `
                  <div style="color: white; line-height: 1.4;">
                    ${data.reply.replace('LIFE_INTELLIGENCE_CARD:', '')}
                  </div>
                `;
              }
            } else if (data.reply.startsWith('EMAIL_INTELLIGENCE_SUMMARY:')) {
              // Handle Email Intelligence Summary
              try {
                const emailData = JSON.parse(data.reply.replace('EMAIL_INTELLIGENCE_SUMMARY:', ''));
                
                typingEl.innerHTML = `
                  <div style="background: rgba(34, 197, 94, 0.3); border: 1px solid rgba(34, 197, 94, 0.5); border-radius: 12px; padding: 16px; margin: 8px 0;">
                    <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                      <i data-lucide="mail-search"></i>
                      <span>ðŸ“§ Email Intelligence Summary</span>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                      <div style="font-weight: 600; margin-bottom: 8px;">ðŸ“Š Weekly Overview</div>
                      <div style="font-size: 14px; line-height: 1.4; margin-bottom: 8px;">${emailData.summary}</div>
                      <div style="font-size: 12px; color: rgba(255,255,255,0.7);">
                        ðŸ“§ ${emailData.emailCount} emails analyzed from the last week
                      </div>
                    </div>
                    
                    ${emailData.categories ? `
                      <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                        <div style="font-weight: 600; margin-bottom: 8px;">ðŸ“‚ Category Breakdown</div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                          ${Object.entries(emailData.categories).filter(([category, emails]) => emails.length > 0).map(([category, emails]) => `
                            <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 6px; text-align: center;">
                              <div style="font-size: 11px; text-transform: uppercase; margin-bottom: 2px;">${category}</div>
                              <div style="font-weight: 600; font-size: 18px;">${emails.length}</div>
                            </div>
                          `).join('')}
                        </div>
                      </div>
                    ` : ''}
                    
                    <button onclick="showView('email-mobile', document.querySelector('.nav-btn[onclick*=\"email-mobile\"]'), null)" 
                            style="background: rgba(34, 197, 94, 0.4); border: 1px solid rgba(34, 197, 94, 0.6); border-radius: 8px; padding: 8px 16px; color: white; font-size: 14px; cursor: pointer; width: 100%;">
                      <i data-lucide="mail-open"></i>
                      View Full Email Intelligence
                    </button>
                  </div>
                `;
                
                // Initialize Lucide icons
                setTimeout(() => {
                  if (typeof lucide !== 'undefined') {

                  }
                }, 100);
                
              } catch (error) {
                console.error('Error parsing Email Intelligence summary:', error);
                // Fallback to regular display
                typingEl.innerHTML = `
                  <div style="color: white; line-height: 1.4;">
                    ðŸ“§ ${data.reply.replace('EMAIL_INTELLIGENCE_SUMMARY:', '')}
                  </div>
                `;
              }
            } else {
              // Regular response display
              typingEl.innerHTML = `
                <div style="color: white; line-height: 1.4;">
                  ${data.reply}
                </div>
              `;
            }
            
            typingEl.style.background = 'rgba(139, 92, 246, 0.2)';
            typingEl.style.borderColor = 'rgba(139, 92, 246, 0.4)';
            typingEl.removeAttribute('id');
          }
          
        } catch (error) {
          console.error('AI Backend Error:', error);
          const typingEl = document.getElementById('typing-indicator');
          if (typingEl) {
            typingEl.innerHTML = `
              <div style="color: rgba(255,200,100,0.9);">
                I'm having trouble connecting to my AI brain right now. Can you try rephrasing your request? I can still help with calendar events, flights, and other specific tasks.
              </div>
            `;
            typingEl.style.background = 'rgba(255,200,100,0.2)';
            typingEl.style.borderColor = 'rgba(255,200,100,0.4)';
            typingEl.removeAttribute('id');
          }
        }
        
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        
        // Initialize Lucide icons after adding new content
        if (typeof lucide !== 'undefined') {

        }
      }
      
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // Helper function to add messages
    function addMessage(type, content) {
      const messagesDiv = document.querySelector('.chat-messages-mobile');
      messagesDiv.innerHTML += content;
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function addSystemMessage(messagesDiv, message) {
      messagesDiv.innerHTML += `
        <div style="padding: 8px 16px; background: rgba(34, 197, 94, 0.2); margin: 8px 0; border-radius: 12px; border: 1px solid rgba(34, 197, 94, 0.4); font-size: 14px;">
          ${message}
        </div>
      `;
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
     // Smart action detection and execution
    function detectAndExecuteActions(message) {
      const msg = message.toLowerCase();
      const messagesDiv = document.querySelector('.chat-messages-mobile');
      
      console.log('ðŸ” Detecting actions for message:', message);
      console.log('ðŸ” Lowercase message:', msg);
      
      // Enhanced detection patterns - FLIGHT SEARCH FIRST PRIORITY
      
      // Flight search detection - HIGHEST PRIORITY CHECK
      if (msg.includes('flight') || msg.includes('flights') || msg.includes('fly') || msg.includes('plane') || 
          msg.includes('cheapest flight') || msg.includes('book flight') ||
          (msg.includes('from') && msg.includes('to') && (msg.includes('nyc') || msg.includes('new york') || msg.includes('boston') || msg.includes('dc') || msg.includes('washington') || msg.includes('london') || msg.includes('lax') || msg.includes('seattle'))) ||
          (msg.includes('to ') && (msg.includes('london') || msg.includes('paris') || msg.includes('seattle') || msg.includes('boston') || msg.includes('lax')))) {
        console.log('âœˆï¸ Flight search detected');
        executeFlightSearch(message, messagesDiv);
        return true;
      }
      
      // Life Intelligence detection - HIGH PRIORITY (emotional/relationship/life guidance)
      if (msg.includes('anxious') || msg.includes('stressed') || msg.includes('overwhelmed') || msg.includes('confused') ||
          msg.includes('relationship') || msg.includes('partner') || msg.includes('marriage') || msg.includes('family') ||
          msg.includes('parenting') || msg.includes('kids') || msg.includes('teenagers') || msg.includes('discipline') ||
          msg.includes('communication') || msg.includes('conflict') || msg.includes('argument') || msg.includes('fight') ||
          msg.includes('boundaries') || msg.includes('energy') || msg.includes('burnout') || msg.includes('balance') ||
          msg.includes('depression') || msg.includes('sad') || msg.includes('angry') || msg.includes('frustrated') ||
          msg.includes('advice') || msg.includes('help me') || msg.includes('what should i') || msg.includes('how do i') ||
          msg.includes('feeling') || msg.includes('emotions') || msg.includes('mental health') || msg.includes('therapy') ||
          msg.includes('mindfulness') || msg.includes('meditation') || msg.includes('self-care') || msg.includes('guilt') ||
          msg.includes('shame') || msg.includes('confidence') || msg.includes('self-esteem') || msg.includes('motivation') ||
          msg.includes('purpose') || msg.includes('meaning') || msg.includes('direction') || msg.includes('goals') ||
          (msg.includes('how can i') && (msg.includes('better') || msg.includes('improve') || msg.includes('change'))) ||
          (msg.includes('my') && (msg.includes('spouse') || msg.includes('husband') || msg.includes('wife') || msg.includes('child'))) ||
          (msg.includes('feel like') || msg.includes('i think') || msg.includes('i believe') || msg.includes('i worry'))) {
        console.log('ðŸ§  Life intelligence detected');
        executeLifeIntelligence(message, messagesDiv);
        return true;
      }
      
      // Commerce/Shopping search detection - SECOND PRIORITY
      if (msg.includes('gift') || msg.includes('present') || msg.includes('birthday') || 
          msg.includes('need to buy') || msg.includes('looking for') || msg.includes('shopping for') ||
          msg.includes('laptop') || msg.includes('computer') || msg.includes('phone') ||
          (msg.includes('need') && (msg.includes('for my') || msg.includes('daughter') || msg.includes('son') || msg.includes('kid')))) {
        console.log('ðŸ›’ Shopping search detected');
        executeShoppingSearch(message, messagesDiv);
        return true;
      }
      
      // Calendar injection commands - Enhanced detection (PRIORITY - includes dentist appointment)
      const calendarTriggers = [
        msg.includes('meeting') && (msg.includes('tomorrow') || msg.includes('at ') || msg.includes('pm') || msg.includes('am')),
        msg.includes('appointment') && (msg.includes('tomorrow') || msg.includes('at ') || msg.includes('pm') || msg.includes('am')),
        msg.includes('i have a') && (msg.includes('meeting') || msg.includes('appointment') || msg.includes('call')),
        msg.includes('schedule') && (msg.includes('meeting') || msg.includes('appointment') || msg.includes('call')),
        msg.includes('add') && msg.includes('calendar'),
        msg.includes('dentist') || msg.includes('doctor'),
        msg.includes('golf') && (msg.includes('tomorrow') || msg.includes('at ')),
        (msg.includes('tomorrow') || msg.includes('today') || msg.includes('monday') || msg.includes('tuesday') || msg.includes('wednesday') || msg.includes('thursday') || msg.includes('friday') || msg.includes('saturday') || msg.includes('sunday')) && (msg.includes('at ') && (msg.includes('pm') || msg.includes('am')))
      ];
      
      if (calendarTriggers.some(trigger => trigger)) {
        console.log('ðŸ“… Calendar event detected');
        executeCalendarInjection(message, messagesDiv);
        return true;
      }
      
      // Calendar viewing/checking commands
      if ((msg.includes('do i have') || msg.includes('what do i have') || msg.includes('whats on my') || msg.includes('check my') || msg.includes('show my')) && 
          (msg.includes('calendar') || msg.includes('schedule') || msg.includes('going on'))) {
        console.log('ðŸ“… Calendar view detected');
        executeCalendarView(messagesDiv);
        return true;
      }
      
      // Task management commands - Enhanced detection
      if (msg.includes('remind me') || msg.includes('set reminder') || msg.includes('dont forget') || msg.includes("don't forget") ||
          (msg.includes('add') && (msg.includes('task') || msg.includes('todo') || msg.includes('reminder')))) {
        console.log('âœ… Task management detected');
        executeTaskManagement(message, messagesDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        return true;
      }
      
      console.log('âŒ No actions detected');
      return false;
      
      // Travel planning commands
      if ((msg.includes('travel') || msg.includes('trip') || msg.includes('vacation') || msg.includes('flight')) && 
          (msg.includes('plan') || msg.includes('book') || msg.includes('need') || msg.includes('help'))) {
        executeTravelPlanning(message, messagesDiv);
        return true;
      }
      
      // Shopping/purchase commands
      if ((msg.includes('buy') || msg.includes('purchase') || msg.includes('order') || msg.includes('need to get')) ||
          (msg.includes('shopping') && (msg.includes('list') || msg.includes('help')))) {
        executeShoppingAssistant(message, messagesDiv);
        return true;
      }
      
      // Contact/communication commands
      if ((msg.includes('call') || msg.includes('text') || msg.includes('email') || msg.includes('contact')) && 
          (msg.includes('remind me') || msg.includes('need to') || msg.includes('should'))) {
        executeCommunicationReminder(message, messagesDiv);
        return true;
      }
      
      // Health/wellness tracking
      if (msg.includes('water') || msg.includes('exercise') || msg.includes('workout') || 
          (msg.includes('track') && (msg.includes('health') || msg.includes('wellness')))) {
        executeWellnessTracking(message, messagesDiv);
        return true;
      }
      
      // Financial tracking
      if ((msg.includes('budget') || msg.includes('expense') || msg.includes('spending')) ||
          (msg.includes('how much') && (msg.includes('spent') || msg.includes('cost')))) {
        executeFinancialTracking(message, messagesDiv);
        return true;
      }
      
      // Agentic browsing and web intelligence
      if (msg.includes('find') || msg.includes('search') || msg.includes('best') || msg.includes('compare') || 
          msg.includes('flights') || msg.includes('restaurants') || msg.includes('hotels') || msg.includes('venues') ||
          msg.includes('where to') || msg.includes('recommendations for') || msg.includes('book') ||
          (msg.includes('united') && msg.includes('flight')) || (msg.includes('dinner') && msg.includes('reservation'))) {
        executeAgenticSearch(message, messagesDiv);
        return true;
      }
      
      // Agentic browsing and search intelligence
      if ((msg.includes('find') || msg.includes('search') || msg.includes('best') || msg.includes('compare') || msg.includes('look up')) &&
          (msg.includes('flight') || msg.includes('restaurant') || msg.includes('hotel') || msg.includes('venue') || 
           msg.includes('shop') || msg.includes('price') || msg.includes('review') || msg.includes('near me') ||
           msg.includes('to ') || msg.includes('in ') || msg.includes('for '))) {
        executeAgenticSearch(message, messagesDiv);
        return true;
      }
      
      // Deal intelligence (RCS-style)
      if (msg.includes('deals') || msg.includes('offers') || msg.includes('sales') || msg.includes('discounts') || 
          msg.includes('good deal') || msg.includes('bargain') || msg.includes('cheap') || 
          (msg.includes('find') && (msg.includes('deal') || msg.includes('offer')))) {
        executeDealIntelligence(message, messagesDiv);
        return true;
      }
      
      // Email summary functionality
      if (msg.includes('email summary') || msg.includes('recent emails') || msg.includes('inbox summary') || 
          msg.includes('summarize emails') || msg.includes('latest emails') || msg.includes('what emails') ||
          (msg.includes('summary') && msg.includes('email'))) {
        executeEmailSummary(message, messagesDiv);
        return true;
      }
      
      // Email surfacing commands
      if (msg.includes('show') && (msg.includes('email') || msg.includes('urgent') || msg.includes('important'))) {
        executeEmailSurfacing(messagesDiv);
        return true;
      }
      
      // Deal detection commands
      if (msg.includes('deal') || msg.includes('sale') || (msg.includes('find') && msg.includes('buy'))) {
        executeDealIntelligence(message, messagesDiv);
        return true;
      }
      
      // Week planning commands
      if (msg.includes('plan') && (msg.includes('week') || msg.includes('today') || msg.includes('tomorrow'))) {
        executeWeekPlanning(messagesDiv);
        return true;
      }
      
      // Navigation shortcuts
      if (msg.includes('switch to') || msg.includes('go to')) {
        if (msg.includes('email')) {
          const emailBtn = document.querySelector('.nav-btn[onclick*="email-mobile"]');
          showView('email-mobile', emailBtn, null);
          addSystemMessage(messagesDiv, "ðŸ“§ Switched to Email view");
          return true;
        }
        if (msg.includes('calendar')) {
          const calendarBtn = document.querySelector('.nav-btn[onclick*="calendar-mobile"]');
          showView('calendar-mobile', calendarBtn, null);
          addSystemMessage(messagesDiv, "ðŸ“… Switched to Calendar view");
          return true;
        }
      }
      
      return false; // No action detected, proceed with AI
    }

    // Commerce Intelligence with D2C Focus
    async function executeShoppingSearch(message, messagesDiv) {
      console.log('ðŸ›ï¸ executeShoppingSearch called with:', message);
      
      const commerceCard = `
        <div style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; padding: 20px; margin: 15px 0;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
            <i data-lucide="shopping-cart" style="width: 24px; height: 24px; color: white;"></i>
            <strong style="font-size: 18px; color: white;">Commerce Intelligence</strong>
          </div>
          <div style="color: rgba(255,255,255,0.9); margin-bottom: 15px;">Finding the best places to buy: <strong>${message}</strong></div>
          <div id="commerce-results"></div>
        </div>
      `;
      
      messagesDiv.innerHTML += commerceCard;
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      
      try {
        const response = await fetch('http://localhost:3000/api/commerce-search-enhanced', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query: message })
        });
        
        const data = await response.json();
        console.log('ðŸ“Š Commerce API response:', data);
        let results = '';
        
        if (data.success && data.productCategories) {
          data.productCategories.forEach((category, index) => {
            results += `
              <div style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 18px; margin: 15px 0;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                  <i data-lucide="gift" style="width: 18px; height: 18px; color: #22c55e;"></i>
                  <h3 style="color: white; margin: 0; font-size: 16px; font-weight: 600;">${category.category}</h3>
                </div>
                <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 16px;">
                  <i data-lucide="sparkles" style="width: 14px; height: 14px; color: rgba(255,255,255,0.7);"></i>
                  <p style="color: rgba(255,255,255,0.8); margin: 0; font-size: 14px;">${category.description}</p>
                </div>
                
                <div style="display: grid; gap: 16px;">
                  ${category.sources ? category.sources.map(source => {
                    // D2C Brand Card - Premium Treatment
                    if (source.brandType === 'd2c') {
                      return `
                        <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(99, 102, 241, 0.2)); border: 2px solid rgba(139, 92, 246, 0.6); border-radius: 12px; padding: 18px; position: relative;">
                          <!-- D2C Brand Pick Badge -->
                          <div style="position: absolute; top: -1px; right: -1px; background: linear-gradient(135deg, #8b5cf6, #06b6d4); color: white; padding: 4px 12px; border-radius: 0 12px 0 8px; font-size: 10px; font-weight: 700; display: flex; align-items: center; gap: 4px;">
                            <i data-lucide="award" style="width: 12px; height: 12px;"></i>
                            D2C BRAND PICK
                          </div>
                          
                          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; margin-top: 8px;">
                            <div style="flex: 1;">
                              <div style="font-weight: 700; color: white; font-size: 18px; margin-bottom: 6px;">${source.retailer}</div>
                              <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 8px;">
                                <i data-lucide="check-circle" style="width: 14px; height: 14px; color: #22c55e;"></i>
                                <span style="color: #22c55e; font-size: 13px; font-weight: 600;">Trusted Brand</span>
                              </div>
                              <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 12px;">
                                <i data-lucide="dollar-sign" style="width: 16px; height: 16px; color: white;"></i>
                                <span style="font-size: 20px; color: white; font-weight: 700;">${source.price}</span>
                                <span style="font-size: 12px; color: rgba(255,255,255,0.7); margin-left: 8px;">
                                  <i data-lucide="truck" style="width: 12px; height: 12px; margin-right: 4px;"></i>
                                  ${source.shipping}
                                </span>
                              </div>
                            </div>
                          </div>
                          
                          <!-- Value Proposition -->
                          <div style="background: rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                            <div style="font-size: 13px; color: rgba(255,255,255,0.95); line-height: 1.5; margin-bottom: 8px;">${source.advantage}</div>
                            <div style="font-size: 12px; color: #a7f3d0; font-weight: 600;">This brand has earned customer loyalty through authentic marketing & quality products</div>
                          </div>
                          
                          <button onclick="window.open('${source.link || source.retailer.toLowerCase().replace(/\\s+/g, '') + '.com'}', '_blank')" 
                                  style="width: 100%; background: linear-gradient(135deg, #8b5cf6, #06b6d4); color: white; border: none; padding: 14px; border-radius: 8px; font-size: 15px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s;">
                            <i data-lucide="external-link" style="width: 16px; height: 16px;"></i>
                            Shop Direct from ${source.retailer}
                          </button>
                        </div>
                      `;
                    }
                    // Amazon Alternative Card - Utility Treatment
                    else if (source.retailer === 'Amazon') {
                      return `
                        <div style="background: rgba(75, 85, 99, 0.2); border: 1px solid rgba(107, 114, 128, 0.4); border-radius: 8px; padding: 14px; margin-top: 8px;">
                          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div style="flex: 1;">
                              <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                                <i data-lucide="package" style="width: 14px; height: 14px; color: #9ca3af;"></i>
                                <span style="font-weight: 500; color: #d1d5db; font-size: 14px;">${source.retailer} Alternative</span>
                              </div>
                              <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px;">
                                <i data-lucide="box" style="width: 14px; height: 14px; color: #9ca3af;"></i>
                                <span style="font-size: 13px; color: #9ca3af;">${source.productName || 'Similar Product'}</span>
                              </div>
                              <div style="display: flex; align-items: center; gap: 6px;">
                                <i data-lucide="dollar-sign" style="width: 14px; height: 14px; color: #d1d5db;"></i>
                                <span style="font-size: 16px; color: #d1d5db; font-weight: 600;">${source.price}</span>
                                <span style="font-size: 11px; color: rgba(255,255,255,0.6); margin-left: 6px;">
                                  <i data-lucide="truck" style="width: 10px; height: 10px; margin-right: 2px;"></i>
                                  ${source.shipping}
                                </span>
                              </div>
                            </div>
                          </div>
                          
                          <div style="font-size: 11px; color: #9ca3af; margin-bottom: 12px; padding: 8px; background: rgba(107, 114, 128, 0.1); border-radius: 4px;">
                            If you prefer fast shipping & returns (but less brand connection)
                          </div>
                          
                          <button onclick="window.open('${source.link || 'https://amazon.com/s?k=' + encodeURIComponent(source.searchTerm || category.category)}', '_blank')" 
                                  style="width: 100%; background: rgba(107, 114, 128, 0.4); color: #d1d5db; border: 1px solid rgba(107, 114, 128, 0.6); padding: 10px; border-radius: 6px; font-size: 13px; font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;">
                            <i data-lucide="shopping-cart" style="width: 14px; height: 14px;"></i>
                            Find on Amazon
                          </button>
                        </div>
                      `;
                    }
                    // Other retailers - Standard treatment
                    else {
                      return `
                        <div style="background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; padding: 14px;">
                          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div style="flex: 1;">
                              <div style="font-weight: 600; color: white; font-size: 15px; margin-bottom: 4px;">${source.retailer}</div>
                              <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px;">
                                <i data-lucide="dollar-sign" style="width: 14px; height: 14px; color: white;"></i>
                                <span style="font-size: 16px; color: white; font-weight: 600;">${source.price}</span>
                                <span style="font-size: 11px; color: rgba(255,255,255,0.6); margin-left: 6px;">${source.shipping}</span>
                              </div>
                              <div style="font-size: 12px; color: rgba(255,255,255,0.8);">${source.advantage}</div>
                            </div>
                          </div>
                          
                          <button onclick="window.open('${source.link || source.retailer.toLowerCase().replace(/\\s+/g, '') + '.com'}', '_blank')" 
                                  style="width: 100%; background: rgba(255, 255, 255, 0.15); color: white; border: 1px solid rgba(255, 255, 255, 0.3); padding: 10px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;">
                            <i data-lucide="external-link" style="width: 14px; height: 14px;"></i>
                            Shop at ${source.retailer}
                          </button>
                        </div>
                      `;
                    }
                  }).join('') : ''}
                  
                  <!-- Trade-off Message -->
                  ${category.sources && category.sources.some(s => s.brandType === 'd2c') && category.sources.some(s => s.retailer === 'Amazon') ? `
                    <div style="background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 6px; padding: 10px; margin-top: 8px;">
                      <div style="font-size: 11px; color: #fbbf24; font-weight: 600; text-align: center;">
                        Trade-off: Fast delivery vs supporting innovative D2C brands
                      </div>
                    </div>
                  ` : ''}
                </div>
              </div>
            `;
          });
          
          // Simple insights
          if (data.insights && data.insights.length > 0) {
            results += `
              <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 8px; padding: 12px; margin: 12px 0;">
                <div style="color: #22c55e; font-weight: 600; margin-bottom: 8px;">Shopping Tips</div>
                ${data.insights.slice(0, 2).map(insight => `
                  <div style="font-size: 13px; color: rgba(255,255,255,0.9); margin: 4px 0;">â€¢ ${insight}</div>
                `).join('')}
              </div>
            `;
          }
        } else {
          // Fallback for gift recommendations
          results = `
            <div style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 18px; margin: 15px 0; border: 1px solid rgba(255,255,255,0.1);">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                <i data-lucide="gift" style="width: 18px; height: 18px; color: #22c55e;"></i>
                <span style="color: #ffffff; font-size: 16px; font-weight: 600;">Perfect Gifts for 5-Year-Old</span>
              </div>
              <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 8px;">
                <i data-lucide="dollar-sign" style="width: 14px; height: 14px; color: #22c55e;"></i>
                <span style="color: #22c55e; font-weight: 600;">$15-50 range</span>
              </div>
              <div style="font-size: 14px; color: rgba(255,255,255,0.8); margin: 8px 0; line-height: 1.4;">Age-appropriate gifts that promote creativity and learning</div>
              
              <div style="background: rgba(139, 92, 246, 0.2); border: 1px solid rgba(139, 92, 246, 0.4); border-radius: 8px; padding: 12px; margin: 10px 0;">
                <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                  <i data-lucide="sparkles" style="width: 14px; height: 14px; color: #c4b5fd;"></i>
                  <span style="font-weight: 600; color: #c4b5fd;">Creative & Educational</span>
                </div>
                <div style="font-size: 14px; color: white; font-weight: 500;">LEGO Classic Bricks â€¢ Crayola Art Set â€¢ Age-appropriate Puzzles</div>
                <div style="font-size: 12px; color: rgba(255,255,255,0.8); margin-top: 2px;">Available at Target, Amazon, Walmart</div>
              </div>
              
              <div style="background: rgba(34, 197, 94, 0.2); border: 1px solid rgba(34, 197, 94, 0.4); border-radius: 8px; padding: 12px; margin: 10px 0;">
                <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                  <i data-lucide="activity" style="width: 14px; height: 14px; color: #86efac;"></i>
                  <span style="font-weight: 600; color: #86efac;">Active & Outdoor</span>
                </div>
                <div style="font-size: 14px; color: white; font-weight: 500;">Soccer Ball â€¢ Jump Rope â€¢ Sidewalk Chalk Set</div>
                <div style="font-size: 12px; color: rgba(255,255,255,0.8); margin-top: 2px;">Perfect for outdoor birthday party activities</div>
              </div>
            </div>
          `;
          console.log('âŒ Using fallback gift recommendations');
        }
        
        console.log('ðŸ“‹ Final results HTML length:', results.length);
        console.log('ðŸ“‹ Final results preview:', results.substring(0, 200));
        document.getElementById('commerce-results').innerHTML = results;
        if (typeof lucide !== 'undefined') lucide.createIcons();
      } catch (error) {
        console.error('Commerce API error:', error);
        document.getElementById('commerce-results').innerHTML = `
          <div style="color: #f87171; padding: 10px;">
            Unable to get recommendations right now. Please try again.
          </div>
        `;
      }
    }

    // Life Intelligence - Evidence-Based Framework System
    async function executeLifeIntelligence(message, messagesDiv) {
      console.log('ðŸ§  executeLifeIntelligence called with:', message);
      
      const lifeCard = `
        <div style="background: rgba(139, 92, 246, 0.2); border: 1px solid rgba(139, 92, 246, 0.4); border-radius: 15px; padding: 20px; margin: 15px 0;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
            <span style="font-size: 24px;">ðŸ§ </span>
            <strong style="font-size: 16px;">Life Intelligence</strong>
            <span style="background: rgba(139, 92, 246, 0.6); color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; margin-left: auto;">FRAMEWORK-DRIVEN</span>
          </div>
          <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
            <div style="font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
              <i data-lucide="brain-circuit" style="width: 20px; height: 20px;"></i>
              HomeOps is thinking...
            </div>
            <div style="font-size: 14px; color: rgba(255,255,255,0.9); font-style: italic;">"${message}"</div>
            <div style="font-size: 12px; color: rgba(255,255,255,0.7); margin-top: 8px;">Processing with evidence-based frameworks...</div>
          </div>
          <div id="life-intelligence-results" style="margin-top: 15px;"></div>
        </div>
      `;
      
      messagesDiv.innerHTML += lifeCard;
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      
      try {
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            message: message,
            requestType: 'life_intelligence'
          })
        });
        
        const data = await response.json();
        console.log('ðŸ§  Life Intelligence API response:', data);
        
        if (data.success && data.response && data.response.startsWith('LIFE_INTELLIGENCE_CARD:')) {
          try {
            const intelligence = JSON.parse(data.response.replace('LIFE_INTELLIGENCE_CARD:', ''));
            console.log('ðŸ§  Parsed Life Intelligence:', intelligence);
          
          const resultsHTML = `
            <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px; margin-bottom: 16px;">
              <div style="font-weight: 600; margin-bottom: 12px; font-size: 16px; color: white;">
                ${intelligence.analysis || intelligence.initial_response}
              </div>
              <div style="font-size: 13px; color: rgba(255,255,255,0.7); font-style: italic;">
                Framework: ${intelligence.framework || 'Evidence-based approach'}
              </div>
            </div>
            
            <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px; margin-bottom: 16px;">
              <div style="font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; color: white;">
                ðŸ’¡
                <span>Key Insights</span>
              </div>
              <div style="display: flex; flex-direction: column; gap: 12px;">
                ${intelligence.insights ? intelligence.insights.map(insight => `
                  <div style="font-size: 14px; line-height: 1.5; color: rgba(255,255,255,0.95); padding-left: 12px; border-left: 3px solid rgba(139, 92, 246, 0.6);">
                    ${insight}
                  </div>
                `).join('') : '<div style="font-size: 14px; color: rgba(255,255,255,0.8);">Generating personalized insights...</div>'}
              </div>
            </div>
            
            <div style="background: rgba(34, 197, 94, 0.15); border: 1px solid rgba(34, 197, 94, 0.3); padding: 20px; border-radius: 12px; margin-bottom: 16px;">
              <div style="font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; color: white;">
                âœ…
                <span>Action Steps</span>
              </div>
              <div style="display: flex; flex-direction: column; gap: 12px;">
                ${intelligence.action_steps ? intelligence.action_steps.map((step, index) => `
                  <div style="display: flex; align-items: flex-start; gap: 12px;">
                    <div style="background: rgba(34, 197, 94, 0.6); color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; flex-shrink: 0;">${index + 1}</div>
                    <div style="font-size: 14px; line-height: 1.5; color: rgba(255,255,255,0.95);">${step}</div>
                  </div>
                `).join('') : '<div style="font-size: 14px; color: rgba(255,255,255,0.8);">Creating personalized action plan...</div>'}
              </div>
            </div>
            
            <div style="background: rgba(251, 191, 36, 0.15); border: 1px solid rgba(251, 191, 36, 0.3); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
              <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; color: white;">
                âš¡
                <span>Next Step Today</span>
              </div>
              <div style="font-size: 15px; line-height: 1.4; color: rgba(255,255,255,0.95); font-weight: 500;">
                ${intelligence.next_step || 'Take one small action today to build momentum.'}
              </div>
            </div>
            
            <div style="margin-top: 20px; display: flex; gap: 8px; flex-wrap: wrap;">
              <button onclick="expandLifeIntelligence('${encodeURIComponent(message)}')" 
                      style="background: rgba(139, 92, 246, 0.4); border: 1px solid rgba(139, 92, 246, 0.6); border-radius: 8px; padding: 10px 16px; color: white; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 6px; font-weight: 500;">
                ðŸ”
                Deeper Analysis
              </button>
              <button onclick="createLifePlan('${encodeURIComponent(message)}')" 
                      style="background: rgba(34, 197, 94, 0.4); border: 1px solid rgba(34, 197, 94, 0.6); border-radius: 8px; padding: 10px 16px; color: white; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 6px; font-weight: 500;">
                ðŸ“…
                Create Plan
              </button>
              <button onclick="shareWithPartner('${encodeURIComponent(message)}')" 
                      style="background: rgba(251, 191, 36, 0.4); border: 1px solid rgba(251, 191, 36, 0.6); border-radius: 8px; padding: 10px 16px; color: white; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 6px; font-weight: 500;">
                ðŸ’¬
                Share Insights
              </button>
            </div>
          `;
          
          document.getElementById('life-intelligence-results').innerHTML = resultsHTML;
          if (typeof lucide !== 'undefined') lucide.createIcons();
          
          // Re-initialize Lucide icons for new content
          setTimeout(() => {
            if (typeof lucide !== 'undefined') {

            }
          }, 100);
          
          } catch (parseError) {
            console.error('Error parsing Life Intelligence JSON:', parseError);
            document.getElementById('life-intelligence-results').innerHTML = `
              <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                <div style="font-weight: 600; margin-bottom: 8px;">ðŸŽ¯ Analysis Complete</div>
                <div style="font-size: 14px; line-height: 1.5; color: rgba(255,255,255,0.95);">
                  I hear you. Let me work through this with you using evidence-based approaches.
                </div>
              </div>
            `;
          }
        } else {
          // Fallback content if API doesn't return structured data
          document.getElementById('life-intelligence-results').innerHTML = `
            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
              <div style="font-weight: 600; margin-bottom: 8px;">ðŸŽ¯ Analysis Complete</div>
              <div style="font-size: 14px; line-height: 1.5; color: rgba(255,255,255,0.95);">
                ${data.message || 'I hear you. Let me help you work through this with evidence-based approaches.'}
              </div>
            </div>
            <div style="margin-top: 12px; padding: 12px; background: rgba(139, 92, 246, 0.2); border-radius: 8px;">
              <div style="font-size: 13px; color: rgba(255,255,255,0.8);">
                ðŸ’¡ This would normally include personalized frameworks, insights, and action steps. Let me know what specific area you'd like help with!
              </div>
            </div>
          `;
        }
        
      } catch (error) {
        console.error('Life Intelligence API error:', error);
        document.getElementById('life-intelligence-results').innerHTML = `
          <div style="color: #f87171; padding: 15px; background: rgba(239, 68, 68, 0.2); border-radius: 10px;">
            I'm here to help! While I work on connecting to the full intelligence system, I can offer guidance. What specific situation are you facing?
          </div>
        `;
      }
    }

    // Flight Intelligence with Amadeus API
    async function executeFlightSearch(message, messagesDiv) {
      console.log('âœˆï¸ executeFlightSearch called with:', message);
      
      const flightCard = `
        <div style="background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.4); border-radius: 15px; padding: 20px; margin: 15px 0;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
            <span style="font-size: 24px;">âœˆï¸</span>
            <strong style="font-size: 16px;">Travel Intelligence</strong>
          </div>
          <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
            <div style="font-weight: 600; margin-bottom: 8px;">ðŸŒ Searching flights...</div>
            <div style="font-size: 14px; color: rgba(255,255,255,0.9);">${message}</div>
          </div>
          <div id="flight-results" style="margin-top: 15px;"></div>
        </div>
      `;
      
      messagesDiv.innerHTML += flightCard;
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      
      try {
        const response = await fetch('/api/flight-search', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query: message })
        });
        
        const data = await response.json();
        let results = '';
        
        if (data.success && data.flights) {
          results = `<div style="color: white;"><h4>Flight Options:</h4>`;
          data.flights.forEach(flight => {
            results += `
              <div style="background: rgba(255,255,255,0.05); border-radius: 10px; padding: 15px; margin: 10px 0;">
                <strong style="color: #60a5fa;">${flight.airline || 'Flight Option'}</strong>
                <div style="color: #22c55e; font-weight: 600;">$${flight.price || 'Price varies'}</div>
                <div style="font-size: 14px; color: rgba(255,255,255,0.8); margin: 8px 0;">${flight.details || flight.route || 'Flight details'}</div>
              </div>
            `;
          });
          results += '</div>';
        } else {
          results = `<div style="color: white; padding: 10px;">I can help you with travel planning! Try asking about specific routes like "flights from NYC to London" or "best time to visit Europe".</div>`;
        }
        
        document.getElementById('flight-results').innerHTML = results;
        if (typeof lucide !== 'undefined') lucide.createIcons();
      } catch (error) {
        console.error('Flight API error:', error);
        document.getElementById('flight-results').innerHTML = `
          <div style="color: #f87171; padding: 10px;">
            Let me help you with travel planning! I can provide general advice and suggestions.
          </div>
        `;
      }
    }

    // Travel Planning Intelligence
    async function executeTravelPlanning(message, messagesDiv) {
      console.log('ðŸ—ºï¸ executeTravelPlanning called with:', message);
      
      const travelCard = `
        <div style="background: rgba(34, 197, 94, 0.2); border: 1px solid rgba(34, 197, 94, 0.4); border-radius: 15px; padding: 20px; margin: 15px 0;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
            <span style="font-size: 24px;">ðŸ—ºï¸</span>
            <strong style="font-size: 16px;">Travel Planning Intelligence</strong>
          </div>
          <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
            <div style="font-weight: 600; margin-bottom: 8px;">âœˆï¸ Planning your trip...</div>
            <div style="font-size: 14px; color: rgba(255,255,255,0.9);">${message}</div>
          </div>
          <div id="travel-results" style="margin-top: 15px;"></div>
        </div>
      `;
      
      messagesDiv.innerHTML += travelCard;
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      
      // For now, redirect to flight search if it's a flight query, otherwise provide general travel advice
      if (message.toLowerCase().includes('flight')) {
        executeFlightSearch(message, messagesDiv);
      } else {
        document.getElementById('travel-results').innerHTML = `
          <div style="color: white; padding: 10px;">
            I can help you plan your trip! Try asking about:
            <ul style="margin: 10px 0; padding-left: 20px;">
              <li>Flight searches: "flights from NYC to London"</li>
              <li>Best times to visit destinations</li>
              <li>Travel tips and recommendations</li>
            </ul>
          </div>
        `;
      }
    }

    // Calendar View Function
    // Intelligent Schedule/Calendar System with Life Intelligence Integration
    function executeCalendarView(messagesDiv) {
      console.log('ðŸ“… executeCalendarView called');
      
      // Simulate intelligent schedule analysis with contextual recommendations
      const scheduleEvents = [
        {
          title: "Emma's Birthday Party",
          time: "Saturday 2pm",
          type: "birthday_party",
          context: "6-year-old boy invited",
          intelligence: {
            gift_suggestions: true,
            prep_items: ["wrapped gift", "card", "party outfit"],
            commerce_trigger: "6 year old boy birthday gift"
          }
        },
        {
          title: "Lacrosse Game",
          time: "Sunday 10am", 
          type: "sports",
          context: "Championship game",
          intelligence: {
            prep_reminders: ["Pack water bottle", "Sunscreen", "Team snacks"],
            carpooling: true,
            motivational_talk: "Things to tell your kid before the big game"
          }
        },
        {
          title: "Date Night",
          time: "Friday 7pm",
          context: "Anniversary dinner",
          intelligence: {
            gift_suggestions: true,
            prep_items: ["babysitter confirmation", "restaurant reservation"],
            commerce_trigger: "anniversary gift for spouse"
          }
        }
      ];
      
      let calendarHTML = `
        <div style="background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.4); border-radius: 15px; padding: 20px; margin: 15px 0;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
            <span style="font-size: 24px;">ðŸ“…</span>
            <strong style="font-size: 16px;">Intelligent Schedule Overview</strong>
          </div>
          <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
            <div style="font-weight: 600; margin-bottom: 12px;">ðŸŽ¯ This Weekend with AI Insights</div>
      `;
      
      scheduleEvents.forEach((event, index) => {
        calendarHTML += `
          <div style="background: rgba(255,255,255,0.05); border-radius: 10px; padding: 15px; margin: 10px 0; border-left: 4px solid #60a5fa;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
              <div>
                <strong style="color: white; font-size: 15px;">${event.title}</strong>
                <div style="color: #60a5fa; font-size: 13px; margin-top: 2px;">${event.time}</div>
                <div style="color: rgba(255,255,255,0.7); font-size: 12px; margin-top: 4px;">${event.context}</div>
              </div>
            </div>
            
            <!-- AI-Powered Action Cards -->
            <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px;">
              ${event.intelligence.gift_suggestions ? `
                <button onclick="executeEventCommerceIntelligence('${event.title}', document.querySelector('.chat-messages-mobile'))" 
                        style="background: rgba(168, 85, 247, 0.3); border: 1px solid rgba(168, 85, 247, 0.5); border-radius: 6px; padding: 6px 10px; color: white; font-size: 11px; cursor: pointer;">
                  ðŸŽ Gift Ideas
                </button>
              ` : ''}
              
              ${event.intelligence.prep_reminders ? `
                <button onclick="executeEventLifeIntelligence('${event.title}', document.querySelector('.chat-messages-mobile'))" 
                        style="background: rgba(34, 197, 94, 0.3); border: 1px solid rgba(34, 197, 94, 0.5); border-radius: 6px; padding: 6px 10px; color: white; font-size: 11px; cursor: pointer;">
                  ðŸ“‹ Prep List
                </button>
              ` : ''}
              
              ${event.intelligence.carpooling ? `
                <button onclick="executeEventTravelIntelligence('${event.title}', document.querySelector('.chat-messages-mobile'))" 
                        style="background: rgba(59, 130, 246, 0.3); border: 1px solid rgba(59, 130, 246, 0.5); border-radius: 6px; padding: 6px 10px; color: white; font-size: 11px; cursor: pointer;">
                  ðŸš— Carpool
                </button>
              ` : ''}
              
              ${event.intelligence.motivational_talk ? `
                <button onclick="executeEventLifeIntelligence('${event.title}', document.querySelector('.chat-messages-mobile'))" 
                        style="background: rgba(249, 115, 22, 0.3); border: 1px solid rgba(249, 115, 22, 0.5); border-radius: 6px; padding: 6px 10px; color: white; font-size: 11px; cursor: pointer;">
                  ðŸ’ª Coach Tips
                </button>
              ` : ''}
            </div>
          </div>
        `;
      });
      
      calendarHTML += `
          </div>
          <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px; font-size: 12px; color: rgba(255,255,255,0.7);">
            ðŸ’¡ <strong>AI-Powered Schedule Intelligence:</strong> Click any action button for personalized recommendations based on your family's patterns and preferences.
          </div>
        </div>
      `;
      
      messagesDiv.innerHTML += calendarHTML;
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
    
    function executeTaskManagement(message, messagesDiv) {
      const msg = message.toLowerCase();
      
      // Task creation patterns
      if (msg.includes('remind me') || msg.includes('add task') || msg.includes('todo') || 
          msg.includes('need to') || msg.includes('don\'t forget') || msg.includes('schedule')) {
        
        let taskTitle = 'New Task';
        let priority = 'Medium';
        let dueDate = 'Today';
        
        // Extract task details
        if (msg.includes('urgent') || msg.includes('asap') || msg.includes('immediately')) {
          priority = 'High';
        } else if (msg.includes('later') || msg.includes('sometime') || msg.includes('eventually')) {
          priority = 'Low';
        }
        
        // Extract due date
        if (msg.includes('tomorrow')) dueDate = 'Tomorrow';
        else if (msg.includes('next week')) dueDate = 'Next Week';
        else if (msg.includes('monday')) dueDate = 'Monday';
        else if (msg.includes('friday')) dueDate = 'Friday';
        
        // Extract task title (basic extraction)
        const reminderMatch = msg.match(/remind me (?:to )?(.+?)(?:\s+(?:tomorrow|today|next week|monday|tuesday|wednesday|thursday|friday|saturday|sunday))?$/);
        const taskMatch = msg.match(/(?:add task|todo|need to|don't forget)\s+(.+?)(?:\s+(?:tomorrow|today|next week|monday|tuesday|wednesday|thursday|friday|saturday|sunday))?$/);
        
        if (reminderMatch) taskTitle = reminderMatch[1].trim();
        else if (taskMatch) taskTitle = taskMatch[1].trim();
        
        const taskCard = `
          <div style="padding: 12px 20px; background: rgba(139, 92, 246, 0.3); backdrop-filter: blur(10px); margin: 8px 0; border-radius: 4px 18px 18px 18px; max-width: 95%; border: 1px solid rgba(139, 92, 246, 0.5);">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
              <i data-lucide="check-square"></i>
              <span style="font-weight: 600; color: white;">Task Created</span>
            </div>
            
            <div style="margin-bottom: 12px;">
              <div style="font-weight: 600; font-size: 16px; margin-bottom: 8px; color: white;">${taskTitle}</div>
              <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <span style="background: rgba(251, 191, 36, 0.4); color: #fbbf24; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px;">
                  <i data-lucide="zap"></i>
                  ${priority} Priority
                </span>
                <span style="background: rgba(59, 130, 246, 0.4); color: #60a5fa; padding: 4px 8px; border-radius:  6px; font-size: 11px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px;">
                  <i data-lucide="zap"></i>
                  Due: ${dueDate}
                </span>
              </div>
            </div>
            
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
              <button onclick="markTaskComplete(this)" style="background: rgba(34, 197, 94, 0.4); border: 1px solid rgba(34, 197, 94, 0.6); border-radius: 6px; padding: 6px 12px; color: white; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                <i data-lucide="zap"></i>
                Complete
              </button>
              <button onclick="editTask(this)" style="background: rgba(251, 191, 36, 0.4); border: 1px solid rgba(251, 191, 36, 0.6); border-radius: 6px; padding: 6px 12px; color: white; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                <i data-lucide="zap"></i>
                Edit
              </button>
              <button onclick="snoozeTask(this)" style="background: rgba(139, 92, 246, 0.4); border: 1px solid rgba(139, 92, 246, 0.6); border-radius: 6px; padding: 6px 12px; color: white; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                <i data-lucide="zap"></i>
                Snooze
              </button>
            </div>
          </div>
        `;
        
        // Initialize Lucide icons for the new card
        setTimeout(() => {
          if (typeof lucide !== 'undefined') {

          }
        }, 100);
        
        return true;
      }
      
      // Task listing
      if (msg.includes('show tasks') || msg.includes('list tasks') || msg.includes('my tasks') || 
          msg.includes('what do i need to do') || msg.includes('todo list')) {
        
        const tasksCard = `
          <div class="action-card tasks-list-card">
            <div class="card-header">
              <i data-lucide="zap"></i>
              <span>Your Tasks</span>
            </div>
            <div class="card-content">
              <div class="task-item">
                <div class="task-checkbox">
                  <i data-lucide="zap"></i>
                </div>
                <div class="task-info">
                  <span class="task-title">Review Q4 budget proposal</span>
                  <span class="task-meta">Due: Today â€¢ High Priority</span>
                </div>
              </div>
              <div class="task-item">
                <div class="task-checkbox">
                  <i data-lucide="zap"></i>
                </div>
                <div class="task-info">
                  <span class="task-title">Schedule dentist appointment</span>
                  <span class="task-meta">Due: This Week â€¢ Medium Priority</span>
                </div>
              </div>
              <div class="task-item">
                <div class="task-checkbox">
                  <i data-lucide="zap"></i>
                </div>
                <div class="task-info">
                  <span class="task-title">Plan weekend family activities</span>
                  <span class="task-meta">Due: Friday â€¢ Low Priority</span>
                </div>
              </div>
            </div>
            <div class="card-actions">
              <button onclick="addNewTask()" class="action-btn primary">
                <i data-lucide="zap"></i>
                Add Task
              </button>
              <button onclick="filterTasks()" class="action-btn secondary">
                <i data-lucide="zap"></i>
                Filter
              </button>
            </div>
          </div>
        `;
        
        addMessage('assistant', tasksCard);
        
        // Initialize Lucide icons
        setTimeout(() => {
          if (typeof lucide !== 'undefined') {

          }
        }, 100);
        
        return true;
      }
      
      return false;
    }
    
    // Determine which intelligence engines to surface for calendar events
    function determineEventIntelligence(eventTitle, eventContext) {
      const context = `${eventTitle} ${eventContext}`.toLowerCase();
      const engines = [];
      
      // Life Intelligence for relationship/family events
      if (context.includes('family') || context.includes('date') || context.includes('relationship') || 
          context.includes('dinner') || context.includes('meeting') || context.includes('conflict')) {
        engines.push({
          type: 'life',
          icon: 'brain-circuit',
          label: 'Life Intelligence',
          description: 'Get psychology-based guidance for this event'
        });
      }
      
      // Commerce Intelligence for events that might need shopping
      if (context.includes('party') || context.includes('gift') || context.includes('birthday') || 
          context.includes('anniversary') || context.includes('celebration') || context.includes('buy')) {
        engines.push({
          type: 'commerce',
          icon: 'ðŸ›ï¸',
          label: 'Commerce Intelligence', 
          description: 'Find perfect products for this event'
        });
      }
      
      // Flight Intelligence for travel events
      if (context.includes('travel') || context.includes('trip') || context.includes('flight') || 
          context.includes('vacation') || context.includes('visit')) {
        engines.push({
          type: 'flight',
          icon: 'plane',
          label: 'Flight Intelligence',
          description: 'Plan travel for this event'
        });
      }
      
      // Default to Life Intelligence if no specific match
      if (engines.length === 0) {
        engines.push({
          type: 'life',
          icon: 'brain-circuit', 
          label: 'Life Intelligence',
          description: 'Get guidance for planning this event'
        });
      }
      
      return engines;
    }
    
    function executeCalendarInjection(message, messagesDiv) {
      const msg = message.toLowerCase();
      let eventDetails = {
        title: 'New Event',
        date: 'Today',
        time: '12:00 PM',
        duration: '1 hour'
      };
      
      // Extract event type with enhanced detection
      if (msg.includes('golf')) eventDetails.title = 'Golf';
      else if (msg.includes('meeting')) eventDetails.title = 'Meeting';
      else if (msg.includes('appointment')) eventDetails.title = 'Appointment';
      else if (msg.includes('call')) eventDetails.title = 'Call';
      else if (msg.includes('lunch')) eventDetails.title = 'Lunch';
      else if (msg.includes('dinner')) eventDetails.title = 'Dinner';
      else if (msg.includes('flight')) eventDetails.title = 'Flight';
      else if (msg.includes('conference')) eventDetails.title = 'Conference';
      else if (msg.includes('pickup')) eventDetails.title = 'Pickup';
      else if (msg.includes('dropoff')) eventDetails.title = 'Drop-off';
      else if (msg.includes('doctor')) eventDetails.title = 'Doctor Appointment';
      else if (msg.includes('dentist')) eventDetails.title = 'Dentist Appointment';
      else if (msg.includes('birthday')) eventDetails.title = 'Birthday Party';
      else if (msg.includes('party')) eventDetails.title = 'Party';
      else if (msg.includes('thanksgiving') || msg.includes('parents coming')) eventDetails.title = 'Family Visit';
      else if (msg.includes('travel') || msg.includes('trip')) eventDetails.title = 'Travel';
      
      // Extract day
      if (msg.includes('sunday')) eventDetails.date = 'Sunday';
      else if (msg.includes('monday')) eventDetails.date = 'Monday';
      else if (msg.includes('tuesday')) eventDetails.date = 'Tuesday';
      else if (msg.includes('wednesday')) eventDetails.date = 'Wednesday';
      else if (msg.includes('thursday')) eventDetails.date = 'Thursday';
      else if (msg.includes('friday')) eventDetails.date = 'Friday';
      else if (msg.includes('saturday')) eventDetails.date = 'Saturday';
      else if (msg.includes('tomorrow')) eventDetails.date = 'Tomorrow';
      else if (msg.includes('today')) eventDetails.date = 'Today';
      
      // Extract time with better patterns
      const timePatterns = [
        /(\d{1,2})\s*pm/i,
        /(\d{1,2})\s*am/i,
        /(\d{1,2}):(\d{2})\s*pm/i,
        /(\d{1,2}):(\d{2})\s*am/i,
        /at\s+(\d{1,2})\s*pm/i,
        /at\s+(\d{1,2})\s*am/i,
        /at\s+(\d{1,2}):(\d{2})\s*pm/i,
        /at\s+(\d{1,2}):(\d{2})\s*am/i
      ];
      
      for (const pattern of timePatterns) {
        const match = message.match(pattern);
        if (match) {
          if (match[2]) {
            // Has minutes
            const hour = parseInt(match[1]);
            const minute = match[2];
            const period = message.toLowerCase().includes('pm') ? 'PM' : 'AM';
            eventDetails.time = `${hour}:${minute} ${period}`;
          } else {
            // Just hour
            const hour = parseInt(match[1]);
            const period = message.toLowerCase().includes('pm') ? 'PM' : 'AM';
            eventDetails.time = `${hour}:00 ${period}`;
          }
          break;
        }
      }
      
      // Smart duration estimation with AI intelligence integration
      if (msg.includes('meeting')) eventDetails.duration = '1 hour';
      else if (msg.includes('golf')) eventDetails.duration = '4 hours';
      else if (msg.includes('lunch') || msg.includes('dinner')) eventDetails.duration = '1.5 hours';
      else if (msg.includes('call')) eventDetails.duration = '30 minutes';
      else if (msg.includes('dentist') || msg.includes('doctor')) eventDetails.duration = '1 hour';
      else if (msg.includes('party') || msg.includes('birthday')) eventDetails.duration = '3 hours';
      else if (msg.includes('family') || msg.includes('thanksgiving')) eventDetails.duration = '4 hours';
      
      // AI Intelligence Integration - determine which engines to surface
      const aiEngines = determineEventIntelligence(eventDetails.title, msg);
      
      messagesDiv.innerHTML += `
        <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(59, 130, 246, 0.1)); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 16px; padding: 20px; margin: 16px 0; backdrop-filter: blur(10px);">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
            <div style="background: rgba(34, 197, 94, 0.2); padding: 8px; border-radius: 12px;">
              <i data-lucide="calendar-plus" style="width: 20px; height: 20px; color: #22c55e;"></i>
            </div>
            <div>
              <div style="font-weight: 700; font-size: 16px; color: white;">Calendar Event Detected</div>
              <div style="font-size: 13px; color: rgba(255,255,255,0.7);">Ready to add to your schedule</div>
            </div>
          </div>
          
          <div style="background: rgba(255,255,255,0.1); padding: 16px; border-radius: 12px; margin-bottom: 16px; border: 1px solid rgba(255,255,255,0.1);">
            <div style="font-weight: 600; font-size: 18px; margin-bottom: 12px; color: white;">${eventDetails.title}</div>
            <div style="display: grid; grid-template-columns: auto 1fr; gap: 8px 12px; font-size: 14px; color: rgba(255,255,255,0.9);">
              <div style="display: flex; align-items: center; gap: 6px;">
                <i data-lucide="calendar" style="width: 14px; height: 14px;"></i>
                <span>Date:</span>
              </div>
              <span>${eventDetails.date}</span>
              
              <div style="display: flex; align-items: center; gap: 6px;">
                <i data-lucide="clock" style="width: 14px; height: 14px;"></i>
                <span>Time:</span>
              </div>
              <span>${eventDetails.time}</span>
              
              <div style="display: flex; align-items: center; gap: 6px;">
                <i data-lucide="timer" style="width: 14px; height: 14px;"></i>
                <span>Duration:</span>
              </div>
              <span>${eventDetails.duration}</span>
            </div>
          </div>
          
          <div style="display: flex; gap: 12px;">
            <button onclick="quickAddCalendarEvent('${eventDetails.title.replace(/'/g, "\\'")}', '${eventDetails.date}', '${eventDetails.time}', '${eventDetails.duration}')" 
                    style="flex: 1; background: linear-gradient(135deg, #22c55e, #16a34a); border: none; border-radius: 12px; padding: 12px 16px; color: white; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);"
                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(34, 197, 94, 0.4)'"
                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(34, 197, 94, 0.3)'">
              <i data-lucide="plus" style="width: 16px; height: 16px; margin-right: 8px;"></i>
              Add to Calendar
            </button>
            <button onclick="editEventBeforeAdding('${eventDetails.title.replace(/'/g, "\\'")}', '${eventDetails.date}', '${eventDetails.time}')" 
                    style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; padding: 12px 16px; color: white; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease;"
                    onmouseover="this.style.background='rgba(255,255,255,0.15)'"
                    onmouseout="this.style.background='rgba(255,255,255,0.1)'">
              <i data-lucide="edit-3" style="width: 16px; height: 16px;"></i>
            </button>
          </div>
        </div>
      `;
      
      // Re-initialize Lucide icons for new content
      lucide.createIcons();
    }
    
    // Simplified calendar event adding
    async function quickAddCalendarEvent(title, date, time, duration) {
      const messagesDiv = document.querySelector('.chat-messages-mobile');
      
      try {
        // Parse the date and time into proper format
        let eventDateTime = new Date();
        
        // Handle relative dates
        if (date.toLowerCase() === 'tomorrow') {
          eventDateTime.setDate(eventDateTime.getDate() + 1);
        } else if (date.toLowerCase() === 'today') {
          // Keep current date
        } else {
          // Handle named days (Monday, Tuesday, etc.)
          const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
          const dayIndex = days.indexOf(date.toLowerCase());
          if (dayIndex !== -1) {
            const currentDay = eventDateTime.getDay();
            const daysAhead = (dayIndex - currentDay + 7) % 7 || 7;
            eventDateTime.setDate(eventDateTime.getDate() + daysAhead);
          }
        }
        
        // Parse time
        if (time) {
          const timeMatch = time.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
          if (timeMatch) {
            let hour = parseInt(timeMatch[1]);
            const minute = parseInt(timeMatch[2]);
            const period = timeMatch[3].toUpperCase();
            
            if (period === 'PM' && hour !== 12) hour += 12;
            if (period === 'AM' && hour === 12) hour = 0;
            
            eventDateTime.setHours(hour, minute, 0, 0);
          }
        }
        
        // Create event object
        const event = {
          id: `event_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
          title: title,
          start: eventDateTime.toISOString(),
          date: eventDateTime.toISOString().split('T')[0],
          time: eventDateTime.toTimeString().substring(0, 5),
          type: determineEventType(title),
          category: 'general',
          duration: parseDuration(duration),
          source: 'chat-quick-add',
          aiEnhanced: true,
          created: new Date().toISOString()
        };
        
        // Save locally first
        const events = JSON.parse(localStorage.getItem('calendar-events') || '[]');
        events.push(event);
        localStorage.setItem('calendar-events', JSON.stringify(events));
        
        // Try to sync with server
        try {
          const response = await fetch('/api/calendar-events', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(event)
          });
          
          if (response.ok) {
            console.log('âœ… Event synced to server');
          }
        } catch (error) {
          console.log('ðŸ“± Offline mode: Event saved locally');
        }
        
        // Show success message
        messagesDiv.innerHTML += `
          <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(16, 185, 129, 0.1)); border: 1px solid rgba(34, 197, 94, 0.4); border-radius: 12px; padding: 16px; margin: 12px 0;">
            <div style="display: flex; align-items: center; gap: 12px;">
              <div style="background: rgba(34, 197, 94, 0.3); padding: 8px; border-radius: 12px;">
                <i data-lucide="check" style="width: 18px; height: 18px; color: #22c55e;"></i>
              </div>
              <div>
                <div style="font-weight: 600; color: white; margin-bottom: 4px;">Event Added!</div>
                <div style="font-size: 13px; color: rgba(255,255,255,0.8);">"${title}" has been added to your calendar</div>
              </div>
            </div>
          </div>
        `;
        
        lucide.createIcons();
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        
      } catch (error) {
        console.error('Error adding event:', error);
        messagesDiv.innerHTML += `
          <div style="background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.4); border-radius: 12px; padding: 16px; margin: 12px 0;">
            <div style="color: white; font-weight: 600;">Failed to add event. Please try again.</div>
          </div>
        `;
      }
    }
    
    // Edit event before adding
    function editEventBeforeAdding(title, date, time) {
      const eventType = determineEventType(title);
      showEventCreationModal(eventType);
      
      // Pre-fill the modal with detected values
      setTimeout(() => {
        const titleInput = document.getElementById('event-title');
        const timeInput = document.getElementById('event-time');
        
        if (titleInput) titleInput.value = title;
        if (timeInput) timeInput.value = `${date} at ${time}`;
      }, 100);
    }
    
    // Determine event type from title
    function determineEventType(title) {
      const titleLower = title.toLowerCase();
      if (titleLower.includes('meeting') || titleLower.includes('call')) return 'meeting';
      if (titleLower.includes('appointment') || titleLower.includes('doctor') || titleLower.includes('dentist')) return 'appointment';
      if (titleLower.includes('flight') || titleLower.includes('trip') || titleLower.includes('travel')) return 'travel';
      return 'personal';
    }
    
    // Parse duration string to minutes
    function parseDuration(durationStr) {
      const str = durationStr.toLowerCase();
      if (str.includes('hour')) {
        const hours = parseFloat(str.match(/[\d.]+/)?.[0] || 1);
        return hours * 60;
      }
      if (str.includes('minute')) {
        return parseInt(str.match(/\d+/)?.[0] || 30);
      }
      return 60; // Default 1 hour
    }
      
    
    // Email Intelligence Execution
    async function executeEmailIntelligence(message, messagesDiv) {
      console.log('ðŸ“§ Email Intelligence activated for:', message);
      
      messagesDiv.innerHTML += `
        <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(16, 185, 129, 0.1)); border: 1px solid rgba(34, 197, 94, 0.4); border-radius: 16px; padding: 20px; margin: 16px 0;">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
            <div style="background: rgba(34, 197, 94, 0.3); padding: 8px; border-radius: 12px;">
              <i data-lucide="mail" style="width: 20px; height: 20px; color: #22c55e;"></i>
            </div>
            <div>
              <div style="font-weight: 700; font-size: 16px; color: white;">Email Intelligence</div>
              <div style="font-size: 13px; color: rgba(255,255,255,0.7);">Analyzing your email patterns...</div>
            </div>
          </div>
          <div style="background: rgba(255,255,255,0.1); padding: 16px; border-radius: 12px; margin-bottom: 16px; border: 1px solid rgba(255,255,255,0.1);">
            <div style="font-size: 14px; color: rgba(255,255,255,0.9);">
              ðŸ“Š Email analysis features coming soon<br>
              ðŸŽ¯ Pattern recognition and automation<br>
              ðŸ“§ Smart categorization and responses
            </div>
          </div>
        </div>
      `;
      
      lucide.createIcons();
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
    
    // Calendar rendering functions
    function renderSmartCalendar() {
      console.log('ðŸ“… Rendering smart calendar...');
      // Calendar rendering logic will be implemented here
    }
    
    function getEventCategoryColor(category, border = false) {
      const colors = {
        work: border ? 'rgba(59, 130, 246, 0.6)' : 'rgba(59, 130, 246, 0.3)',
        personal: border ? 'rgba(34, 197, 94, 0.6)' : 'rgba(34, 197, 94, 0.3)', 
        medical: border ? 'rgba(168, 85, 247, 0.6)' : 'rgba(168, 85, 247, 0.3)',
        travel: border ? 'rgba(251, 191, 36, 0.6)' : 'rgba(251, 191, 36, 0.3)',
        general: border ? 'rgba(107, 114, 128, 0.6)' : 'rgba(107, 114, 128, 0.3)'
      };
      return colors[category] || colors.general;
    }
    
    // Event interaction functions
    function viewSmartEventDetails(event) {
      console.log('ðŸ‘ï¸ Viewing event details:', event);
    }
    
    function activateEventIntelligence(eventTitle) {
      console.log('ðŸ§  Activating intelligence for:', eventTitle);
    }
    
    
    async function renderSmartCalendar() {
      const calendarDays = document.getElementById('calendar-days');
      if (!calendarDays) return;
      
      // Load events from new calendar intelligence system
      const events = await loadCalendarEvents('user@homeops.ai');
      const todayEventsList = document.getElementById('today-events-list');
      
      if (todayEventsList) {
        // Clear existing events
        todayEventsList.innerHTML = '';
        
        // Get today's events
        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];
        const todayEvents = events.filter(event => {
          const eventDate = new Date(event.start);
          return eventDate.toISOString().split('T')[0] === todayStr;
        });
        
        if (todayEvents.length === 0) {
          todayEventsList.innerHTML = `
            <div style="text-align: center; padding: 20px; color: rgba(255,255,255,0.6);">
              <i data-lucide="calendar" style="width: 24px; height: 24px; margin-bottom: 8px;"></i>
              <div>No events scheduled for today</div>
            </div>
          `;
        } else {
          // Add smart events with emotional context
          todayEvents.forEach(event => {
            const eventItem = document.createElement('div');
            eventItem.className = 'event-item';
            eventItem.style.cssText = `
              background: ${getEventCategoryColor(event.category)};
              border: 1px solid ${getEventCategoryColor(event.category, true)};
              border-radius: 8px;
              padding: 12px;
              margin-bottom: 8px;
              cursor: pointer;
              transition: all 0.2s;
            `;
            
            const eventTime = new Date(event.start).toLocaleTimeString('en-US', {
              hour: 'numeric',
              minute: '2-digit',
              hour12: true
            });
            
            eventItem.innerHTML = `
              <div style="font-weight: 600; margin-bottom: 4px; display: flex; align-items: center; justify-content: between;">
                <span>${event.title}</span>
                <span style="font-size: 12px; opacity: 0.8; margin-left: auto;">${eventTime}</span>
              </div>
              <div style="font-size: 11px; opacity: 0.7; margin-bottom: 6px; text-transform: capitalize;">
                ${event.category} â€¢ ${event.source}
              </div>
              ${event.emotionalTags && event.emotionalTags.length > 0 ? `
                <div style="display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 6px;">
                  ${event.emotionalTags.map(tag => `
                    <span style="
                      background: rgba(255,255,255,0.2);
                      padding: 2px 6px;
                      border-radius: 4px;
                      font-size: 10px;
                      font-weight: 500;
                    ">${tag.replace('-', ' ')}</span>
                  `).join('')}
                </div>
              ` : ''}
              <div style="font-size: 11px; color: rgba(255,255,255,0.6); display: flex; align-items: center; gap: 4px;">
                <i data-lucide="brain-circuit" style="width: 12px; height: 12px;"></i>
                <span>AI Enhanced</span>
              </div>
            `;
            
            eventItem.onclick = () => viewSmartEventDetails(event);
            
            // Add hover effects
            eventItem.onmouseenter = () => {
              eventItem.style.transform = 'translateY(-1px)';
              eventItem.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
            };
            eventItem.onmouseleave = () => {
              eventItem.style.transform = 'translateY(0)';
              eventItem.style.boxShadow = 'none';
            };
            
            todayEventsList.appendChild(eventItem);
          });
        }
        
        // Show emotional load summary if there are events
        if (todayEvents.length > 0) {
          try {
            const emotionalLoad = await getUpcomingEmotionalLoad('user@homeops.ai');
            if (emotionalLoad && emotionalLoad.emotionalBreakdown && Object.keys(emotionalLoad.emotionalBreakdown).length > 0) {
            const loadSummary = document.createElement('div');
            loadSummary.style.cssText = `
              background: rgba(139, 92, 246, 0.2);
              border: 1px solid rgba(139, 92, 246, 0.4);
              border-radius: 8px;
              padding: 12px;
              margin-top: 12px;
            `;
            
            loadSummary.innerHTML = `
              <div style="font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
                <i data-lucide="brain-circuit" style="width: 14px; height: 14px;"></i>
                7-Day Mental Load Forecast
              </div>
              <div style="font-size: 12px; color: rgba(255,255,255,0.8);">
                ${emotionalLoad.totalEvents} upcoming events with ${Object.keys(emotionalLoad.emotionalBreakdown).length} emotional themes
              </div>
            `;
            
            todayEventsList.appendChild(loadSummary);
            }
          } catch (error) {
            console.error('Error loading emotional load:', error);
          }
        }
        
        // Initialize Lucide icons
        setTimeout(() => {
          if (typeof lucide !== 'undefined') {
            lucide.createIcons();
          }
        }, 100);
      }
      
      // Initialize selected date to today if not already set
      if (!window.selectedCalendarDate) {
        window.selectedCalendarDate = new Date();
      }
      
      // Populate calendar grid
      populateCalendarGrid();
    }
    
    // Populate the calendar grid with days
    function populateCalendarGrid() {
      const calendarDays = document.getElementById('calendar-days');
      if (!calendarDays) return;
      
      const today = new Date();
      const currentYear = today.getFullYear();
      const currentMonth = today.getMonth();
      const isCurrentMonth = true; // For now, always show current month
      
      // Clear existing days
      calendarDays.innerHTML = '';
      
      // Get first day of month and number of days
      const firstDay = new Date(currentYear, currentMonth, 1);
      const lastDay = new Date(currentYear, currentMonth + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startingDayOfWeek = firstDay.getDay();
      
      // Add empty cells for days before the first day of the month
      for (let i = 0; i < startingDayOfWeek; i++) {
        const emptyElement = document.createElement('div');
        emptyElement.style.cssText = 'background: transparent;';
        calendarDays.appendChild(emptyElement);
      }
      
      // Add days of the month
      for (let day = 1; day <= daysInMonth; day++) {
        const dayElement = document.createElement('div');
        const isToday = isCurrentMonth && day === today.getDate();
        
        dayElement.style.cssText = `
          background: ${isToday ? 'rgba(139, 92, 246, 0.3)' : 'rgba(255,255,255,0.05)'};
          padding: 8px 4px;
          text-align: center;
          font-size: 13px;
          color: ${isToday ? '#ffffff' : 'rgba(255,255,255,0.9)'};
          border: ${isToday ? '1px solid rgba(139, 92, 246, 0.6)' : 'none'};
          cursor: pointer;
          transition: background 0.2s;
        `;
        
        dayElement.textContent = day;
        dayElement.onclick = (event) => {
          event.stopPropagation();
          selectCalendarDay(currentYear, currentMonth + 1, day);
        };
        
        // Add hover effect
        dayElement.onmouseenter = () => {
          if (!isToday) {
            dayElement.style.background = 'rgba(255,255,255,0.1)';
          }
        };
        dayElement.onmouseleave = () => {
          if (!isToday) {
            dayElement.style.background = 'rgba(255,255,255,0.05)';
          }
        };
        
        calendarDays.appendChild(dayElement);
      }
    }
    
    // Get color for event category
    function getEventCategoryColor(category, border = false) {
      const colors = {
        'school': border ? 'rgba(59, 130, 246, 0.6)' : 'rgba(59, 130, 246, 0.2)',
        'medical': border ? 'rgba(239, 68, 68, 0.6)' : 'rgba(239, 68, 68, 0.2)',
        'work': border ? 'rgba(107, 114, 128, 0.6)' : 'rgba(107, 114, 128, 0.2)',
        'travel': border ? 'rgba(34, 197, 94, 0.6)' : 'rgba(34, 197, 94, 0.2)',
        'family': border ? 'rgba(251, 191, 36, 0.6)' : 'rgba(251, 191, 36, 0.2)',
        'logistics': border ? 'rgba(168, 85, 247, 0.6)' : 'rgba(168, 85, 247, 0.2)',
        'personal': border ? 'rgba(34, 197, 94, 0.6)' : 'rgba(34, 197, 94, 0.2)'
      };
      return colors[category] || (border ? 'rgba(107, 114, 128, 0.6)' : 'rgba(107, 114, 128, 0.2)');
    }
    
    function viewSmartEventDetails(event) {
      const messagesDiv = document.querySelector('.chat-messages-mobile');
      
      messagesDiv.innerHTML += `
        <div style="background: rgba(139, 92, 246, 0.3); border: 1px solid rgba(139, 92, 246, 0.5); border-radius: 12px; padding: 16px; margin: 12px 0;">
          <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
            <i data-lucide="zap"></i>
            <span>ðŸ“… ${event.title}</span>
          </div>
          
          <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
            <div style="font-size: 14px; color: rgba(255,255,255,0.9); margin-bottom: 8px;">
              ðŸ“… ${event.date} at ${event.time}<br>
              âŒ› ${event.duration}
            </div>
          </div>
          
          <div style="margin-bottom: 16px;">
            <div style="font-weight: 600; margin-bottom: 8px;">ðŸ¤– Available AI Intelligence</div>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
              ${event.aiEngines ? event.aiEngines.map(engine => `
                <button onclick="activateEngineForEvent('${event.id}', '${engine.type}', '${event.title}')" 
                        style="background: ${engine.color}; border: 1px solid ${engine.color.replace('0.4', '0.6')}; border-radius: 8px; padding: 8px 12px; color: white; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                  <span>${engine.icon}</span>
                  <span>${engine.name}</span>
                </button>
              `).join('') : ''}
            </div>
          </div>
          
          <div style="display: flex; gap: 8px;">
            <button onclick="editSmartEvent('${event.id}')" 
                    style="background: rgba(59, 130, 246, 0.3); border: 1px solid rgba(59, 130, 246, 0.6); border-radius: 8px; padding: 8px 16px; color: white; font-size: 14px; cursor: pointer;">
              <i data-lucide="zap"></i>
              Edit Event
            </button>
            <button onclick="deleteSmartEvent('${event.id}')" 
                    style="background: rgba(239, 68, 68, 0.3); border: 1px solid rgba(239, 68, 68, 0.6); border-radius: 8px; padding: 8px 16px; color: white; font-size: 14px; cursor: pointer;">
              <i data-lucide="zap"></i>
              Delete
            </button>
          </div>
        </div>
      `;
      
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      
      setTimeout(() => {
        if (typeof lucide !== 'undefined') {

        }
      }, 100);
    }
    
    function activateEngineForEvent(eventId, engineType, eventTitle) {
      const messagesDiv = document.querySelector('.chat-messages-mobile');
      
      switch (engineType) {
        case 'commerce':
          executeEventCommerceIntelligence(eventTitle, messagesDiv);
          break;
        case 'life':
          executeEventLifeIntelligence(eventTitle, messagesDiv);
          break;
        case 'travel':
          executeEventTravelIntelligence(eventTitle, messagesDiv);
          break;
        case 'email':
          executeEventEmailIntelligence(eventTitle, messagesDiv);
          break;
      }
    }
    
    function executeEventCommerceIntelligence(eventTitle, messagesDiv) {
      // Trigger commerce intelligence based on event context
      if (eventTitle.toLowerCase().includes('birthday')) {
        executeShoppingSearch(`gift for birthday party`, messagesDiv);
      } else if (eventTitle.toLowerCase().includes('anniversary')) {
        executeShoppingSearch(`$10k anniversary gift`, messagesDiv);
      } else {
        executeShoppingSearch(`gift for ${eventTitle}`, messagesDiv);
      }
    }
    
    function executeEventLifeIntelligence(eventTitle, messagesDiv) {
      // Generate contextual life intelligence
      const lifeIntelligenceCard = {
        analysis: `This ${eventTitle.toLowerCase()} represents an opportunity for deeper connection and meaningful presence.`,
        framework: "Attachment Theory + Family Systems",
        insights: [
          "Family dynamics often intensify during planned gatherings",
          "Your presence and attention matter more than perfect logistics",
          "Setting boundaries early prevents overwhelm later"
        ],
        action_steps: [
          "Clarify your role and expectations beforehand",
          "Plan transition time before and after the event",
          "Communicate your needs without over-explaining"
        ],
        reframe: "This isn't about managing everyone else's experience. It's about showing up authentically.",
        next_step: "Text or call to confirm one specific detail today"
      };
      
      messagesDiv.innerHTML += `
        <div style="background: rgba(139, 92, 246, 0.3); border: 1px solid rgba(139, 92, 246, 0.5); border-radius: 12px; padding: 16px; margin: 8px 0;">
          <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
            <i data-lucide="zap"></i>
            <span>ðŸ§  Life Intelligence for ${eventTitle}</span>
          </div>
          
          <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
            <div style="font-weight: 600; margin-bottom: 6px;">ðŸ“Š Analysis</div>
            <div style="font-size: 14px; line-height: 1.4;">${lifeIntelligenceCard.analysis}</div>
            <div style="font-size: 12px; color: rgba(255,255,255,0.7); margin-top: 4px; font-style: italic;">Framework: ${lifeIntelligenceCard.framework}</div>
          </div>
          
          <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
            <div style="font-weight: 600; margin-bottom: 8px;">ðŸŽ¯ Evidence-Based Insights</div>
            ${lifeIntelligenceCard.insights.map(insight => `
              <div style="margin: 6px 0; font-size: 13px; line-height: 1.4; padding-left: 12px; border-left: 2px solid rgba(139, 92, 246, 0.6);">
                ${insight}
              </div>
            `).join('')}
          </div>
          
          <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
            <div style="font-weight: 600; margin-bottom: 8px;">âœ… Action Protocol</div>
            ${lifeIntelligenceCard.action_steps.map((step, index) => `
              <div style="margin: 8px 0; font-size: 13px; line-height: 1.4; display: flex; gap: 8px;">
                <span style="background: rgba(139, 92, 246, 0.6); color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; flex-shrink: 0;">${index + 1}</span>
                <span>${step}</span>
              </div>
            `).join('')}
          </div>
          
          <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
            <div style="font-weight: 600; margin-bottom: 6px;">ðŸ”„ Reframe</div>
            <div style="font-size: 14px; line-height: 1.4; font-style: italic;">${lifeIntelligenceCard.reframe}</div>
          </div>
          
          <div style="background: rgba(34, 197, 94, 0.2); border: 1px solid rgba(34, 197, 94, 0.4); padding: 12px; border-radius: 8px; margin-top: 12px;">
            <div style="font-weight: 600; margin-bottom: 6px;">ðŸš€ Next Step (Today)</div>
            <div style="font-size: 14px; line-height: 1.4;">${lifeIntelligenceCard.next_step}</div>
          </div>
        </div>
      `;
      
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      setTimeout(() => {
        if (typeof lucide !== 'undefined') {

        }
      }, 100);
    }
    
    function executeEventTravelIntelligence(eventTitle, messagesDiv) {
      executeFlightSearch(`flight for ${eventTitle}`, messagesDiv);
    }
    
    function executeEventEmailIntelligence(eventTitle, messagesDiv) {
      executeEmailSummary(`emails about ${eventTitle}`, messagesDiv);
    }
    
    // Gmail OAuth connection
    function connectGmail() {
      window.location.href = '/auth/gmail';
    }
    
    // Test email analysis with sample
    async function testSampleEmail() {
      const messagesDiv = document.querySelector('.chat-messages-mobile');
      addSystemMessage(messagesDiv, "ðŸ§ª Testing email intelligence with sample school email...");
      
      try {
        const response = await fetch('/api/analyze-sample-email', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            subject: "ðŸŽ¨âœ¨ Join Us for the 21st Annual Arts Celebration at The Woods Academy NEXT WEEK! | May 27â€“30!",
            sender: "communications@woodsacademy.edu",
            content: "Dear Woods Academy Families, Mark your calendars! The 21st Annual Arts Celebration is happening NEXT WEEK from Monday, May 27th through Thursday, May 30th! Tuesday Concert at 9:30 AM in the gymnasium. Musical performances Thursday & Friday evenings. Coffee with teachers Friday at 8:30 AM."
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          messagesDiv.innerHTML += `
            <div style="background: rgba(139, 92, 246, 0.2); border: 1px solid rgba(139, 92, 246, 0.4); border-radius: 12px; padding: 16px; margin: 12px 0;">
              <div style="font-weight: 600; margin-bottom: 12px;">ðŸ§ª Sample Email Analysis</div>
              <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 8px;">
                <div style="font-size: 12px; color: rgba(255,255,255,0.7); margin-bottom: 4px;">CATEGORY: ${data.category.toUpperCase()}</div>
                <div style="font-weight: 600; margin-bottom: 6px;">ðŸ“Š Signal Summary</div>
                <div style="font-size: 14px; line-height: 1.4;">${data.summary}</div>
              </div>
              <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 8px;">
                <div style="font-weight: 600; margin-bottom: 6px;">ðŸ“… Key Dates</div>
                <div style="font-size: 14px;">${data.keyDates}</div>
              </div>
              <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 8px;">
                <div style="font-weight: 600; margin-bottom: 6px;">âœ… Action Items</div>
                <div style="font-size: 14px;">${data.actionItems}</div>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="font-size: 12px; color: rgba(255,255,255,0.7);">
                  Manipulation Score: ${data.manipulationScore}/10 | Priority: ${data.priority.toUpperCase()}
                </div>
              </div>
            </div>
          `;
        } else {
          messagesDiv.innerHTML += `
            <div style="background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.4); border-radius: 12px; padding: 16px; margin: 12px 0;">
              <div style="font-weight: 600;">âŒ Test Failed</div>
              <div style="font-size: 14px; margin-top: 8px;">${data.message || 'Could not analyze sample email'}</div>
            </div>
          `;
        }
      } catch (error) {
        console.error('Sample email test error:', error);
        messagesDiv.innerHTML += `
          <div style="background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.4); border-radius: 12px; padding: 16px; margin: 12px 0;">
            <div style="font-weight: 600;">âŒ Test Error</div>
            <div style="font-size: 14px; margin-top: 8px;">Could not connect to email intelligence API</div>
          </div>
        `;
      }
      
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
    
    // Gmail connection for mobile
    function connectGmailMobile() {
      connectGmail();
    }
    
    // Process emails mobile
    function processEmailsMobile() {
      const messagesDiv = document.querySelector('.chat-messages-mobile');
      if (messagesDiv) {
        executeEmailSummary("process latest emails", messagesDiv);
      }
    }
    
    // Test sample parent email
    function testSampleParentEmail() {
      testSampleEmail();
    }
    
    // Show email category
    function showEmailCategory(category, button) {
      // Update active button
      document.querySelectorAll('.category-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      button.classList.add('active');
      
      // Update content based on category
      const contentDiv = document.getElementById('email-category-content');
      if (contentDiv) {
        contentDiv.innerHTML = `
          <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 16px; text-align: center;">
            <div style="font-size: 24px; margin-bottom: 8px;">${getCategoryIcon(category)}</div>
            <div style="font-weight: 600; margin-bottom: 4px;">${getCategoryName(category)}</div>
            <div style="font-size: 14px; color: rgba(255,255,255,0.7);">
              ${category === 'all' ? 'Connect Gmail to see categorized emails' : `No ${category} emails to display yet`}
            </div>
          </div>
        `;
      }
    }
    
    function getCategoryIcon(category) {
      const icons = {
        'all': 'ðŸ“‹',
        'family': 'ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦',
        'school': 'ðŸ«',
        'work': 'ðŸ’¼',
        'commerce': 'ðŸ›’',
        'priority': 'ðŸš¨'
      };
      return icons[category] || 'ðŸ“§';
    }
    
    function getCategoryName(category) {
      const names = {
        'all': 'All Intelligence',
        'family': 'Family & Personal',
        'school': 'School & Education',
        'work': 'Work & Professional',
        'commerce': 'Deals & Shopping',
        'priority': 'Priority Actions'
      };
      return names[category] || 'Emails';
    }
    
    // Life Intelligence Helper Functions
    function expandLifeIntelligence(encodedMessage) {
      const message = decodeURIComponent(encodedMessage);
      const messagesDiv = document.querySelector('.chat-messages-mobile');
      
      addSystemMessage(messagesDiv, "ðŸ§  Expanding analysis with additional frameworks...");
      
      // Re-trigger with deeper analysis flag
      executeLifeIntelligence(`[DEEPER_ANALYSIS] ${message}`, messagesDiv);
    }
    
    function createLifePlan(encodedMessage) {
      const message = decodeURIComponent(encodedMessage);
      const messagesDiv = document.querySelector('.chat-messages-mobile');
      
      addSystemMessage(messagesDiv, "ðŸ“… Creating personalized action plan...");
      
      // Trigger calendar integration with life intelligence context
      executeCalendarInjection(`Create life plan for: ${message}`, messagesDiv);
    }
    
    function shareWithPartner(encodedMessage) {
      const message = decodeURIComponent(encodedMessage);
      const messagesDiv = document.querySelector('.chat-messages-mobile');
      
      const shareCard = `
        <div style="background: rgba(251, 191, 36, 0.2); border: 1px solid rgba(251, 191, 36, 0.4); border-radius: 12px; padding: 20px; margin: 12px 0;">
          <div style="font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; color: white;">
            <i data-lucide="zap"></i>
            <span>Share Insights</span>
          </div>
          <div style="background: rgba(255,255,255,0.1); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
            <div style="font-size: 14px; line-height: 1.5; margin-bottom: 12px; color: rgba(255,255,255,0.9);">
              Here's a thoughtful way to share this with your partner:
            </div>
            <div style="font-size: 14px; line-height: 1.5; font-style: italic; color: rgba(255,255,255,0.95); padding: 12px; background: rgba(255,255,255,0.1); border-radius: 6px;">
              "Hey, I've been thinking about our situation. I found some insights that might help us both. Want to talk about it together?"
            </div>
          </div>
          <button onclick="copyToClipboard('Share: ${message.replace(/'/g, "\\'")}', this)" 
                  style="background: rgba(251, 191, 36, 0.4); border: 1px solid rgba(251, 191, 36, 0.6); border-radius: 8px; padding: 12px 16px; color: white; font-size: 14px; cursor: pointer; width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; font-weight: 500;">
            <i data-lucide="zap"></i>
            Copy Message Template
          </button>
        </div>
      `;
      
      messagesDiv.innerHTML += shareCard;
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      
      setTimeout(() => {
        if (typeof lucide !== 'undefined') {

        }
      }, 100);
    }
    
    function copyToClipboard(text, button) {
      navigator.clipboard.writeText(text).then(function() {
        button.innerHTML = '<i data-lucide="zap"></i>Copied!';
        setTimeout(() => {
          button.innerHTML = '<i data-lucide="zap"></i>Copy Message Template';
          if (typeof lucide !== 'undefined') {

          }
        }, 2000);
      });
    }
    
    // ===== HOMEOPS DECODER CARD SYSTEM =====
    
    // Load and display DecoderCards
    async function loadDecoderCards() {
      const resultsDiv = document.getElementById('intelligent-email-results');
      const placeholder = document.getElementById('no-emails-placeholder');
      const processingDiv = document.getElementById('processing-status');
      
      // Show processing state
      if (placeholder) placeholder.style.display = 'none';
      if (processingDiv) {
        processingDiv.style.display = 'block';
        processingDiv.querySelector('#processing-message').textContent = 'HomeOps is analyzing your emails...';
      }
      
      try {
        const response = await fetch('/api/decoder-cards', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ maxResults: 10 })
        });
        
        const data = await response.json();
        
        if (data.success && data.cards.length > 0) {
          displayDecoderCards(data.cards);
        } else {
          if (placeholder) {
            placeholder.style.display = 'block';
            placeholder.querySelector('div:last-child').textContent = 'No recent emails found. Try connecting Gmail or check your inbox.';
          }
        }
      } catch (error) {
        console.error('Error loading decoder cards:', error);
        if (placeholder) {
          placeholder.style.display = 'block';
          placeholder.querySelector('div:last-child').textContent = 'Unable to connect to email service. Please try again.';
        }
      } finally {
        if (processingDiv) processingDiv.style.display = 'none';
      }
    }
    
    // Display DecoderCards in the UI
    function displayDecoderCards(cards) {
      const resultsDiv = document.getElementById('intelligent-email-results');
      
      const cardsHTML = cards.map(card => {
        const categoryIcon = getCategoryIcon(card.category);
        const priorityColor = getPriorityColor(card.priority);
        
        return `
          <div class="decoder-card" style="
            background: rgba(255,255,255,0.08); 
            border: 1px solid rgba(255,255,255,0.15); 
            border-radius: 12px; 
            padding: 16px; 
            margin-bottom: 12px;
            border-left: 3px solid ${priorityColor};
          ">
            <!-- Card Header -->
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
              <div style="display: flex; align-items: center; gap: 8px;">
                ${categoryIcon}
                <span style="background: rgba(139, 92, 246, 0.2); padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 600;">
                  ${card.category.toUpperCase()}
                </span>
              </div>
              <span style="font-size: 12px; color: rgba(255,255,255,0.6);">${card.time_ago}</span>
            </div>
            
            <!-- Summary -->
            <div style="margin-bottom: 12px;">
              <div style="font-weight: 600; color: white; line-height: 1.4;">${card.summary}</div>
              <div style="font-size: 12px; color: rgba(255,255,255,0.7); margin-top: 4px;">
                From: ${card.sender.split('<')[0].trim()}
              </div>
            </div>
            
            <!-- Action Buttons -->
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
              ${card.calendar_events ? `
                <button onclick="addToCalendar('${card.email_id}', '${card.calendar_events}')" 
                        style="display: flex; align-items: center; gap: 6px; padding: 8px 12px; background: rgba(34, 197, 94, 0.2); border: 1px solid rgba(34, 197, 94, 0.4); border-radius: 6px; color: white; font-size: 12px; cursor: pointer;">
                  <i data-lucide="calendar-plus" style="width: 14px; height: 14px;"></i> Add to Calendar
                </button>
              ` : ''}
              
              <button onclick="openInGmail('${card.gmail_url}')" 
                      style="display: flex; align-items: center; gap: 6px; padding: 8px 12px; background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.4); border-radius: 6px; color: white; font-size: 12px; cursor: pointer;">
                <i data-lucide="external-link" style="width: 14px; height: 14px;"></i> View in Gmail
              </button>
              
              <button onclick="expandCard('${card.email_id}')" 
                      style="display: flex; align-items: center; gap: 6px; padding: 8px 12px; background: rgba(156, 163, 175, 0.2); border: 1px solid rgba(156, 163, 175, 0.4); border-radius: 6px; color: white; font-size: 12px; cursor: pointer;">
                <i data-lucide="book-open" style="width: 14px; height: 14px;"></i> Read More
              </button>
              
              <div style="margin-left: auto; display: flex; gap: 4px;">
                <button class="feedback-btn feedback-positive" 
                        data-email-id="${card.email_id}" 
                        data-feedback="positive"
                        data-card='${JSON.stringify(card).replace(/'/g, '&#39;').replace(/"/g, '&quot;')}'
                        style="padding: 6px; background: rgba(34, 197, 94, 0.2); border: 1px solid rgba(34, 197, 94, 0.4); border-radius: 4px; color: white; cursor: pointer; display: flex; align-items: center;">
                  <i data-lucide="thumbs-up" style="width: 16px; height: 16px;"></i>
                </button>
                <button class="feedback-btn feedback-negative" 
                        data-email-id="${card.email_id}" 
                        data-feedback="negative"
                        data-card='${JSON.stringify(card).replace(/'/g, '&#39;').replace(/"/g, '&quot;')}'
                        style="padding: 6px; background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.4); border-radius: 4px; color: white; cursor: pointer; display: flex; align-items: center;">
                  <i data-lucide="thumbs-down" style="width: 16px; height: 16px;"></i>
                </button>
              </div>
            </div>
            
            <!-- Expanded Content (Initially Hidden) -->
            <div id="expanded-${card.email_id}" style="display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
              <!-- Email Overview Section -->
              <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                <div style="font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                  <i data-lucide="mail-open" style="width: 18px; height: 18px; color: #60a5fa;"></i>
                  Email Overview
                </div>
                <div style="font-size: 13px; line-height: 1.5; color: rgba(255,255,255,0.9);">
                  <div style="margin-bottom: 6px;"><strong>From:</strong> ${card.sender}</div>
                  <div style="margin-bottom: 6px;"><strong>Subject:</strong> ${card.subject}</div>
                  <div style="margin-bottom: 6px;"><strong>Received:</strong> ${card.time_ago}</div>
                  <div style="margin-bottom: 6px;"><strong>Category:</strong> <span style="text-transform: capitalize; color: #a78bfa;">${card.category}</span></div>
                  <div><strong>Priority:</strong> <span style="text-transform: capitalize; color: ${getPriorityColor(card.priority)};">${card.priority}</span></div>
                </div>
              </div>
              
              <!-- HomeOps Analysis Section -->
              <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                <div style="font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                  <i data-lucide="brain-circuit" style="width: 18px; height: 18px; color: #a78bfa;"></i>
                  HomeOps Intelligence Analysis
                </div>
                <div style="font-size: 14px; line-height: 1.4; color: rgba(255,255,255,0.9);">${card.full_analysis}</div>
              </div>
              
              <!-- Action Items Section -->
              ${card.action_items && card.action_items.length > 0 ? `
                <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                  <div style="font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                    <i data-lucide="check-square" style="width: 18px; height: 18px; color: #22c55e;"></i>
                    Recommended Actions
                  </div>
                  <div style="font-size: 13px; color: rgba(255,255,255,0.8);">
                    ${card.action_items.map(item => `<div style="margin-bottom: 4px;">â€¢ ${item}</div>`).join('')}
                  </div>
                </div>
              ` : ''}
              
              <!-- Intelligence Scoring Section -->
              <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                <div style="font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                  <i data-lucide="gauge" style="width: 18px; height: 18px; color: #f59e0b;"></i>
                  Intelligence Metrics
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px;">
                  <div>
                    <span style="color: rgba(255,255,255,0.7);">Manipulation Score:</span>
                    <div style="font-weight: 600; color: ${card.manipulation_score <= 3 ? '#22c55e' : card.manipulation_score <= 6 ? '#f59e0b' : '#ef4444'};">
                      ${card.manipulation_score}/10
                    </div>
                  </div>
                  ${card.personalized_score !== undefined ? `
                    <div>
                      <span style="color: rgba(255,255,255,0.7);">Personal Relevance:</span>
                      <div style="font-weight: 600; color: #a78bfa;">
                        ${Math.round(card.personalized_score * 100)}%
                      </div>
                    </div>
                  ` : ''}
                </div>
              </div>
              
              <!-- Calendar Events Section -->
              ${card.calendar_events ? `
                <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                  <div style="font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                    <i data-lucide="calendar" style="width: 18px; height: 18px; color: #8b5cf6;"></i>
                    Calendar Events Detected
                  </div>
                  <div style="font-size: 13px; color: rgba(255,255,255,0.9);">
                    ${card.calendar_events}
                  </div>
                </div>
              ` : ''}
              
              <!-- Quick Actions -->
              <div style="display: flex; gap: 8px; margin-top: 12px;">
                <button onclick="openInGmail('${card.gmail_url}')" 
                        style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 6px; padding: 10px; background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.4); border-radius: 6px; color: white; font-size: 12px; cursor: pointer;">
                  <i data-lucide="external-link" style="width: 14px; height: 14px;"></i>
                  Open in Gmail
                </button>
                ${card.calendar_events ? `
                  <button onclick="addToCalendar('${card.email_id}', '${card.calendar_events}')" 
                          style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 6px; padding: 10px; background: rgba(34, 197, 94, 0.2); border: 1px solid rgba(34, 197, 94, 0.4); border-radius: 6px; color: white; font-size: 12px; cursor: pointer;">
                    <i data-lucide="calendar-plus" style="width: 14px; height: 14px;"></i>
                    Add to Calendar
                  </button>
                ` : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      resultsDiv.innerHTML = cardsHTML;
      
      // Re-render Lucide icons
      lucide.createIcons();
      
      // Setup feedback button event listeners
      setupFeedbackButtons();
    }
    
    // Setup event listeners for feedback buttons
    function setupFeedbackButtons() {
      document.querySelectorAll('.feedback-btn').forEach(button => {
        button.addEventListener('click', function(event) {
          const emailId = this.getAttribute('data-email-id');
          const feedback = this.getAttribute('data-feedback');
          const cardData = this.getAttribute('data-card');
          
          submitFeedback(event, emailId, feedback, cardData);
        });
      });
    }
    
    // Helper functions for DecoderCards
    function getCategoryIcon(category) {
      const icons = {
        'schedule': 'calendar-clock',
        'family': 'users',
        'commerce': 'shopping-cart',
        'work': 'briefcase',
        'priority': 'alert-circle',
        'noise': 'volume-x'
      };
      const iconName = icons[category] || 'mail';
      return `<i data-lucide="${iconName}" style="width: 18px; height: 18px; color: #a78bfa;"></i>`;
    }
    
    function getPriorityColor(priority) {
      const colors = {
        'urgent': '#ef4444',
        'high': '#f97316', 
        'medium': '#eab308',
        'low': '#22c55e'
      };
      return colors[priority.toLowerCase()] || '#6b7280';
    }
    
    // DecoderCard Actions
    function addToCalendar(emailId, eventData) {
      // Parse event data and create calendar event
      const event = parseEventData(eventData);
      if (event) {
        addCalendarEvent(event, 'user@homeops.ai'); // In production, get from auth
      } else {
        alert(`Adding to calendar: ${eventData}`);
      }
    }
    
    function openInGmail(gmailUrl) {
      window.open(gmailUrl, '_blank');
    }
    
    // Calendar Navigation Functions
    let currentMonth = 7; // July (0-indexed would be 6, but we'll use 1-indexed)
    let currentYear = 2025;
    
    function changeMonth(direction) {
      currentMonth += direction;
      if (currentMonth > 12) {
        currentMonth = 1;
        currentYear++;
      } else if (currentMonth < 1) {
        currentMonth = 12;
        currentYear--;
      }
      updateCalendarDisplay();
    }
    
    function updateCalendarDisplay() {
      const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                     'July', 'August', 'September', 'October', 'November', 'December'];
      const monthElement = document.getElementById('current-month');
      if (monthElement) {
        monthElement.innerHTML = `
          <i data-lucide="calendar" style="width: 20px; height: 20px; color: #a78bfa;"></i>
          ${months[currentMonth - 1]} ${currentYear}
        `;
        lucide.createIcons();
      }
      renderCalendarGrid();
    }
    
    function renderCalendarGrid() {
      const calendarDays = document.getElementById('calendar-days');
      if (!calendarDays) return;
      
      // Clear existing days
      calendarDays.innerHTML = '';
      
      // Get first day of month and days in month
      const firstDay = new Date(currentYear, currentMonth - 1, 1).getDay();
      const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
      const today = new Date();
      const isCurrentMonth = currentYear === today.getFullYear() && currentMonth === (today.getMonth() + 1);
      
      // Add empty cells for days before month starts
      for (let i = 0; i < firstDay; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.style.cssText = 'background: rgba(255,255,255,0.05); padding: 8px 4px; text-align: center; font-size: 13px; color: rgba(255,255,255,0.3);';
        calendarDays.appendChild(emptyDay);
      }
      
      // Add days of the month
      for (let day = 1; day <= daysInMonth; day++) {
        const dayElement = document.createElement('div');
        const isToday = isCurrentMonth && day === today.getDate();
        
        dayElement.style.cssText = `
          background: ${isToday ? 'rgba(139, 92, 246, 0.3)' : 'rgba(255,255,255,0.05)'};
          padding: 8px 4px;
          text-align: center;
          font-size: 13px;
          color: ${isToday ? '#ffffff' : 'rgba(255,255,255,0.9)'};
          border: ${isToday ? '1px solid rgba(139, 92, 246, 0.6)' : 'none'};
          cursor: pointer;
          transition: background 0.2s;
        `;
        
        dayElement.textContent = day;
        dayElement.onclick = (event) => {
          event.stopPropagation();
          selectCalendarDay(currentYear, currentMonth, day);
        };
        
        // Add hover effect
        dayElement.onmouseenter = () => {
          if (!isToday) {
            dayElement.style.background = 'rgba(255,255,255,0.1)';
          }
        };
        dayElement.onmouseleave = () => {
          if (!isToday) {
            dayElement.style.background = 'rgba(255,255,255,0.05)';
          }
        };
        
        calendarDays.appendChild(dayElement);
      }
    }
    
    function selectCalendarDay(year, month, day) {
      console.log(`Selected date: ${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`);
      
      // Store selected date globally
      window.selectedCalendarDate = new Date(year, month - 1, day);
      
      // Update UI to show which day is selected
      updateCalendarDaySelection(year, month, day);
      
      // Update today's events to show events for selected day
      updateTodaysEventsForDate(window.selectedCalendarDate);
    }
    
    function updateCalendarDaySelection(year, month, day) {
      // Remove previous selection styling
      const calendarDays = document.getElementById('calendar-days');
      const dayElements = calendarDays.children;
      
      for (let element of dayElements) {
        if (element.textContent && !isNaN(element.textContent)) {
          const isToday = new Date().getFullYear() === year && 
                         new Date().getMonth() === month - 1 && 
                         new Date().getDate() === parseInt(element.textContent);
          
          if (isToday) {
            element.style.background = 'rgba(139, 92, 246, 0.3)';
            element.style.border = '1px solid rgba(139, 92, 246, 0.6)';
          } else if (parseInt(element.textContent) === day) {
            element.style.background = 'rgba(34, 197, 94, 0.3)';
            element.style.border = '1px solid rgba(34, 197, 94, 0.6)';
          } else {
            element.style.background = 'rgba(255,255,255,0.05)';
            element.style.border = 'none';
          }
        }
      }
    }
    
    async function updateTodaysEventsForDate(selectedDate) {
      try {
        const events = await loadCalendarEvents('user@homeops.ai');
        const selectedDateStr = selectedDate.toDateString();
        
        // Filter events for selected date
        const dayEvents = events.filter(event => {
          const eventDate = new Date(event.start);
          return eventDate.toDateString() === selectedDateStr;
        });
        
        // Update the events list
        const todayEventsList = document.getElementById('today-events-list');
        
        if (dayEvents.length === 0) {
          todayEventsList.innerHTML = `
            <div style="text-align: center; padding: 20px; color: rgba(255,255,255,0.7);">
              <i data-lucide="calendar-x" style="width: 32px; height: 32px; margin-bottom: 8px;"></i>
              <div>No events for this date</div>
              <div style="font-size: 12px; margin-top: 4px;">Add an event using the templates below</div>
            </div>
          `;
        } else {
          todayEventsList.innerHTML = dayEvents.map(event => {
            const eventTime = new Date(event.start).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const iconMap = {
              'work': 'briefcase',
              'medical': 'stethoscope', 
              'travel': 'plane',
              'self-care': 'heart',
              'family': 'users',
              'logistics': 'clipboard-list'
            };
            
            return `
              <div class="event-item" onclick="handleEventClick(event, '${event.id}');" style="cursor: pointer; position: relative;">
                <div class="event-title" style="display: flex; align-items: center; gap: 8px;">
                  <i data-lucide="${iconMap[event.category] || 'calendar'}" style="width: 16px; height: 16px;"></i>
                  ${event.title}
                </div>
                <div class="event-time" style="font-size: 12px; color: rgba(255,255,255,0.8);">
                  ${eventTime} â€¢ ${event.category}
                </div>
                ${event.emotionalTags && event.emotionalTags.length > 0 ? `
                  <div style="margin-top: 6px;">
                    ${event.emotionalTags.map(tag => `
                      <span style="background: rgba(139, 92, 246, 0.3); padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-right: 4px;">
                        ${tag}
                      </span>
                    `).join('')}
                  </div>
                ` : ''}
                <div style="margin-top: 6px; display: flex; align-items: center; gap: 4px; font-size: 11px; color: rgba(255,255,255,0.6);">
                  <i data-lucide="brain-circuit" style="width: 12px; height: 12px;"></i>
                  AI Enhanced
                </div>
                <button onclick="handleDeleteClick(event, '${event.id}');" style="
                  position: absolute;
                  top: 8px;
                  right: 8px;
                  background: rgba(239, 68, 68, 0.3);
                  border: 1px solid rgba(239, 68, 68, 0.6);
                  border-radius: 4px;
                  padding: 4px;
                  color: white;
                  cursor: pointer;
                  font-size: 10px;
                  opacity: 0.7;
                " onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">
                  <i data-lucide="x" style="width: 10px; height: 10px;"></i>
                </button>
              </div>
            `;
          }).join('');
        }
        
        // Update section title to show selected date
        const isToday = selectedDate.toDateString() === new Date().toDateString();
        const dateTitle = isToday ? "Today's Smart Events" : `Events for ${selectedDate.toLocaleDateString('en-US', {month: 'short', day: 'numeric'})}`;
        
        const titleElement = document.querySelector('.today-events .section-title') || 
                           document.querySelector('.today-events div[style*="font-weight: 600"]');
        if (titleElement) {
          titleElement.innerHTML = `
            <i data-lucide="calendar-days"></i>
            ${dateTitle}
          `;
        }
        
        lucide.createIcons();
        
      } catch (error) {
        console.error('Error updating events for date:', error);
      }
    }
    
    // Handle event click with proper event stopping
    function handleEventClick(clickEvent, eventId) {
      clickEvent.stopPropagation();
      clickEvent.preventDefault();
      showEventDetails(eventId);
    }
    
    // Handle delete click with proper event stopping
    function handleDeleteClick(clickEvent, eventId) {
      clickEvent.stopPropagation();
      clickEvent.preventDefault();
      deleteEvent(eventId);
    }
    
    function showEventDetails(eventId) {
      // Prevent this from bubbling up and triggering navigation
      event?.stopPropagation();
      
      console.log('Show details for event:', eventId);
      
      // Create a beautiful in-app modal instead of browser alert
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 2000;
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(10px);
      `;
      
      modal.innerHTML = `
        <div style="
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          border-radius: 20px;
          padding: 24px;
          max-width: 320px;
          width: 90%;
          color: white;
          border: 1px solid rgba(255, 255, 255, 0.2);
          box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        ">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
            <i data-lucide="brain-circuit" style="width: 24px; height: 24px; color: #a78bfa;"></i>
            <div style="font-weight: 700; font-size: 18px;">AI Event Analysis</div>
          </div>
          
          <div style="margin-bottom: 16px; padding: 12px; background: rgba(255, 255, 255, 0.1); border-radius: 12px;">
            <div style="font-size: 12px; color: rgba(255, 255, 255, 0.7); margin-bottom: 4px;">Event ID</div>
            <div style="font-family: monospace; font-size: 11px; word-break: break-all;">${eventId}</div>
          </div>
          
          <div style="margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
              <i data-lucide="brain" style="width: 16px; height: 16px; color: #fbbf24;"></i>
              <div style="font-weight: 600;">Emotional Impact Analysis</div>
            </div>
            <div style="background: rgba(251, 191, 36, 0.2); border: 1px solid rgba(251, 191, 36, 0.4); border-radius: 8px; padding: 10px; font-size: 14px;">
              This event may require focus and mental preparation. Based on your calendar patterns, similar events typically need planning time.
            </div>
          </div>
          
          <div style="margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
              <i data-lucide="lightbulb" style="width: 16px; height: 16px; color: #22c55e;"></i>
              <div style="font-weight: 600;">AI Suggestions</div>
            </div>
            <div style="space-y: 8px;">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                <i data-lucide="clock" style="width: 12px; height: 12px; color: #3b82f6;"></i>
                <span style="font-size: 13px;">Block 15 min before for preparation</span>
              </div>
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                <i data-lucide="bell" style="width: 12px; height: 12px; color: #3b82f6;"></i>
                <span style="font-size: 13px;">Set a reminder 1 hour prior</span>
              </div>
              <div style="display: flex; align-items: center; gap: 8px;">
                <i data-lucide="battery" style="width: 12px; height: 12px; color: #3b82f6;"></i>
                <span style="font-size: 13px;">Consider your energy levels for this time</span>
              </div>
            </div>
          </div>
          
          <button onclick="this.closest('[style*=\"position: fixed\"]').remove()" style="
            width: 100%;
            background: rgba(139, 92, 246, 0.3);
            border: 1px solid rgba(139, 92, 246, 0.6);
            border-radius: 12px;
            padding: 12px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
          ">
            <i data-lucide="check" style="width: 16px; height: 16px;"></i>
            Got it!
          </button>
        </div>
      `;
      
      document.body.appendChild(modal);
      lucide.createIcons();
      
      // Close on backdrop click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      });
    }
    
    // Delete event function
    async function deleteEvent(eventId) {
      // Show in-app confirmation instead of browser confirm
      showDeleteConfirmation(eventId);
    }
    
    // Show delete confirmation modal
    function showDeleteConfirmation(eventId) {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 2000;
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(10px);
      `;
      
      modal.innerHTML = `
        <div style="
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          border-radius: 20px;
          padding: 24px;
          max-width: 320px;
          width: 90%;
          color: white;
          border: 1px solid rgba(255, 255, 255, 0.2);
          box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        ">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
            <i data-lucide="trash-2" style="width: 24px; height: 24px; color: #ef4444;"></i>
            <div style="font-weight: 700; font-size: 18px;">Delete Event</div>
          </div>
          
          <div style="margin-bottom: 20px; color: rgba(255, 255, 255, 0.9);">
            Are you sure you want to delete this event? This action cannot be undone.
          </div>
          
          <div style="display: flex; gap: 12px;">
            <button onclick="this.closest('[style*=\"position: fixed\"]').remove()" style="
              flex: 1;
              background: rgba(255, 255, 255, 0.1);
              border: 1px solid rgba(255, 255, 255, 0.3);
              border-radius: 12px;
              padding: 12px;
              color: white;
              font-weight: 600;
              cursor: pointer;
            ">
              Cancel
            </button>
            <button onclick="confirmDeleteEvent('${eventId}')" style="
              flex: 1;
              background: rgba(239, 68, 68, 0.3);
              border: 1px solid rgba(239, 68, 68, 0.6);
              border-radius: 12px;
              padding: 12px;
              color: white;
              font-weight: 600;
              cursor: pointer;
            ">
              Delete
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      lucide.createIcons();
    }
    
    // Confirm delete event
    async function confirmDeleteEvent(eventId) {
      // Close modal
      document.querySelector('[style*="position: fixed"]')?.remove();
      
      try {
        // Try to delete from server first
        const response = await fetch(`/api/calendar-events/${eventId}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
        });
        
        if (response.ok) {
          console.log('âœ… Event deleted from server');
        } else {
          console.log('âš ï¸ Server delete failed, removing from localStorage');
        }
      } catch (error) {
        console.log('âš ï¸ Server unavailable, removing from localStorage');
      }
      
      // Always remove from localStorage as fallback
      const existingEvents = JSON.parse(localStorage.getItem('homeops_calendar_events') || '[]');
      const updatedEvents = existingEvents.filter(event => event.id !== eventId);
      localStorage.setItem('homeops_calendar_events', JSON.stringify(updatedEvents));
      
      // Show delete notification
      showDeleteNotification();
      
      // Refresh calendar
      await renderSmartCalendar();
    }
    
    // Show delete notification
    function showDeleteNotification() {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 80px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(239, 68, 68, 0.95);
        color: white;
        padding: 16px 20px;
        border-radius: 12px;
        z-index: 1000;
        font-weight: 600;
        border: 1px solid rgba(239, 68, 68, 0.6);
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        max-width: 320px;
        text-align: center;
      `;
      
      notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 8px; justify-content: center;">
          <i data-lucide="trash-2" style="width: 18px; height: 18px;"></i>
          <div style="font-size: 14px;">Event deleted</div>
        </div>
      `;
      
      document.body.appendChild(notification);
      lucide.createIcons();
      
      // Animate in
      notification.style.transform = 'translateX(-50%) translateY(-20px)';
      notification.style.opacity = '0';
      setTimeout(() => {
        notification.style.transition = 'all 0.3s ease';
        notification.style.transform = 'translateX(-50%) translateY(0)';
        notification.style.opacity = '1';
      }, 10);
      
      // Animate out and remove
      setTimeout(() => {
        notification.style.transform = 'translateX(-50%) translateY(-20px)';
        notification.style.opacity = '0';
        setTimeout(() => notification.remove(), 300);
      }, 2000);
    }
    
    // Quick Event Templates
    async function addQuickEvent(eventType) {
      event?.stopPropagation(); // Prevent event bubbling
      
      // Create in-app modal instead of browser prompt
      showEventCreationModal(eventType);
    }
    
    // Show event creation modal
    function showEventCreationModal(eventType) {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 2000;
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(20px);
        animation: modalFadeIn 0.3s ease-out;
      `;
      
      const eventIcons = {
        'meeting': 'users',
        'appointment': 'stethoscope',
        'travel': 'plane',
        'personal': 'heart'
      };
      
      const eventColors = {
        'meeting': '#3b82f6',
        'appointment': '#a855f7',
        'travel': '#22c55e',
        'personal': '#f59e0b'
      };
      
      modal.innerHTML = `
        <style>
          @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
          }
          @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
          }
          .modal-content {
            animation: slideUp 0.4s ease-out;
          }
          .smart-input {
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
          }
          .smart-input:focus {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.3);
          }
          .ai-suggestion {
            animation: slideUp 0.5s ease-out;
            transition: all 0.2s ease;
          }
          .ai-suggestion:hover {
            transform: translateX(4px);
            background: rgba(139, 92, 246, 0.15) !important;
          }
        </style>
        
        <div class="modal-content" style="
          background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #1e40af 100%);
          border-radius: 24px;
          padding: 32px;
          max-width: 420px;
          width: 90%;
          color: white;
          border: 1px solid rgba(255, 255, 255, 0.1);
          box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
          position: relative;
          overflow: hidden;
        ">
          <!-- Animated background gradient -->
          <div style="
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.1) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
            pointer-events: none;
          "></div>
          
          <style>
            @keyframes rotate {
              from { transform: rotate(0deg); }
              to { transform: rotate(360deg); }
            }
          </style>
          
          <!-- Header with dynamic icon -->
          <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px; position: relative;">
            <div style="
              background: linear-gradient(135deg, ${eventColors[eventType]}, ${eventColors[eventType]}80);
              padding: 12px;
              border-radius: 16px;
              box-shadow: 0 8px 20px ${eventColors[eventType]}40;
            ">
              <i data-lucide="${eventIcons[eventType]}" style="width: 28px; height: 28px; color: white;"></i>
            </div>
            <div>
              <div style="font-weight: 700; font-size: 22px; background: linear-gradient(135deg, #ffffff, #e2e8f0); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                Create ${eventType.charAt(0).toUpperCase() + eventType.slice(1)}
              </div>
              <div style="font-size: 14px; color: rgba(255, 255, 255, 0.7); margin-top: 4px;">
                AI-enhanced scheduling
              </div>
            </div>
          </div>
          
          <!-- Smart Title Input -->
          <div style="margin-bottom: 20px; position: relative;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: rgba(255, 255, 255, 0.9);">
              <i data-lucide="edit-3" style="width: 14px; height: 14px; margin-right: 6px;"></i>
              Event Title
            </label>
            <input id="event-title" type="text" placeholder="What's this ${eventType} about?" style="
              width: 100%;
              padding: 16px 20px;
              border-radius: 12px;
              border: 1px solid rgba(255, 255, 255, 0.2);
              background: rgba(255, 255, 255, 0.1);
              color: white;
              font-size: 16px;
              box-sizing: border-box;
              backdrop-filter: blur(10px);
            " class="smart-input" />
            
            <!-- AI Title Suggestions -->
            <div id="title-suggestions" style="margin-top: 8px; display: none;">
              <div style="font-size: 12px; color: rgba(255, 255, 255, 0.6); margin-bottom: 6px;">
                <i data-lucide="sparkles" style="width: 12px; height: 12px; margin-right: 4px;"></i>
                AI Suggestions
              </div>
            </div>
          </div>
          
          <!-- Smart Time Input with Quick Options -->
          <div style="margin-bottom: 24px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: rgba(255, 255, 255, 0.9);">
              <i data-lucide="clock" style="width: 14px; height: 14px; margin-right: 6px;"></i>
              When?
            </label>
            <input id="event-time" type="text" placeholder="Try 'tomorrow 2pm', 'in 1 hour', 'Friday 9am'..." style="
              width: 100%;
              padding: 16px 20px;
              border-radius: 12px;
              border: 1px solid rgba(255, 255, 255, 0.2);
              background: rgba(255, 255, 255, 0.1);
              color: white;
              font-size: 16px;
              box-sizing: border-box;
              backdrop-filter: blur(10px);
            " class="smart-input" />
            
            <!-- Quick Time Options -->
            <div style="display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap;">
              <button onclick="setQuickTime('in 1 hour')" style="
                background: rgba(59, 130, 246, 0.2);
                border: 1px solid rgba(59, 130, 246, 0.4);
                border-radius: 8px;
                padding: 6px 12px;
                color: white;
                font-size: 12px;
                cursor: pointer;
                transition: all 0.2s ease;
              " onmouseover="this.style.background='rgba(59, 130, 246, 0.3)'" onmouseout="this.style.background='rgba(59, 130, 246, 0.2)'">
                In 1 hour
              </button>
              <button onclick="setQuickTime('tomorrow 9am')" style="
                background: rgba(34, 197, 94, 0.2);
                border: 1px solid rgba(34, 197, 94, 0.4);
                border-radius: 8px;
                padding: 6px 12px;
                color: white;
                font-size: 12px;
                cursor: pointer;
                transition: all 0.2s ease;
              " onmouseover="this.style.background='rgba(34, 197, 94, 0.3)'" onmouseout="this.style.background='rgba(34, 197, 94, 0.2)'">
                Tomorrow 9am
              </button>
              <button onclick="setQuickTime('next Monday 2pm')" style="
                background: rgba(168, 85, 247, 0.2);
                border: 1px solid rgba(168, 85, 247, 0.4);
                border-radius: 8px;
                padding: 6px 12px;
                color: white;
                font-size: 12px;
                cursor: pointer;
                transition: all 0.2s ease;
              " onmouseover="this.style.background='rgba(168, 85, 247, 0.3)'" onmouseout="this.style.background='rgba(168, 85, 247, 0.2)'">
                Next Mon 2pm
              </button>
            </div>
          </div>
          
          <!-- AI Insights Preview -->
          <div style="
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(59, 130, 246, 0.1));
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
          ">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
              <i data-lucide="brain-circuit" style="width: 16px; height: 16px; color: #a78bfa;"></i>
              <span style="font-weight: 600; font-size: 14px;">AI Preview</span>
            </div>
            <div id="ai-preview" style="font-size: 13px; color: rgba(255, 255, 255, 0.8);">
              This ${eventType} will be optimized for your calendar patterns and energy levels.
            </div>
          </div>
          
          <!-- Action Buttons -->
          <div style="display: flex; gap: 16px;">
            <button onclick="this.closest('[style*=\"position: fixed\"]').remove()" style="
              flex: 1;
              background: rgba(255, 255, 255, 0.1);
              border: 1px solid rgba(255, 255, 255, 0.2);
              border-radius: 12px;
              padding: 16px;
              color: white;
              font-weight: 600;
              cursor: pointer;
              transition: all 0.3s ease;
              backdrop-filter: blur(10px);
            " onmouseover="this.style.background='rgba(255, 255, 255, 0.15)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.1)'">
              Cancel
            </button>
            <button onclick="createEventFromModal('${eventType}')" style="
              flex: 2;
              background: linear-gradient(135deg, ${eventColors[eventType]}, ${eventColors[eventType]}cc);
              border: 1px solid ${eventColors[eventType]};
              border-radius: 12px;
              padding: 16px;
              color: white;
              font-weight: 600;
              cursor: pointer;
              transition: all 0.3s ease;
              box-shadow: 0 8px 20px ${eventColors[eventType]}40;
            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 12px 25px ${eventColors[eventType]}60'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 20px ${eventColors[eventType]}40'">
              <i data-lucide="calendar-plus" style="width: 16px; height: 16px; margin-right: 8px;"></i>
              Create Event
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      lucide.createIcons();
      
      // Enhanced input handling
      const titleInput = document.getElementById('event-title');
      const timeInput = document.getElementById('event-time');
      
      // Focus on title input with delay for animation
      setTimeout(() => {
        if (titleInput) {
          titleInput.focus();
          setupSmartTitleSuggestions(titleInput, eventType);
        }
        if (timeInput) {
          setupSmartTimeHandling(timeInput);
        }
      }, 200);
      
      // Close on backdrop click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      });
      
      // Keyboard shortcuts
      document.addEventListener('keydown', function handleModalKeys(e) {
        if (e.key === 'Escape') {
          modal.remove();
          document.removeEventListener('keydown', handleModalKeys);
        }
        if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) {
          createEventFromModal(eventType);
          document.removeEventListener('keydown', handleModalKeys);
        }
      });
    }
    
    // Set quick time options
    function setQuickTime(timeText) {
      const timeInput = document.getElementById('event-time');
      if (timeInput) {
        timeInput.value = timeText;
        timeInput.focus();
        updateAIPreview();
      }
    }
    
    // Setup smart title suggestions
    function setupSmartTitleSuggestions(input, eventType) {
      const suggestions = {
        'meeting': ['Team Standup', 'Project Review', 'Client Call', 'Strategy Session', '1:1 Check-in'],
        'appointment': ['Doctor Visit', 'Dentist Checkup', 'Therapy Session', 'Consultation', 'Health Screening'],
        'travel': ['Flight to NYC', 'Road Trip', 'Business Travel', 'Weekend Getaway', 'Conference Trip'],
        'personal': ['Workout', 'Meditation', 'Reading Time', 'Family Dinner', 'Self Care']
      };
      
      input.addEventListener('input', () => {
        const suggestionsDiv = document.getElementById('title-suggestions');
        const value = input.value.toLowerCase();
        
        if (value.length > 0) {
          const matching = suggestions[eventType].filter(s => 
            s.toLowerCase().includes(value) || value.length < 2
          ).slice(0, 3);
          
          if (matching.length > 0) {
            suggestionsDiv.style.display = 'block';
            suggestionsDiv.innerHTML = `
              <div style="font-size: 12px; color: rgba(255, 255, 255, 0.6); margin-bottom: 6px;">
                <i data-lucide="sparkles" style="width: 12px; height: 12px; margin-right: 4px;"></i>
                AI Suggestions
              </div>
              ${matching.map(suggestion => `
                <div class="ai-suggestion" onclick="selectSuggestion('${suggestion}')" style="
                  background: rgba(139, 92, 246, 0.1);
                  border: 1px solid rgba(139, 92, 246, 0.2);
                  border-radius: 6px;
                  padding: 8px 12px;
                  margin: 4px 0;
                  cursor: pointer;
                  font-size: 13px;
                ">
                  ${suggestion}
                </div>
              `).join('')}
            `;
          } else {
            suggestionsDiv.style.display = 'none';
          }
        } else {
          suggestionsDiv.style.display = 'none';
        }
        
        updateAIPreview();
      });
    }
    
    // Select suggestion
    function selectSuggestion(suggestion) {
      const titleInput = document.getElementById('event-title');
      if (titleInput) {
        titleInput.value = suggestion;
        document.getElementById('title-suggestions').style.display = 'none';
        updateAIPreview();
      }
    }
    
    // Setup smart time handling
    function setupSmartTimeHandling(input) {
      input.addEventListener('input', updateAIPreview);
    }
    
    // Update AI preview
    function updateAIPreview() {
      const titleInput = document.getElementById('event-title');
      const timeInput = document.getElementById('event-time');
      const previewDiv = document.getElementById('ai-preview');
      
      if (!previewDiv) return;
      
      const title = titleInput?.value || '';
      const time = timeInput?.value || '';
      
      let preview = '';
      
      if (title && time) {
        preview = `âœ¨ "${title}" scheduled for ${time}. AI suggests 15min prep buffer and will optimize for your energy patterns.`;
      } else if (title) {
        preview = `ðŸ“ "${title}" detected. Add timing for smart scheduling recommendations.`;
      } else if (time) {
        preview = `â° Time set for ${time}. Add event details for personalized AI insights.`;
      } else {
        preview = 'AI will analyze your calendar patterns and suggest optimal timing and preparation strategies.';
      }
      
      previewDiv.textContent = preview;
    }
    
    // Create event from modal with enhanced AI
    async function createEventFromModal(eventType) {
      const titleInput = document.getElementById('event-title');
      const timeInput = document.getElementById('event-time');
      
      const title = titleInput?.value?.trim();
      const timeText = timeInput?.value?.trim();
      
      if (!title) {
        // Enhanced error handling with shake animation
        titleInput.style.animation = 'shake 0.5s ease-in-out';
        titleInput.style.borderColor = '#ef4444';
        setTimeout(() => {
          titleInput.style.animation = '';
          titleInput.style.borderColor = 'rgba(255, 255, 255, 0.2)';
        }, 500);
        return;
      }
      
      // Show processing state
      const modal = titleInput.closest('[style*="position: fixed"]');
      const createBtn = modal.querySelector('button[onclick*="createEventFromModal"]');
      const originalText = createBtn.innerHTML;
      createBtn.innerHTML = '<i data-lucide="loader" style="width: 16px; height: 16px; margin-right: 8px; animation: spin 1s linear infinite;"></i>Creating...';
      createBtn.disabled = true;
      
      try {
        // Enhanced time parsing with AI
        let eventDate = new Date();
        let timeSpecified = false;
        
        if (timeText) {
          const parsedTime = parseSmartTimeInput(timeText);
          if (parsedTime) {
            eventDate = parsedTime;
            timeSpecified = true;
          }
        }
        
        const eventTemplates = {
          'meeting': {
            category: 'work',
            emotionalTags: ['focus-time', 'collaborative'],
            duration: 60,
            insights: 'Work meetings benefit from 10-15 minutes of prep time',
            color: '#3b82f6'
          },
          'appointment': {
            category: 'medical',
            emotionalTags: ['routine-care', 'self-investment'],
            duration: 30,
            insights: 'Medical appointments are investments in your health and wellbeing',
            color: '#a855f7'
          },
          'travel': {
            category: 'travel',
            emotionalTags: ['adventure', 'logistics'],
            duration: 120,
            insights: 'Travel events often need buffer time and preparation checklist',
            color: '#22c55e'
          },
          'personal': {
            category: 'self-care',
            emotionalTags: ['recharge', 'mindful'],
            duration: 60,
            insights: 'Personal time blocks help maintain work-life balance and mental health',
            color: '#f59e0b'
          }
        };
        
        const template = eventTemplates[eventType];
        const event = {
          id: Date.now().toString(),
          title: title,
          date: eventDate.toISOString().split('T')[0],
          time: timeSpecified ? eventDate.toTimeString().substring(0, 5) : null,
          type: eventType,
          originalTimeInput: timeText,
          created: new Date().toISOString(),
          aiEnhanced: true,
          emotionalLoad: calculateEmotionalLoad(eventType, title),
          smartSuggestions: generateSmartSuggestions(eventType, title, timeText),
          ...template,
          start: eventDate.toISOString(),
          end: new Date(eventDate.getTime() + template.duration * 60000).toISOString(),
          source: 'smart-quick-add',
          gptGenerated: false
        };
        
        // Store locally with enhanced data
        const events = JSON.parse(localStorage.getItem('calendar-events') || '[]');
        events.push(event);
        localStorage.setItem('calendar-events', JSON.stringify(events));
        
        // Try to sync with server with AI analysis
        try {
          const response = await fetch('/api/calendar-events', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              ...event,
              aiAnalysis: await getAIEventAnalysis(event)
            })
          });
          
          if (response.ok) {
            const result = await response.json();
            console.log('Event created with AI insights:', result);
          }
        } catch (error) {
          console.log('Offline mode: Event saved locally with AI enhancement');
        }
        
        // Show success animation
        createBtn.innerHTML = '<i data-lucide="check" style="width: 16px; height: 16px; margin-right: 8px; color: #22c55e;"></i>Created!';
        createBtn.style.background = 'linear-gradient(135deg, #22c55e, #16a34a)';
        
        setTimeout(() => {
          modal.remove();
          populateCalendarGrid(); // Refresh calendar
          showSuccessToast(`${title} added to your calendar with AI optimization!`);
        }, 800);
        
      } catch (error) {
        console.error('Error creating event:', error);
        createBtn.innerHTML = originalText;
        createBtn.disabled = false;
        showErrorToast('Failed to create event. Please try again.');
      }
    }
    
    // Enhanced time parsing with natural language
    function parseSmartTimeInput(timeText) {
      const now = new Date();
      const text = timeText.toLowerCase().trim();
      
      // Handle relative times
      if (text.includes('in ')) {
        const match = text.match(/in (\d+) (hour|hours|minute|minutes|min)/);
        if (match) {
          const amount = parseInt(match[1]);
          const unit = match[2];
          const result = new Date(now);
          
          if (unit.startsWith('hour')) {
            result.setHours(result.getHours() + amount);
          } else {
            result.setMinutes(result.getMinutes() + amount);
          }
          return result;
        }
      }
      
      // Handle tomorrow
      if (text.includes('tomorrow')) {
        const tomorrow = new Date(now);
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        const timeMatch = text.match(/(\d{1,2})(:\d{2})?\s*(am|pm)?/);
        if (timeMatch) {
          let hour = parseInt(timeMatch[1]);
          const minute = timeMatch[2] ? parseInt(timeMatch[2].substring(1)) : 0;
          const period = timeMatch[3];
          
          if (period === 'pm' && hour !== 12) hour += 12;
          if (period === 'am' && hour === 12) hour = 0;
          
          tomorrow.setHours(hour, minute, 0, 0);
        } else {
          tomorrow.setHours(9, 0, 0, 0); // Default to 9am
        }
        return tomorrow;
      }
      
      // Handle next Monday, Tuesday, etc.
      const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
      const dayMatch = text.match(/next (monday|tuesday|wednesday|thursday|friday|saturday|sunday)/);
      if (dayMatch) {
        const targetDay = days.indexOf(dayMatch[1]);
        const result = new Date(now);
        const currentDay = result.getDay();
        const daysUntilTarget = (targetDay - currentDay + 7) % 7 || 7;
        result.setDate(result.getDate() + daysUntilTarget);
        
        const timeMatch = text.match(/(\d{1,2})(:\d{2})?\s*(am|pm)?/);
        if (timeMatch) {
          let hour = parseInt(timeMatch[1]);
          const minute = timeMatch[2] ? parseInt(timeMatch[2].substring(1)) : 0;
          const period = timeMatch[3];
          
          if (period === 'pm' && hour !== 12) hour += 12;
          if (period === 'am' && hour === 12) hour = 0;
          
          result.setHours(hour, minute, 0, 0);
        } else {
          result.setHours(14, 0, 0, 0); // Default to 2pm
        }
        return result;
      }
      
      // Handle today with time
      if (text.includes('today') || text.match(/^\d{1,2}/)) {
        const timeMatch = text.match(/(\d{1,2})(:\d{2})?\s*(am|pm)?/);
        if (timeMatch) {
          let hour = parseInt(timeMatch[1]);
          const minute = timeMatch[2] ? parseInt(timeMatch[2].substring(1)) : 0;
          const period = timeMatch[3];
          
          if (period === 'pm' && hour !== 12) hour += 12;
          if (period === 'am' && hour === 12) hour = 0;
          
          const result = new Date(now);
          result.setHours(hour, minute, 0, 0);
          return result;
        }
      }
      
      return null;
    }
    
    // Calculate emotional load for events
    function calculateEmotionalLoad(eventType, title) {
      const stressors = ['meeting', 'appointment', 'deadline', 'interview', 'presentation'];
      const relaxers = ['vacation', 'personal', 'break', 'lunch', 'exercise'];
      
      const titleLower = title.toLowerCase();
      let load = 5; // neutral
      
      if (stressors.some(word => titleLower.includes(word))) load += 2;
      if (relaxers.some(word => titleLower.includes(word))) load -= 2;
      
      switch (eventType) {
        case 'meeting': load += 1; break;
        case 'appointment': load += 1; break;
        case 'personal': load -= 1; break;
        case 'travel': load += 0.5; break;
      }
      
      return Math.max(1, Math.min(10, load));
    }
    
    // Generate smart suggestions
    function generateSmartSuggestions(eventType, title, timeText) {
      const suggestions = [];
      
      // Add prep time suggestions
      if (eventType === 'meeting') {
        suggestions.push('ðŸ’¡ Consider adding 15min prep buffer');
      }
      
      if (eventType === 'appointment') {
        suggestions.push('ðŸš— Factor in travel time');
      }
      
      if (timeText && timeText.includes('morning')) {
        suggestions.push('â˜• Schedule before coffee break for peak focus');
      }
      
      return suggestions;
    }
    
    // Get AI event analysis
    async function getAIEventAnalysis(event) {
      // This would normally call your AI service
      return {
        energyOptimal: event.time ? isOptimalEnergyTime(event.time) : null,
        conflictRisk: 'low',
        preparationSuggestions: event.smartSuggestions,
        emotionalImpact: event.emotionalLoad > 6 ? 'high-stress' : 'manageable'
      };
    }
    
    // Check if time is optimal for energy
    function isOptimalEnergyTime(timeString) {
      const hour = parseInt(timeString.split(':')[0]);
      return (hour >= 9 && hour <= 11) || (hour >= 14 && hour <= 16);
    }
    
    // Enhanced toast notifications
    function showSuccessToast(message) {
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #22c55e, #16a34a);
        color: white;
        padding: 16px 20px;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(34, 197, 94, 0.3);
        z-index: 3000;
        animation: slideInRight 0.3s ease-out;
        border: 1px solid rgba(255, 255, 255, 0.2);
      `;
      
      toast.innerHTML = `
        <div style="display: flex; align-items: center; gap: 8px;">
          <i data-lucide="check-circle" style="width: 20px; height: 20px;"></i>
          <span>${message}</span>
        </div>
      `;
      
      document.body.appendChild(toast);
      lucide.createIcons();
      
      setTimeout(() => {
        toast.style.animation = 'slideOutRight 0.3s ease-in';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
    
    function showErrorToast(message) {
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
        padding: 16px 20px;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(239, 68, 68, 0.3);
        z-index: 3000;
        animation: slideInRight 0.3s ease-out;
        border: 1px solid rgba(255, 255, 255, 0.2);
      `;
      
      toast.innerHTML = `
        <div style="display: flex; align-items: center; gap: 8px;">
          <i data-lucide="alert-circle" style="width: 20px; height: 20px;"></i>
          <span>${message}</span>
        </div>
      `;
      
      document.body.appendChild(toast);
      lucide.createIcons();
      
      setTimeout(() => {
        toast.style.animation = 'slideOutRight 0.3s ease-in';
        setTimeout(() => toast.remove(), 300);
      }, 4000);
    }
    
    // Smart Event Creation with AI Assistant
    async function addSmartEventMobile() {
      // Create a simple prompt-based event creator
      const eventTitle = prompt('What event would you like to add?');
      if (!eventTitle) return;
      
      const eventTime = prompt('When? (e.g., "2pm tomorrow", "in 1 hour", or leave blank for now)');
      
      // Parse the time input or default to now
      let eventStart = new Date();
      if (eventTime) {
        // Simple time parsing (could be enhanced with a proper date parsing library)
        const now = new Date();
        const timeText = eventTime.toLowerCase();
        
        if (timeText.includes('tomorrow')) {
          eventStart = new Date(now.getTime() + 24 * 60 * 60 * 1000);
          const timeMatch = timeText.match(/(\d+)(am|pm)/);
          if (timeMatch) {
            let hour = parseInt(timeMatch[1]);
            if (timeMatch[2] === 'pm' && hour !== 12) hour += 12;
            if (timeMatch[2] === 'am' && hour === 12) hour = 0;
            eventStart.setHours(hour, 0, 0, 0);
          }
        } else if (timeText.includes('hour')) {
          const hourMatch = timeText.match(/(\d+)\s*hour/);
          if (hourMatch) {
            eventStart = new Date(now.getTime() + parseInt(hourMatch[1]) * 60 * 60 * 1000);
          }
        }
      }
      
      // Determine category based on keywords
      let category = 'personal';
      const titleLower = eventTitle.toLowerCase();
      if (titleLower.includes('meeting') || titleLower.includes('work') || titleLower.includes('call')) {
        category = 'work';
      } else if (titleLower.includes('doctor') || titleLower.includes('appointment') || titleLower.includes('dentist')) {
        category = 'medical';
      } else if (titleLower.includes('travel') || titleLower.includes('flight') || titleLower.includes('trip')) {
        category = 'travel';
      } else if (titleLower.includes('family') || titleLower.includes('kids') || titleLower.includes('school')) {
        category = 'family';
      }
      
      // Create the event
      const event = {
        title: eventTitle,
        category: category,
        emotionalTags: ['user-created'],
        duration: 60, // Default 1 hour
        start: eventStart.toISOString(),
        end: new Date(eventStart.getTime() + 60 * 60 * 1000).toISOString(),
        source: 'smart-add-mobile',
        gptGenerated: true,
        description: `Smart event created via mobile interface`
      };
      
      await addCalendarEvent(event, 'user@homeops.ai');
    }
    
    // Gmail Calendar Sync (placeholder for now)
    function syncWithGmailCalendar() {
      console.log('Syncing with Gmail Calendar...');
      // TODO: Implement Gmail Calendar API integration
      alert('Gmail Calendar sync feature coming soon!');
    }
    
    function expandCard(emailId) {
      const expandedDiv = document.getElementById(`expanded-${emailId}`);
      if (expandedDiv) {
        expandedDiv.style.display = expandedDiv.style.display === 'none' ? 'block' : 'none';
      }
    }
    
    async function submitFeedback(event, emailId, feedback, cardData) {
      try {
        // Parse card data if it's a string
        const card = typeof cardData === 'string' ? JSON.parse(cardData) : cardData;
        
        const response = await fetch('/api/email-feedback', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            email_id: emailId, 
            feedback: feedback,
            user_email: 'user@homeops.ai', // In production, get from auth
            
            // Include email metadata for learning
            category: card?.category,
            priority: card?.priority,
            sender: card?.sender,
            subject: card?.subject,
            manipulation_score: card?.manipulation_score
          })
        });
        
        const data = await response.json();
        if (data.success) {
          // Visual feedback with Lucide icons
          const button = event.target.closest('button');
          const icon = button.querySelector('[data-lucide]');
          const originalIcon = icon.getAttribute('data-lucide');
          
          // Update icon to show feedback
          icon.setAttribute('data-lucide', feedback === 'positive' ? 'check-circle' : 'x-circle');
          lucide.createIcons(); // Re-render icons
          
          // Show learning insights if available
          if (data.analytics && data.analytics.learning_status) {
            showLearningUpdate(data.analytics);
          }
          
          // Restore original icon after 2 seconds
          setTimeout(() => {
            icon.setAttribute('data-lucide', originalIcon);
            lucide.createIcons();
          }, 2000);
        }
      } catch (error) {
        console.error('Error submitting feedback:', error);
      }
    }
    
    // Show learning update notification
    function showLearningUpdate(analytics) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(139, 92, 246, 0.9);
        color: white;
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 14px;
        z-index: 1000;
        max-width: 300px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      `;
      
      notification.innerHTML = `
        <div style="font-weight: 600; margin-bottom: 4px; display: flex; align-items: center; gap: 6px;">
          <i data-lucide="brain-circuit" style="width: 16px; height: 16px;"></i>
          Learning Update
        </div>
        <div style="font-size: 12px;">${analytics.learning_status}</div>
        <div style="font-size: 11px; margin-top: 4px; opacity: 0.8;">
          ${analytics.total_feedback} feedback items â€¢ ${analytics.accuracy_rate}% accuracy
        </div>
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 4000);
    }
    
    // Update the Connect Gmail button to load DecoderCards
    function connectGmail() {
      window.location.href = '/auth/gmail';
    }
    
    // Enhanced Gmail connection for mobile that loads cards
    function connectGmailMobile() {
      connectGmail();
    }
    
    // Auto-load DecoderCards when email view is shown
    function showEmailCategory(category, button) {
      // Update active button
      document.querySelectorAll('.category-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      button.classList.add('active');
      
      // Load decoder cards if not already loaded
      if (category === 'all') {
        loadDecoderCards();
      }
    }
    
    // Demo DecoderCard for testing
    function loadDemoDecoderCard() {
      const demoCard = {
        summary: "Golf operations at Bethesda Country Club are delayed due to rain. The Father-Son Championship starts at noon.",
        category: "schedule",
        priority: "medium",
        action_items: ["Add to Calendar", "Check weather", "Confirm participation"],
        full_analysis: "This rain delay affects your weekend golf plans and requires immediate attention. While general operations are delayed until 5:30 PM, the Father-Son Championship maintains its noon start time, creating a scheduling conflict awareness need. The club is prioritizing their signature tournament over general play, which suggests this is a significant event worth attending. Weather dependency indicates you should monitor conditions and have backup indoor plans. As a family-oriented event, this aligns with your priority categories for weekend activities that involve quality time and relationship building.",
        email_id: "demo123",
        timestamp: new Date().toISOString(),
        time_ago: "2h ago",
        gmail_url: "https://mail.google.com/mail/u/0/#inbox/demo123",
        sender: "Bethesda Country Club <info@bethesdacc.com>",
        subject: "Golf Operations Update - Rain Delay",
        calendar_events: "Father-Son Championship | Today | 12:00 PM",
        manipulation_score: 2,
        personalized_score: 0.85,
        confidence: 0.92
      };
      
      displayDecoderCards([demoCard]);
    }
    
    // Update the sample email test to show DecoderCard
    async function testSampleEmail() {
      loadDemoDecoderCard();
    }
    
    // ===== CALENDAR INTELLIGENCE SYSTEM =====
    
    // Parse event data from email decoder
    function parseEventData(eventData) {
      if (!eventData || typeof eventData !== 'string') return null;
      
      // Example: "Father-Son Championship | Today | 12:00 PM"
      const parts = eventData.split(' | ');
      if (parts.length < 2) return null;
      
      const title = parts[0].trim();
      const dateStr = parts[1].trim();
      const timeStr = parts[2] ? parts[2].trim() : '12:00 PM';
      
      // Parse date
      let eventDate = new Date();
      if (dateStr.toLowerCase() === 'today') {
        // Use today
      } else if (dateStr.toLowerCase() === 'tomorrow') {
        eventDate.setDate(eventDate.getDate() + 1);
      } else {
        // Try to parse other date formats
        const parsed = new Date(dateStr);
        if (!isNaN(parsed.getTime())) {
          eventDate = parsed;
        }
      }
      
      // Parse time
      const timeMatch = timeStr.match(/(\d{1,2}):?(\d{0,2})?\s*(AM|PM)?/i);
      if (timeMatch) {
        let hours = parseInt(timeMatch[1]);
        const minutes = parseInt(timeMatch[2] || '0');
        const ampm = timeMatch[3];
        
        if (ampm && ampm.toUpperCase() === 'PM' && hours !== 12) {
          hours += 12;
        } else if (ampm && ampm.toUpperCase() === 'AM' && hours === 12) {
          hours = 0;
        }
        
        eventDate.setHours(hours, minutes, 0, 0);
      }
      
      // Detect emotional context and category from title
      const emotionalContext = detectEmotionalContext(title);
      const category = detectEventCategory(title);
      
      return {
        title: title,
        start: eventDate.toISOString(),
        end: new Date(eventDate.getTime() + 2 * 60 * 60 * 1000).toISOString(), // Default 2 hours
        category: category,
        source: 'email-decoder',
        emotionalTags: emotionalContext.tags,
        reframe: emotionalContext.reframe,
        tips: emotionalContext.tips,
        gptGenerated: false
      };
    }
    
    // Detect emotional context from event title
    function detectEmotionalContext(title) {
      const titleLower = title.toLowerCase();
      
      // Stress indicators
      if (titleLower.includes('deadline') || titleLower.includes('urgent') || titleLower.includes('due')) {
        return {
          tags: ['stress', 'deadline-pressure'],
          reframe: 'This deadline can be managed with focused time blocks. Break it into smaller tasks.',
          tips: ['Set 25-minute focus sessions', 'Prepare materials the night before', 'Build in buffer time']
        };
      }
      
      // Medical/health
      if (titleLower.includes('doctor') || titleLower.includes('appointment') || titleLower.includes('medical')) {
        return {
          tags: ['health-focus', 'planning-required'],
          reframe: 'Taking care of health is an investment in your family\'s long-term well-being.',
          tips: ['Prepare questions in advance', 'Bring insurance cards', 'Schedule follow-up if needed']
        };
      }
      
      // School/children
      if (titleLower.includes('school') || titleLower.includes('parent') || titleLower.includes('teacher')) {
        return {
          tags: ['family-coordination', 'parental-load'],
          reframe: 'Your involvement in your child\'s education creates lasting positive impact.',
          tips: ['Review child\'s recent work beforehand', 'Prepare specific questions', 'Block time for follow-up actions']
        };
      }
      
      // Social/relationship
      if (titleLower.includes('dinner') || titleLower.includes('party') || titleLower.includes('gathering')) {
        return {
          tags: ['social-connection', 'relationship-investment'],
          reframe: 'Social connections are essential for family mental health and support networks.',
          tips: ['Plan conversation starters', 'Set realistic expectations', 'Focus on quality connections']
        };
      }
      
      // Travel/logistics
      if (titleLower.includes('travel') || titleLower.includes('trip') || titleLower.includes('flight')) {
        return {
          tags: ['logistics', 'coordination-intensive'],
          reframe: 'Travel creates valuable family memories and experiences worth the coordination effort.',
          tips: ['Create packing lists 48 hours early', 'Confirm all reservations', 'Plan for unexpected delays']
        };
      }
      
      // Default positive framing
      return {
        tags: ['routine', 'manageable'],
        reframe: 'This event fits well into your family\'s rhythm and priorities.',
        tips: ['Add to your calendar', 'Set a reminder if needed']
      };
    }
    
    // Detect event category
    function detectEventCategory(title) {
      const titleLower = title.toLowerCase();
      
      if (titleLower.includes('school') || titleLower.includes('teacher') || titleLower.includes('homework')) return 'school';
      if (titleLower.includes('doctor') || titleLower.includes('medical') || titleLower.includes('appointment')) return 'medical';
      if (titleLower.includes('work') || titleLower.includes('meeting') || titleLower.includes('office')) return 'work';
      if (titleLower.includes('travel') || titleLower.includes('flight') || titleLower.includes('trip')) return 'travel';
      if (titleLower.includes('birthday') || titleLower.includes('party') || titleLower.includes('celebration')) return 'family';
      if (titleLower.includes('grocery') || titleLower.includes('shopping') || titleLower.includes('errands')) return 'logistics';
      
      return 'personal';
    }
    
    // Add calendar event to system
    async function addCalendarEvent(eventObj, userId) {
      try {
        // Validate event structure
        const requiredFields = ['title', 'start', 'category', 'source'];
        for (const field of requiredFields) {
          if (!eventObj[field]) {
            console.error(`Missing required field: ${field}`);
            return false;
          }
        }
        
        // Add default end time if not provided
        if (!eventObj.end) {
          const startTime = new Date(eventObj.start);
          eventObj.end = new Date(startTime.getTime() + 60 * 60 * 1000).toISOString(); // Default 1 hour
        }
        
        // Send to backend API
        const response = await fetch('/api/calendar-events', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            event: eventObj,
            userId: userId
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          console.log('âœ… Calendar event added:', data.event);
          
          // Refresh calendar display
          await renderSmartCalendar();
          showEventAddedNotification(data.event);
          
          return true;
        } else {
          console.error('Failed to add calendar event:', data.message);
          return false;
        }
        
      } catch (error) {
        console.error('Error adding calendar event:', error);
        
        // Fallback to localStorage for offline functionality
        const existingEvents = JSON.parse(localStorage.getItem('homeops_calendar_events') || '[]');
        eventObj.id = `event_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        eventObj.userId = userId;
        eventObj.createdAt = new Date().toISOString();
        existingEvents.push(eventObj);
        localStorage.setItem('homeops_calendar_events', JSON.stringify(existingEvents));
        
        console.log('âœ… Calendar event added (offline mode):', eventObj);
        await renderSmartCalendar();
        showEventAddedNotification(eventObj);
        
        return true;
      }
    }
    
    // Load calendar events for user
    async function loadCalendarEvents(userId) {
      try {
        const response = await fetch(`/api/calendar-events/${userId}`);
        const data = await response.json();
        
        if (data.success) {
          return data.events;
        } else {
          console.error('Failed to load calendar events:', data.message);
          // Fallback to localStorage
          const events = JSON.parse(localStorage.getItem('homeops_calendar_events') || '[]');
          return events.filter(event => event.userId === userId);
        }
      } catch (error) {
        console.error('Error loading calendar events:', error);
        // Fallback to localStorage
        const events = JSON.parse(localStorage.getItem('homeops_calendar_events') || '[]');
        return events.filter(event => event.userId === userId);
      }
    }
    
    // Get upcoming emotional load forecast
    async function getUpcomingEmotionalLoad(userId) {
      try {
        const response = await fetch(`/api/emotional-load-forecast/${userId}`);
        const data = await response.json();
        
        if (data.success) {
          return data.forecast;
        } else {
          console.error('Failed to get emotional load forecast:', data.message);
          // Fallback to local calculation
          return calculateLocalEmotionalLoad(userId);
        }
      } catch (error) {
        console.error('Error getting emotional load forecast:', error);
        return calculateLocalEmotionalLoad(userId);
      }
    }
    
    // Fallback local emotional load calculation
    function calculateLocalEmotionalLoad(userId) {
      const events = JSON.parse(localStorage.getItem('homeops_calendar_events') || '[]')
        .filter(event => event.userId === userId);
      
      const now = new Date();
      const weekFromNow = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
      
      const upcomingEvents = events.filter(event => {
        const eventDate = new Date(event.start);
        return eventDate >= now && eventDate <= weekFromNow;
      });
      
      // Group by emotional tags
      const emotionalLoad = {};
      upcomingEvents.forEach(event => {
        if (event.emotionalTags) {
          event.emotionalTags.forEach(tag => {
            if (!emotionalLoad[tag]) {
              emotionalLoad[tag] = [];
            }
            emotionalLoad[tag].push(event);
          });
        }
      });
      
      return {
        totalEvents: upcomingEvents.length,
        emotionalBreakdown: emotionalLoad,
        events: upcomingEvents.sort((a, b) => new Date(a.start) - new Date(b.start))
      };
    }
    
    // Show notification when event is added
    function showEventAddedNotification(event) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 80px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(34, 197, 94, 0.95);
        color: white;
        padding: 16px 20px;
        border-radius: 12px;
        z-index: 1000;
        font-weight: 600;
        border: 1px solid rgba(34, 197, 94, 0.6);
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        max-width: 320px;
        text-align: center;
      `;
      
      const eventTime = new Date(event.start).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      const insight = event.insights || 'AI is analyzing this event for optimal scheduling';
      
      notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 8px; justify-content: center; margin-bottom: 8px;">
          <i data-lucide="calendar-check" style="width: 18px; height: 18px;"></i>
          <div>
            <div style="font-size: 14px;">${event.title} added</div>
            <div style="font-size: 12px; opacity: 0.9;">for ${eventTime}</div>
          </div>
        </div>
        <div style="font-size: 11px; opacity: 0.8; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 8px;">
          ðŸ’¡ ${insight}
        </div>
      `;
      
      document.body.appendChild(notification);
      lucide.createIcons();
      
      // Animate in
      notification.style.transform = 'translateX(-50%) translateY(-20px)';
      notification.style.opacity = '0';
      setTimeout(() => {
        notification.style.transition = 'all 0.3s ease';
        notification.style.transform = 'translateX(-50%) translateY(0)';
        notification.style.opacity = '1';
      }, 10);
      
      // Animate out and remove
      setTimeout(() => {
        notification.style.transform = 'translateX(-50%) translateY(-20px)';
        notification.style.opacity = '0';
        setTimeout(() => notification.remove(), 300);
      }, 3500);
    }
    
    // ===== END CALENDAR INTELLIGENCE SYSTEM =====
    
    // Initialize app on load
    document.addEventListener('DOMContentLoaded', async function() {
      // Initialize Lucide icons
      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
      }
      
      // Initialize calendar system
      updateCalendarDisplay();
      await renderSmartCalendar();
      
      // Initialize default view (without event since this is programmatic)
      showView('chat-mobile', document.querySelector('.nav-btn.active'), null);
      
      // Initialize textarea auto-resize
      const chatInput = document.getElementById('chatInput');
      if (chatInput) {
        chatInput.addEventListener('input', function() {
          this.style.height = 'auto';
          this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
        
        chatInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });
      }
    });

    // Initialize Lucide icons
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }
  </script>
</body>
</html>
// Static deployment fixes applied Tue Jul 22 11:30:38 EDT 2025
// API fixes committed Tue Jul 22 11:34:13 EDT 2025
