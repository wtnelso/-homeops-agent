<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>HomeOps - Mobile</title>
  
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  
  <!-- Mobile-First CSS -->
  <style>
    /* MOBILE-FIRST RESET */
    :root {
      --vh: 1vh;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      height: 100vh;
      /* iOS viewport units fix */
      height: 100dvh;
      overflow: hidden;
      touch-action: manipulation;
      /* Prevent zoom on input focus */
      -webkit-text-size-adjust: 100%;
    }
    
    /* MOBILE APP LAYOUT */
    .mobile-app {
      height: 100vh;
      height: calc(var(--vh, 1vh) * 100); /* Use custom property for iOS */
      display: flex;
      flex-direction: column;
      position: relative;
    }
    
    /* TOP HEADER */
    .mobile-header {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      min-height: 60px;
    }
    
    .logo {
      font-size: 24px;
      font-weight: 700;
      color: white;
    }
    
    /* MAIN CONTENT AREA */
    .mobile-content {
      flex: 1;
      overflow: hidden;
      position: relative;
      /* Add padding for fixed navigation */
      padding-bottom: 90px;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      height: 100vh;
      /* iOS viewport units fix */
      height: 100dvh;
      overflow: hidden;
      touch-action: manipulation;
      /* Prevent zoom on input focus */
      -webkit-text-size-adjust: 100%;
      /* Default bottom padding for navigation */
      padding-bottom: 90px;
    }
    
    .mobile-view {
      display: none;
      height: 100%;
      padding: 20px;
      overflow-y: auto;
    }
    
    .mobile-view.active {
      display: block !important;
    }
    
    /* BOTTOM NAVIGATION */
    .mobile-nav {
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(20px);
      display: flex;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      padding: 8px 0;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      min-height: 70px;
      /* iOS safe area handling */
      padding-bottom: max(8px, env(safe-area-inset-bottom));
      /* Smooth transitions */
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      /* Ensure proper stacking */
      box-shadow: 0 -2px 20px rgba(0, 0, 0, 0.2);
    }
    
    .mobile-nav.keyboard-open {
      transform: translateY(100%);
      opacity: 0;
      pointer-events: none;
    }
    
    .nav-btn {
      flex: 1;
      background: none;
      border: none;
      color: #666;
      padding: 12px 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      min-height: 60px;
    }
    
    .nav-btn.active {
      color: #fff;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      margin: 4px;
    }
    
    .nav-btn:active {
      transform: scale(0.95);
      background: rgba(255, 255, 255, 0.1);
    }
    
    .nav-icon {
      width: 24px;
      height: 24px;
      margin-bottom: 2px;
    }
    
    /* CHAT VIEW */
    #chat-mobile {
      display: flex;
      flex-direction: column;
      height: 100%;
      /* Ensure proper spacing with fixed nav */
      padding-bottom: 10px;
    }
    
    .chat-messages-mobile {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      margin-bottom: 16px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      /* Ensure scrollable area doesn't get cut off */
      min-height: 200px;
      max-height: calc(100vh - 280px);
    }
    
    .chat-input-mobile {
      display: flex;
      gap: 12px;
      align-items: center;
      /* Ensure input area is always visible */
      position: sticky;
      bottom: 0;
      background: inherit;
      padding-top: 8px;
    }
    
    .mobile-input {
      flex: 1;
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 25px;
      padding: 12px 16px;
      color: white;
      font-size: 16px;
      outline: none;
    }
    
    .mobile-input::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }
    
    .mobile-input:focus {
      border-color: rgba(255, 255, 255, 0.4);
      background: rgba(255, 255, 255, 0.2);
    }
    
    .send-btn {
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      width: 48px;
      height: 48px;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    
    .send-btn:active {
      transform: scale(0.95);
      background: rgba(255, 255, 255, 0.4);
    }
    
    /* EMAIL DECODER VIEW */
    .email-section {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 16px;
    }
    
    .section-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #fff;
    }
    
    .mobile-textarea {
      width: 100%;
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      padding: 16px;
      color: white;
      font-size: 16px;
      min-height: 120px;
      resize: vertical;
      outline: none;
      font-family: inherit;
    }
    
    .mobile-textarea::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }
    
    .mobile-textarea:focus {
      border-color: rgba(255, 255, 255, 0.4);
      background: rgba(255, 255, 255, 0.15);
    }
    
    .decode-btn-mobile {
      width: 100%;
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      padding: 16px;
      color: white;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 16px;
      transition: all 0.2s;
    }
    
    .decode-btn-mobile:active {
      transform: scale(0.98);
      background: rgba(255, 255, 255, 0.4);
    }
    
    /* CALENDAR VIEW */
    .calendar-section {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 16px;
    }
    
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .month-nav {
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      padding: 8px 12px;
      color: white;
      cursor: pointer;
    }
    
    .events-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .event-item {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 16px;
      border-left: 4px solid rgba(255, 255, 255, 0.6);
    }
    
    .event-item:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-1px);
    }
    
    .event-title {
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .event-time {
      color: #888;
      font-size: 14px;
    }
    
    /* LOADING STATE */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 40px;
      color: #666;
    }
    
    /* SUCCESS/ERROR STATES */
    .success {
      background: rgba(5, 150, 105, 0.3);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(5, 150, 105, 0.5);
      border-radius: 8px;
      padding: 12px 16px;
      margin: 12px 0;
      font-size: 14px;
    }
    
    .error {
      background: rgba(220, 38, 38, 0.3);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(220, 38, 38, 0.5);
      border-radius: 8px;
      padding: 12px 16px;
      margin: 12px 0;
      font-size: 14px;
    }
    
    /* MOBILE EMAIL INTELLIGENCE STYLES */
    .intel-tab {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 25px;
      padding: 8px 12px;
      color: rgba(255, 255, 255, 0.7);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .intel-tab.active {
      background: rgba(255, 255, 255, 0.3);
      color: white;
      border-color: rgba(255, 255, 255, 0.4);
      transform: scale(1.05);
    }
    
    .translated-emails-mobile {
      max-height: 400px;
      overflow-y: auto;
    }
    
    .email-insight-card {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }
    
    .email-insight-card:active {
      transform: scale(0.98);
      background: rgba(255, 255, 255, 0.15);
    }
    
    .insight-priority {
      position: absolute;
      top: 12px;
      right: 12px;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }
    
    .priority-high {
      background: rgba(239, 68, 68, 0.3);
      color: #fca5a5;
    }
    
    .priority-medium {
      background: rgba(251, 191, 36, 0.3);
      color: #fcd34d;
    }
    
    .priority-low {
      background: rgba(34, 197, 94, 0.3);
      color: #86efac;
    }
    
    .ai-translation {
      background: rgba(139, 92, 246, 0.2);
      border-left: 3px solid rgba(139, 92, 246, 0.8);
      border-radius: 8px;
      padding: 12px;
      margin: 12px 0;
      font-style: italic;
      color: rgba(255, 255, 255, 0.9);
    }
    
    .commerce-intel {
      background: rgba(16, 185, 129, 0.2);
      border-left: 3px solid rgba(16, 185, 129, 0.8);
      border-radius: 8px;
      padding: 12px;
      margin: 12px 0;
    }
    
    .brand-loyalty {
      display: inline-block;
      background: rgba(59, 130, 246, 0.3);
      color: #93c5fd;
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 11px;
      margin-right: 4px;
    }
    
    .email-subject {
      font-weight: 600;
      margin-bottom: 8px;
      color: white;
      font-size: 16px;
    }
    
    .email-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.6);
      margin-bottom: 12px;
    }
    
    .email-category {
      background: rgba(255, 255, 255, 0.2);
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
    }
    
    .email-preview {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.8);
      line-height: 1.4;
    }
    
    /* CALENDAR STYLES */
    .day-header {
      background: rgba(255, 255, 255, 0.2);
      color: rgba(255, 255, 255, 0.8);
      text-align: center;
      padding: 12px 4px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .calendar-day {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .calendar-day:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    
    .calendar-day.today {
      background: rgba(255, 255, 255, 0.3);
      font-weight: bold;
      color: #fff;
    }
    
    .calendar-day.other-month {
      color: rgba(255, 255, 255, 0.3);
    }
    
    .calendar-day.has-events {
      background: rgba(255, 255, 255, 0.2);
      position: relative;
    }
    
    .calendar-day.has-events::after {
      content: '';
      position: absolute;
      bottom: 2px;
      left: 50%;
      transform: translateX(-50%);
      width: 4px;
      height: 4px;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 50%;
    }
    
    .today-events {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 16px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    /* TYPING ANIMATION */
    .typing-dots {
      display: inline-flex;
      gap: 2px;
    }
    
    .typing-dots span {
      animation: typing 1.4s infinite;
      animation-fill-mode: both;
    }
    
    .typing-dots span:nth-child(2) {
      animation-delay: 0.2s;
    }
    
    .typing-dots span:nth-child(3) {
      animation-delay: 0.4s;
    }
    
    @keyframes typing {
      0%, 60%, 100% {
        transform: translateY(0);
        opacity: 0.4;
      }
      30% {
        transform: translateY(-10px);
        opacity: 1;
      }
    }
  </style>
</head>
<body>
  <div class="mobile-app">
    <!-- Header -->
    <div class="mobile-header">
      <div class="logo">HomeOps</div>
      <div style="font-size: 14px; color: rgba(255,255,255,0.8);">Works!</div>
    </div>
    
    <!-- Content Area -->
    <div class="mobile-content">
      <!-- Chat View -->
      <div id="chat-mobile" class="mobile-view active">
        <div class="chat-messages-mobile">
          <div style="padding: 20px; text-align: center; color: rgba(255,255,255,0.8);">
            <div style="display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 16px;">
              <i data-lucide="brain-circuit" style="width: 28px; height: 28px;"></i>
              <strong style="font-size: 18px;">Your Mental Load Operating System</strong>
            </div>
            
            <div style="margin-bottom: 20px; font-size: 14px; line-height: 1.5;">
              I'm your <strong>Life Intelligence AI</strong> ‚Äî built to turn the invisible mental load of modern parenting into visible, actionable clarity.
            </div>
            
            <div style="background: rgba(255,255,255,0.1); padding: 16px; border-radius: 12px; margin-bottom: 20px; text-align: left;">
              <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 6px;">
                <i data-lucide="zap" style="width: 16px; height: 16px;"></i>
                I can delegate these tasks for you:
              </div>
              <div style="font-size: 13px; line-height: 1.6;">
                <div style="margin: 4px 0;"><i data-lucide="calendar-plus" style="width: 12px; height: 12px; margin-right: 6px;"></i><strong>Calendar:</strong> "Add Lucy's dentist Thursday at 2pm"</div>
                <div style="margin: 4px 0;"><i data-lucide="mail-search" style="width: 12px; height: 12px; margin-right: 6px;"></i><strong>Inbox Intel:</strong> "What's urgent in my emails?"</div>
                <div style="margin: 4px 0;"><i data-lucide="tag" style="width: 12px; height: 12px; margin-right: 6px;"></i><strong>Deal Radar:</strong> "Any good deals I should know about?"</div>
                <div style="margin: 4px 0;"><i data-lucide="check-square" style="width: 12px; height: 12px; margin-right: 6px;"></i><strong>Task Memory:</strong> "Remind me to RSVP to that birthday party"</div>
                <div style="margin: 4px 0;"><i data-lucide="plane" style="width: 12px; height: 12px; margin-right: 6px;"></i><strong>Trip Planning:</strong> "Help me organize our weekend getaway"</div>
                <div style="margin: 4px 0;"><i data-lucide="shopping-cart" style="width: 12px; height: 12px; margin-right: 6px;"></i><strong>Smart Shopping:</strong> "What's coming from Amazon?"</div>
              </div>
            </div>
            
            <div style="background: rgba(34, 197, 94, 0.2); padding: 12px; border-radius: 8px; margin-bottom: 16px; border: 1px solid rgba(34, 197, 94, 0.3);">
              <div style="font-size: 12px; display: flex; align-items: center; justify-content: center; gap: 6px;">
                <i data-lucide="heart" style="width: 14px; height: 14px;"></i>
                <em>Built for busy parents who need to see their life clearly and feel in control again</em>
              </div>
            </div>
            
            <div style="font-size: 13px; color: rgba(255,255,255,0.7);">
              Just type naturally ‚Äî I understand context and execute actions, not just empathize.
            </div>
          </div>
        </div>
        <div class="chat-input-mobile">
          <input type="text" class="mobile-input" placeholder="Type your message..." id="chatInput">
          <button class="send-btn" onclick="sendMessage()">
            <i data-lucide="send" style="width: 20px; height: 20px;"></i>
          </button>
        </div>
      </div>
      
      <!-- Email Decoder View -->
      <div id="email-mobile" class="mobile-view">
        <!-- AI Chief of Staff Header -->
        <div class="chief-of-staff-header" style="background: rgba(255,255,255,0.15); border-radius: 20px; padding: 20px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.2);">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <div style="width: 48px; height: 48px; background: rgba(255,255,255,0.3); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px;">üß†</div>
            <div>
              <div style="font-weight: 700; font-size: 18px;">Your AI Chief of Staff</div>
              <div style="font-size: 14px; color: rgba(255,255,255,0.8);">Translating noise into clarity</div>
            </div>
          </div>
          <div id="chief-insights" style="font-style: italic; color: rgba(255,255,255,0.9); line-height: 1.4;">
            "I'm scanning your inbox right now. Let me surface what actually matters to your family and work life."
          </div>
        </div>

        <!-- Gmail Connection Status -->
        <div id="gmail-status" class="email-section">
          <div class="section-title">üìß Inbox Intelligence Engine</div>
          <div id="connection-status" style="padding: 16px; border-radius: 12px; margin-bottom: 16px; background: rgba(255,193,7,0.2); border: 1px solid rgba(255,193,7,0.3);">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
              <div class="typing-dots">
                <span>.</span><span>.</span><span>.</span>
              </div>
              <span>Checking Gmail connection...</span>
            </div>
          </div>
          
          <!-- Connect Gmail Button -->
          <button id="connect-gmail-mobile" class="decode-btn-mobile" onclick="connectGmailMobile()" style="display: none;">
            <i data-lucide="mail-plus" style="width: 20px; height: 20px; margin-right: 8px;"></i>
            Connect Gmail to Start Intelligence
          </button>
          
          <!-- Process Emails Button -->
          <button id="process-emails-mobile" class="decode-btn-mobile" onclick="processEmailsMobile()" style="display: none;">
            <i data-lucide="brain-circuit" style="width: 20px; height: 20px; margin-right: 8px;"></i>
            Scan & Translate Latest Emails
          </button>
          
          <!-- Intelligence Categories -->
          <div id="email-categories" style="display: none;">
            <div class="intelligence-tabs" style="display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap;">
              <button class="intel-tab active" data-category="all" onclick="showIntelCategory('all', this)">
                <span>üìã</span> All Insights
              </button>
              <button class="intel-tab" data-category="urgent" onclick="showIntelCategory('urgent', this)">
                <span>‚ö°</span> Urgent
              </button>
              <button class="intel-tab" data-category="family" onclick="showIntelCategory('family', this)">
                <span>üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span> Family
              </button>
              <button class="intel-tab" data-category="commerce" onclick="showIntelCategory('commerce', this)">
                <span>üõçÔ∏è</span> Commerce Intel
              </button>
              <button class="intel-tab" data-category="schedule" onclick="showIntelCategory('schedule', this)">
                <span>üìÖ</span> Schedule
              </button>
            </div>
            
            <!-- AI-Translated Emails -->
            <div id="translated-emails-mobile" class="translated-emails-mobile">
              <!-- Dynamic content goes here -->
            </div>
          </div>
          
          <!-- Processing Status -->
          <div id="processing-status" style="display: none; text-align: center; padding: 20px;">
            <div class="typing-dots" style="margin-bottom: 10px;">
              <span>.</span><span>.</span><span>.</span>
            </div>
            <div id="processing-message">Your AI Chief of Staff is reading...</div>
          </div>
        </div>
      </div>
      
      <!-- Calendar View -->
      <div id="calendar-mobile" class="mobile-view">
        <div class="calendar-section">
          <div class="calendar-header">
            <button class="month-nav" onclick="changeMonth(-1)">‚Äπ</button>
            <div class="section-title" id="current-month">üìÖ July 2025</div>
            <button class="month-nav" onclick="changeMonth(1)">‚Ä∫</button>
          </div>
          
          <!-- Calendar Grid -->
          <div class="calendar-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: rgba(255,255,255,0.1); border-radius: 12px; overflow: hidden; margin-bottom: 20px;">
            <!-- Day headers -->
            <div class="day-header">S</div>
            <div class="day-header">M</div>
            <div class="day-header">T</div>
            <div class="day-header">W</div>
            <div class="day-header">T</div>
            <div class="day-header">F</div>
            <div class="day-header">S</div>
            
            <!-- Calendar days (will be populated by JS) -->
            <div id="calendar-days" style="display: contents;">
              <!-- JS will populate calendar days here -->
            </div>
          </div>
          
          <!-- Today's Events -->
          <div class="today-events">
            <div style="font-weight: 600; margin-bottom: 12px; color: #fff;">Today's Schedule</div>
            <div class="events-list" id="today-events-list">
              <div class="event-item" onclick="viewEventDetails('Team Standup', 'Today 2:00 PM - 2:30 PM')" style="cursor: pointer; transition: background 0.2s;">
                <div class="event-title">Team Standup</div>
                <div class="event-time">2:00 PM - 2:30 PM</div>
                <div style="font-size: 11px; color: rgba(255,255,255,0.6); margin-top: 4px;">
                  <i data-lucide="brain" style="width: 10px; height: 10px; margin-right: 4px;"></i>
                  Tap for AI insights
                </div>
              </div>
              <div class="event-item" onclick="viewEventDetails('Pick up groceries', 'Today 5:00 PM')" style="cursor: pointer; transition: background 0.2s;">
                <div class="event-title">Pick up groceries</div>
                <div class="event-time">5:00 PM</div>
                <div style="font-size: 11px; color: rgba(255,255,255,0.6); margin-top: 4px;">
                  <i data-lucide="brain" style="width: 10px; height: 10px; margin-right: 4px;"></i>
                  Tap for AI insights
                </div>
              </div>
            </div>
          </div>
          
          <!-- Add Event Quick Button -->
          <button class="decode-btn-mobile" onclick="addEventMobile()" style="margin-top: 16px;">
            <i data-lucide="plus" style="width: 20px; height: 20px; margin-right: 8px;"></i>
            Quick Add Event
          </button>
        </div>
      </div>
    </div>
    
    <!-- Bottom Navigation -->
    <div class="mobile-nav">
      <button class="nav-btn active" onclick="showView('chat-mobile', this)">
        <i data-lucide="message-circle" class="nav-icon"></i>
        Chat
      </button>
      <button class="nav-btn" onclick="showView('email-mobile', this)">
        <i data-lucide="mail" class="nav-icon"></i>
        Email
      </button>
      <button class="nav-btn" onclick="showView('calendar-mobile', this)">
        <i data-lucide="calendar" class="nav-icon"></i>
        Calendar
      </button>
    </div>
  </div>
  
  <script>
    // Mobile-First JavaScript
    function showView(viewId, button) {
      console.log('Switching to view:', viewId);
      
      // Hide all views immediately
      document.querySelectorAll('.mobile-view').forEach(view => {
        view.classList.remove('active');
        view.style.display = 'none';
      });
      
      // Remove active from all nav buttons
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Show selected view immediately
      const targetView = document.getElementById(viewId);
      if (targetView) {
        targetView.style.display = 'block';
        targetView.classList.add('active');
        
        // Initialize view-specific content
        if (viewId === 'email-mobile') {
          initializeEmailView();
        } else if (viewId === 'calendar-mobile') {
          initializeCalendarView();
        }
      }
      
      button.classList.add('active');
      
      // Haptic feedback
      if (navigator.vibrate) {
        navigator.vibrate(10);
      }
    }
    
    function initializeEmailView() {
      console.log('Initializing email view...');
      if (!document.getElementById('gmail-status').querySelector('.typing-dots')) {
        checkGmailConnection();
      }
    }
    
    function initializeCalendarView() {
      console.log('Initializing calendar view...');
      if (!document.getElementById('calendar-days').innerHTML) {
        renderCalendar();
      }
    }
    
    function sendMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      
      if (!message) return;
      
      const messagesDiv = document.querySelector('.chat-messages-mobile');
      
      // Add user message with better styling
      messagesDiv.innerHTML += `
        <div style="padding: 12px 20px; background: rgba(255,255,255,0.3); backdrop-filter: blur(10px); margin: 8px 0; border-radius: 18px 18px 4px 18px; max-width: 85%; margin-left: auto; border: 1px solid rgba(255,255,255,0.2);">
          ${message}
        </div>
      `;
      
      input.value = '';
      
      // Smart action detection BEFORE sending to AI
      const actionDetected = detectAndExecuteActions(message);
      
      if (!actionDetected) {
        // Add typing indicator
        messagesDiv.innerHTML += `
          <div id="typing-indicator" style="padding: 12px 20px; background: rgba(255,255,255,0.1); margin: 8px 0; border-radius: 18px 18px 18px 4px; max-width: 85%; border: 1px solid rgba(255,255,255,0.1);">
            <div style="display: flex; align-items: center; gap: 8px; color: rgba(255,255,255,0.7);">
              <div class="typing-dots">
                <span>.</span><span>.</span><span>.</span>
              </div>
              HomeOps is thinking...
            </div>
          </div>
        `;
        
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        
        // Call your actual AI backend
        callHomeOpsAI(message).then(response => {
          const typingEl = document.getElementById('typing-indicator');
          if (typingEl) {
            typingEl.innerHTML = response;
            typingEl.style.background = 'rgba(255,255,255,0.1)';
            typingEl.style.color = 'white';
            typingEl.removeAttribute('id');
          }
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
          
          // Initialize Lucide icons after adding new content
          lucide.createIcons();
        }).catch(error => {
          console.error('AI Error:', error);
          const typingEl = document.getElementById('typing-indicator');
          if (typingEl) {
            typingEl.innerHTML = "I'm having trouble connecting right now. Your tone-aware AI model will be back online shortly!";
            typingEl.style.background = 'rgba(255,200,100,0.2)';
            typingEl.removeAttribute('id');
          }
        });
      }
      
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
    
    // Smart action detection and execution
    function detectAndExecuteActions(message) {
      const msg = message.toLowerCase();
      const messagesDiv = document.querySelector('.chat-messages-mobile');
      
      // Enhanced detection patterns
      
      // Calendar injection commands - Enhanced detection
      if ((msg.includes('add') || msg.includes('create') || msg.includes('schedule') || msg.includes('i have') || msg.includes('meeting') || msg.includes('appointment')) && 
          (msg.includes('calendar') || msg.includes('event') || msg.includes('meeting') || msg.includes('at ') || msg.includes('pm') || msg.includes('am')) ||
          (msg.includes('golf') && (msg.includes('tomorrow') || msg.includes('1pm'))) ||
          (msg.includes('sunday') || msg.includes('monday') || msg.includes('tuesday') || msg.includes('wednesday') || msg.includes('thursday') || msg.includes('friday') || msg.includes('saturday')) && (msg.includes('at ') || msg.includes('pm') || msg.includes('am'))) {
        
        executeCalendarInjection(message, messagesDiv);
        return true;
      }
      
      // Calendar viewing/checking commands
      if ((msg.includes('do i have') || msg.includes('what do i have') || msg.includes('whats on my') || msg.includes('check my') || msg.includes('show my')) && 
          (msg.includes('calendar') || msg.includes('schedule') || msg.includes('going on'))) {
        executeCalendarView(messagesDiv);
        return true;
      }
      
      // Task management commands
      if ((msg.includes('remind me') || msg.includes('set reminder') || msg.includes('dont forget')) ||
          (msg.includes('add') && (msg.includes('task') || msg.includes('todo') || msg.includes('reminder')))) {
        executeTaskManagement(message, messagesDiv);
        return true;
      }
      
      // Travel planning commands
      if ((msg.includes('travel') || msg.includes('trip') || msg.includes('vacation') || msg.includes('flight')) && 
          (msg.includes('plan') || msg.includes('book') || msg.includes('need') || msg.includes('help'))) {
        executeTravelPlanning(message, messagesDiv);
        return true;
      }
      
      // Shopping/purchase commands
      if ((msg.includes('buy') || msg.includes('purchase') || msg.includes('order') || msg.includes('need to get')) ||
          (msg.includes('shopping') && (msg.includes('list') || msg.includes('help')))) {
        executeShoppingAssistant(message, messagesDiv);
        return true;
      }
      
      // Contact/communication commands
      if ((msg.includes('call') || msg.includes('text') || msg.includes('email') || msg.includes('contact')) && 
          (msg.includes('remind me') || msg.includes('need to') || msg.includes('should'))) {
        executeCommunicationReminder(message, messagesDiv);
        return true;
      }
      
      // Health/wellness tracking
      if (msg.includes('water') || msg.includes('exercise') || msg.includes('workout') || 
          (msg.includes('track') && (msg.includes('health') || msg.includes('wellness')))) {
        executeWellnessTracking(message, messagesDiv);
        return true;
      }
      
      // Financial tracking
      if ((msg.includes('budget') || msg.includes('expense') || msg.includes('spending')) ||
          (msg.includes('how much') && (msg.includes('spent') || msg.includes('cost')))) {
        executeFinancialTracking(message, messagesDiv);
        return true;
      }
      
      // Deal intelligence (RCS-style)
      if (msg.includes('deals') || msg.includes('offers') || msg.includes('sales') || msg.includes('discounts') || 
          msg.includes('good deal') || msg.includes('bargain') || msg.includes('cheap') || 
          (msg.includes('find') && (msg.includes('deal') || msg.includes('offer')))) {
        executeDealIntelligence(message, messagesDiv);
        return true;
      }
      
      // Email summary functionality
      if (msg.includes('email summary') || msg.includes('recent emails') || msg.includes('inbox summary') || 
          msg.includes('summarize emails') || msg.includes('latest emails') || msg.includes('what emails') ||
          (msg.includes('summary') && msg.includes('email'))) {
        executeEmailSummary(message, messagesDiv);
        return true;
      }
      
      // Email surfacing commands
      if (msg.includes('show') && (msg.includes('email') || msg.includes('urgent') || msg.includes('important'))) {
        executeEmailSurfacing(messagesDiv);
        return true;
      }
      
      // Deal detection commands
      if (msg.includes('deal') || msg.includes('sale') || (msg.includes('find') && msg.includes('buy'))) {
        executeDealDetection(messagesDiv);
        return true;
      }
      
      // Week planning commands
      if (msg.includes('plan') && (msg.includes('week') || msg.includes('today') || msg.includes('tomorrow'))) {
        executeWeekPlanning(messagesDiv);
        return true;
      }
      
      // Navigation shortcuts
      if (msg.includes('switch to') || msg.includes('go to')) {
        if (msg.includes('email')) {
          const emailBtn = document.querySelector('.nav-btn[onclick*="email-mobile"]');
          showView('email-mobile', emailBtn);
          addSystemMessage(messagesDiv, "üìß Switched to Email view");
          return true;
        }
        if (msg.includes('calendar')) {
          const calendarBtn = document.querySelector('.nav-btn[onclick*="calendar-mobile"]');
          showView('calendar-mobile', calendarBtn);
          addSystemMessage(messagesDiv, "üìÖ Switched to Calendar view");
          return true;
        }
      }
      
      return false; // No action detected, proceed with AI
    }
    
    function executeCalendarInjection(message, messagesDiv) {
      const msg = message.toLowerCase();
      let eventDetails = {
        title: 'New Event',
        date: 'Today',
        time: '12:00 PM',
        duration: '1 hour'
      };
      
      // Extract event type
      if (msg.includes('golf')) eventDetails.title = 'Golf';
      else if (msg.includes('meeting')) eventDetails.title = 'Meeting';
      else if (msg.includes('appointment')) eventDetails.title = 'Appointment';
      else if (msg.includes('call')) eventDetails.title = 'Call';
      else if (msg.includes('lunch')) eventDetails.title = 'Lunch';
      else if (msg.includes('dinner')) eventDetails.title = 'Dinner';
      else if (msg.includes('flight')) eventDetails.title = 'Flight';
      else if (msg.includes('conference')) eventDetails.title = 'Conference';
      else if (msg.includes('pickup')) eventDetails.title = 'Pickup';
      else if (msg.includes('dropoff')) eventDetails.title = 'Drop-off';
      else if (msg.includes('doctor')) eventDetails.title = 'Doctor Appointment';
      else if (msg.includes('dentist')) eventDetails.title = 'Dentist Appointment';
      
      // Extract day
      if (msg.includes('sunday')) eventDetails.date = 'Sunday';
      else if (msg.includes('monday')) eventDetails.date = 'Monday';
      else if (msg.includes('tuesday')) eventDetails.date = 'Tuesday';
      else if (msg.includes('wednesday')) eventDetails.date = 'Wednesday';
      else if (msg.includes('thursday')) eventDetails.date = 'Thursday';
      else if (msg.includes('friday')) eventDetails.date = 'Friday';
      else if (msg.includes('saturday')) eventDetails.date = 'Saturday';
      else if (msg.includes('tomorrow')) eventDetails.date = 'Tomorrow';
      else if (msg.includes('today')) eventDetails.date = 'Today';
      
      // Extract time with better patterns
      const timePatterns = [
        /(\d{1,2})\s*pm/i,
        /(\d{1,2})\s*am/i,
        /(\d{1,2}):(\d{2})\s*pm/i,
        /(\d{1,2}):(\d{2})\s*am/i,
        /at\s+(\d{1,2})\s*pm/i,
        /at\s+(\d{1,2})\s*am/i,
        /at\s+(\d{1,2}):(\d{2})\s*pm/i,
        /at\s+(\d{1,2}):(\d{2})\s*am/i
      ];
      
      for (const pattern of timePatterns) {
        const match = message.match(pattern);
        if (match) {
          if (match[2]) {
            // Has minutes
            const hour = parseInt(match[1]);
            const minute = match[2];
            const period = message.toLowerCase().includes('pm') ? 'PM' : 'AM';
            eventDetails.time = `${hour}:${minute} ${period}`;
          } else {
            // Just hour
            const hour = parseInt(match[1]);
            const period = message.toLowerCase().includes('pm') ? 'PM' : 'AM';
            eventDetails.time = `${hour}:00 ${period}`;
          }
          break;
        }
      }
      
      // Smart duration estimation
      if (msg.includes('meeting')) eventDetails.duration = '1 hour';
      else if (msg.includes('golf')) eventDetails.duration = '4 hours';
      else if (msg.includes('lunch') || msg.includes('dinner')) eventDetails.duration = '1.5 hours';
      else if (msg.includes('call')) eventDetails.duration = '30 minutes';
      
      messagesDiv.innerHTML += `
        <div style="background: rgba(34, 197, 94, 0.2); border: 1px solid rgba(34, 197, 94, 0.4); border-radius: 12px; padding: 16px; margin: 12px 0;">
          <div style="font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
            <i data-lucide="calendar-plus" style="width: 20px; height: 20px;"></i>
            <span>Calendar Event Detected</span>
          </div>
          <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 20px;">
            <div style="font-weight: 600; font-size: 16px; margin-bottom: 4px;">${eventDetails.title}</div>
            <div style="font-size: 14px; color: rgba(255,255,255,0.8);">
              üìÖ ${eventDetails.date}<br>
              ‚è∞ ${eventDetails.time}<br>
              ‚åõ Duration: ${eventDetails.duration}
            </div>
          </div>
          <div style="display: flex; gap: 8px; margin-top: 12px;">
            <button onclick="executeCalendarAdd('${eventDetails.title}', '${eventDetails.date}', '${eventDetails.time}')" 
                    style="background: rgba(34, 197, 94, 0.3); border: 1px solid rgba(34, 197, 94, 0.6); border-radius: 8px; padding: 8px 16px; color: white; font-size: 14px; cursor: pointer; flex: 1;">
              <i data-lucide="plus" style="width: 16px; height: 16px; margin-right: 4px;"></i>
              Add to Calendar
            </button>
            <button onclick="editEventDetails('${eventDetails.title}', '${eventDetails.date}', '${eventDetails.time}')" 
                    style="background: rgba(59, 130, 246, 0.3); border: 1px solid rgba(59, 130, 246, 0.6); border-radius: 8px; padding: 8px 16px; color: white; font-size: 14px; cursor: pointer;">
              <i data-lucide="edit" style="width: 16px; height: 16px;"></i>
            </button>
          </div>
        </div>
      `;
      
      // Re-initialize Lucide icons for new content
      setTimeout(() => lucide.createIcons(), 100);
    }
    
    function executeEmailSurfacing(messagesDiv) {
      const urgentEmails = decodedEmails.filter(e => e.priority === 'high').slice(0, 3);
      
      if (urgentEmails.length === 0) {
        addSystemMessage(messagesDiv, "üìß No urgent emails found. Your inbox is under control!");
        return;
      }
      
      messagesDiv.innerHTML += `
        <div style="background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.4); border-radius: 12px; padding: 16px; margin: 12px 0;">
          <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
            <i data-lucide="mail-open" style="width: 20px; height: 20px;"></i>
            <span>Urgent Emails Surfaced</span>
          </div>
          ${urgentEmails.map(email => `
            <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin: 8px 0;">
              <div style="font-weight: 600; font-size: 14px;">${email.subject || 'No Subject'}</div>
              <div style="font-size: 12px; color: rgba(255,255,255,0.7);">${email.sender || 'Unknown'}</div>
              <div style="font-size: 13px; margin-top: 4px;">${email.ai_translation || email.summary || 'No summary available'}</div>
            </div>
          `).join('')}
          <button onclick="showView('email-mobile', document.querySelector('.nav-btn[onclick*=\"email-mobile\"]'))" 
                  style="background: rgba(59, 130, 246, 0.3); border: 1px solid rgba(59, 130, 246, 0.6); border-radius: 8px; padding: 8px 16px; color: white; font-size: 14px; cursor: pointer; margin-top: 8px;">
            <i data-lucide="arrow-right" style="width: 16px; height: 16px; margin-right: 4px;"></i>
            View All Emails
          </button>
        </div>
      `;
    }
    
    function executeDealDetection(messagesDiv) {
      const deals = [
        { item: 'Patagonia Fleece', discount: '40% off', timeLeft: '2 days', link: '#', brand: 'Patagonia' },
        { item: 'REI Co-op Dividend', discount: '$47 available', timeLeft: '4 days', link: '#', brand: 'REI' },
        { item: 'Whole Foods Organic', discount: '25% off', timeLeft: '1 week', link: '#', brand: 'Whole Foods' }
      ];
      
      messagesDiv.innerHTML += `
        <div style="background: rgba(251,191,36,0.2); border: 1px solid rgba(251,191,36,0.4); border-radius: 12px; padding: 16px; margin: 12px 0;">
          <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
            <i data-lucide="tag" style="width: 20px; height: 20px;"></i>
            <span>Live Deal Radar</span>
          </div>
          ${deals.map(deal => `
            <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin: 8px 0; display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div style="font-weight: 600; font-size: 14px;">${deal.item}</div>
                <div style="font-size: 12px; color: rgba(255,255,255,0.7);">${deal.discount} ‚Ä¢ ${deal.timeLeft} left</div>
              </div>
              <button onclick="window.open('${deal.link}', '_blank')" 
                      style="background: rgba(251, 191, 36, 0.3); border: 1px solid rgba(251, 191, 36, 0.6); border-radius: 6px; padding: 6px 12px; color: white; font-size: 12px; cursor: pointer;">
                <i data-lucide="external-link" style="width: 14px; height: 14px;"></i>
              </button>
            </div>
          `).join('')}
        </div>
      `;
    }
    
    function executeWeekPlanning(messagesDiv) {
      messagesDiv.innerHTML += `
        <div style="background: rgba(139, 92, 246, 0.2); border: 1px solid rgba(139, 92, 246, 0.4); border-radius: 12px; padding: 16px; margin: 12px 0;">
          <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
            <i data-lucide="calendar-days" style="width: 20px; height: 20px;"></i>
            <span>Week Command Center</span>
          </div>
          <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
            <div style="font-weight: 600; margin-bottom: 8px;">Today's Critical Path</div>
            <div style="font-size: 13px; line-height: 1.4;">
              ‚Ä¢ 3:00pm - School pickup (route clear)<br>
              ‚Ä¢ 5:30pm - Grocery run (optimized list)<br>
              ‚Ä¢ 7:00pm - Planning session (protected time)
            </div>
          </div>
          <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin: 8px 0;">
            <div style="font-weight: 600; margin-bottom: 8px;">This Week's Conflicts</div>
            <div style="font-size: 13px; line-height: 1.4;">
              ‚Ä¢ Tuesday: Double-booked 2-3pm<br>
              ‚Ä¢ Thursday: Birthday party gift needed<br>
              ‚Ä¢ Weekend: Weather perfect for outdoor plans
            </div>
          </div>
          <button onclick="showView('calendar-mobile', document.querySelector('.nav-btn[onclick*=\"calendar-mobile\"]'))" 
                  style="background: rgba(139, 92, 246, 0.3); border: 1px solid rgba(139, 92, 246, 0.6); border-radius: 8px; padding: 8px 16px; color: white; font-size: 14px; cursor: pointer;">
            <i data-lucide="calendar" style="width: 16px; height: 16px; margin-right: 4px;"></i>
            Open Calendar
          </button>
        </div>
      `;
    }
    
    function addSystemMessage(messagesDiv, message) {
      messagesDiv.innerHTML += `
        <div style="padding: 12px 20px; background: rgba(34, 197, 94, 0.2); margin: 8px 0; border-radius: 18px 18px 18px 4px; max-width: 85%; border: 1px solid rgba(34, 197, 94, 0.3);">
          ${message}
        </div>
      `;
    }
    
    function executeCalendarAdd(title, date, time) {
      // Use the advanced addToCalendar function with AI insights
      const eventTime = `${date} at ${time}`;
      
      // Determine event type from title for better AI insights
      let eventType = 'appointment';
      if (title.toLowerCase().includes('golf')) eventType = 'golf';
      else if (title.toLowerCase().includes('meeting')) eventType = 'meeting';
      else if (title.toLowerCase().includes('dentist') || title.toLowerCase().includes('doctor')) eventType = 'dentist';
      
      // Call the advanced calendar function
      addToCalendar(title, eventTime, eventType);
      
      // Show success feedback and switch to calendar view
      setTimeout(() => {
        const calendarBtn = document.querySelector('.nav-btn[onclick*="calendar-mobile"]');
        if (calendarBtn) {
          showView('calendar-mobile', calendarBtn);
        }
      }, 2000); // Give time to see the AI insights first
    }
    
    // Mobile Email Decoder Functions
    let currentUserId = null;
    let currentCategory = 'all';
    let decodedEmails = [];
    let currentDate = new Date();
    
    // Initialize on load
    window.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ Mobile app initializing...');
      
      // Initialize Lucide icons
      lucide.createIcons();
      
      // Force show chat view initially
      const chatView = document.getElementById('chat-mobile');
      const chatBtn = document.querySelector('.nav-btn[onclick*="chat-mobile"]');
      
      if (chatView && chatBtn) {
        showView('chat-mobile', chatBtn);
      }
      
      // Handle virtual keyboard visibility
      setupKeyboardHandling();
      
      // Initialize other components
      setTimeout(() => {
        checkGmailConnection();
        renderCalendar();
        // Re-initialize icons after dynamic content loads
        lucide.createIcons();
      }, 500);
    });
    
    function setupKeyboardHandling() {
      const nav = document.querySelector('.mobile-nav');
      const chatInput = document.getElementById('chatInput');
      let initialHeight = window.innerHeight;
      let keyboardOpen = false;
      
      // More reliable keyboard detection
      function detectKeyboard() {
        const currentHeight = window.innerHeight;
        const heightDiff = initialHeight - currentHeight;
        const threshold = window.innerHeight * 0.25; // 25% height change
        
        const shouldHideNav = heightDiff > threshold;
        
        if (shouldHideNav !== keyboardOpen) {
          keyboardOpen = shouldHideNav;
          
          if (keyboardOpen) {
            nav.classList.add('keyboard-open');
            document.body.style.paddingBottom = '0px';
            // Ensure input stays visible
            setTimeout(() => {
              if (chatInput === document.activeElement) {
                chatInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
              }
            }, 100);
          } else {
            nav.classList.remove('keyboard-open');
            document.body.style.paddingBottom = '90px';
          }
        }
      }
      
      // iOS viewport height adjustment
      function setViewportHeight() {
        const vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
        detectKeyboard();
      }
      
      // Initial setup
      setViewportHeight();
      
      // Event listeners with debouncing
      let resizeTimer;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(setViewportHeight, 100);
      });
      
      window.addEventListener('orientationchange', () => {
        setTimeout(() => {
          initialHeight = window.innerHeight;
          setViewportHeight();
        }, 500);
      });
      
      // Input focus handling
      if (chatInput) {
        chatInput.addEventListener('focus', function() {
          setTimeout(() => {
            nav.classList.add('keyboard-open');
            keyboardOpen = true;
            this.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 200);
        });
        
        chatInput.addEventListener('blur', function() {
          setTimeout(() => {
            if (document.activeElement !== this) {
              nav.classList.remove('keyboard-open');
              keyboardOpen = false;
              document.body.style.paddingBottom = '90px';
            }
          }, 200);
        });
      }
    }
    
    async function checkGmailConnection() {
      const statusEl = document.getElementById('connection-status');
      const connectBtn = document.getElementById('connect-gmail-mobile');
      const processBtn = document.getElementById('process-emails-mobile');
      
      if (!statusEl) {
        console.warn('Gmail status element not found');
        return;
      }
      
      // Show loading state
      statusEl.innerHTML = `
        <div style="display: flex; align-items: center; gap: 8px; color: rgba(255,255,255,0.7);">
          <div class="typing-dots">
            <span>.</span><span>.</span><span>.</span>
          </div>
          <span>Checking Gmail connection...</span>
        </div>
      `;
      
      try {
        const response = await fetch('/api/auth/status');
        const data = await response.json();
        
        if (data.authenticated && data.user_id) {
          currentUserId = data.user_id;
          statusEl.innerHTML = `
            <div style="color: rgba(34, 197, 94, 1); display: flex; align-items: center; gap: 8px;">
              <span>‚úÖ</span>
              <span>Gmail connected (${data.email || 'Unknown'})</span>
            </div>
          `;
          if (connectBtn) connectBtn.style.display = 'none';
          if (processBtn) processBtn.style.display = 'block';
          
          // Auto-load recent emails if available
          loadRecentEmails();
        } else {
          statusEl.innerHTML = `
            <div style="color: rgba(251, 191, 36, 1); display: flex; align-items: center; gap: 8px;">
              <span>‚ö†Ô∏è</span>
              <span>Gmail not connected - Click below to connect</span>
            </div>
          `;
          if (connectBtn) connectBtn.style.display = 'block';
          if (processBtn) processBtn.style.display = 'none';
        }
      } catch (error) {
        console.error('Connection check failed:', error);
        statusEl.innerHTML = `
          <div style="color: rgba(239, 68, 68, 1); display: flex; align-items: center; gap: 8px;">
            <span>‚ùå</span>
            <span>Connection check failed - Using demo mode</span>
          </div>
        `;
        if (connectBtn) connectBtn.style.display = 'block';
        if (processBtn) processBtn.style.display = 'none';
        
        // Show demo emails
        showDemoEmails();
      }
    }
    
    function showDemoEmails() {
      const emailCategories = document.getElementById('email-categories');
      if (emailCategories) {
        emailCategories.style.display = 'block';
        
        // Sophisticated demo email intelligence
        decodedEmails = [
          {
            id: 'demo1',
            subject: 'Soccer practice moved to 4pm',
            sender: 'Coach Sarah',
            category: 'family',
            priority: 'medium',
            preview: 'Hi parents, due to field maintenance...',
            summary: 'Schedule change for kids activity',
            ai_translation: "Your chief of staff says: This isn't just a schedule change‚Äîit's a ripple effect. The 4pm time means pickup conflicts with your Tuesday meetings. I've noted this for calendar optimization.",
            action_items: ['Update calendar', 'Arrange carpool backup', 'Inform spouse of time change']
          },
          {
            id: 'demo2', 
            subject: 'URGENT: Project deadline moved up',
            sender: 'Project Manager',
            category: 'urgent',
            priority: 'high',
            preview: 'The client wants to move the launch date...',
            summary: 'Work deadline change requiring immediate attention',
            ai_translation: "Red flag detected: This 'urgent' request sounds like poor planning disguised as client demands. Your energy is being hijacked. What's the real deadline vs. their panic?",
            action_items: ['Clarify actual vs. artificial urgency', 'Assess resource impact', 'Set boundaries on scope']
          },
          {
            id: 'demo3',
            subject: 'Your Patagonia order is ready for pickup',
            sender: 'Patagonia',
            category: 'commerce',
            priority: 'low',
            preview: 'Your sustainable outdoor gear awaits...',
            summary: 'Brand purchase confirmation from trusted retailer',
            ai_translation: "Smart purchase detected: Patagonia aligns with your values-based spending. Your loyalty score with this brand is 9/10.",
            commerce_intel: {
              brand_loyalty: 'High',
              purchase_pattern: 'Seasonal outdoor gear',
              recommendation: 'Consider their repair program instead of new purchases',
              similar_brands: ['REI Co-op', 'Eileen Fisher', 'Allbirds']
            }
          },
          {
            id: 'demo4',
            subject: 'Parent-Teacher Conference Available Times',
            sender: 'Lincoln Elementary',
            category: 'family',
            priority: 'medium',
            preview: 'Please select your preferred time slot...',
            summary: 'School scheduling requiring parent response',
            ai_translation: "Subtext: This is a bid for your attention disguised as scheduling. Your presence matters more than the specific time. Book it now before the good slots disappear.",
            action_items: ['Choose time slot within 24hrs', 'Block calendar time', 'Prepare questions about academic progress']
          }
        ];
        
        renderEmailInsights();
        updateChiefInsights();
      }
    }
    
    function updateChiefInsights() {
      const insightsEl = document.getElementById('chief-insights');
      const insights = [
        "I've spotted 1 urgent item that's actually manufactured urgency. Your family schedule needs 2 adjustments. Your commerce patterns show strong values alignment.",
        "3 emails require action, 1 is emotional manipulation. Your purchase behavior suggests you value sustainability over speed.",
        "Family logistics are creating calendar conflicts. I'm tracking patterns that show you're overcommitted on Tuesdays.",
        "Your inbox shows classic 'urgent vs important' confusion. Let me help you separate real deadlines from other people's poor planning."
      ];
      
      if (insightsEl) {
        insightsEl.textContent = `"${insights[Math.floor(Math.random() * insights.length)]}"`;
      }
    }
    
    async function connectGmailMobile() {
      try {
        window.location.href = '/api/auth/gmail';
      } catch (error) {
        console.error('Gmail connection failed:', error);
      }
    }
    
    async function processEmailsMobile() {
      const processBtn = document.getElementById('process-emails-mobile');
      const processingStatus = document.getElementById('processing-status');
      const emailCategories = document.getElementById('email-categories');
      
      processBtn.style.display = 'none';
      processingStatus.style.display = 'block';
      emailCategories.style.display = 'none';
      
      const messages = [
        'Scanning your inbox...',
        'Detecting calendar invites, receipts, school messages...',
        'Learning your communication patterns...',
        'Organizing by priority...'
      ];
      
      let messageIndex = 0;
      const messageEl = document.getElementById('processing-message');
      const messageInterval = setInterval(() => {
        if (messageIndex < messages.length) {
          messageEl.textContent = messages[messageIndex];
          messageIndex++;
        }
      }, 2000);
      
      try {
        const response = await fetch('/api/email-decoder/process', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_id: currentUserId })
        });
        
        clearInterval(messageInterval);
        
        if (!response.ok) {
          throw new Error('Processing failed');
        }
        
        const result = await response.json();
        decodedEmails = result.decoded_emails || [];
        
        processingStatus.style.display = 'none';
        emailCategories.style.display = 'block';
        processBtn.style.display = 'block';
        
        renderEmailCards();
        
      } catch (error) {
        clearInterval(messageInterval);
        console.error('Email processing failed:', error);
        
        processingStatus.innerHTML = `
          <div style="color: rgba(239, 68, 68, 1); padding: 16px;">
            ‚ùå Processing failed. Please check your connection and try again.
          </div>
        `;
        
        setTimeout(() => {
          processingStatus.style.display = 'none';
          processBtn.style.display = 'block';
        }, 3000);
      }
    }
    
    async function loadRecentEmails() {
      try {
        const response = await fetch(`/api/email-decoder/recent?user_id=${currentUserId}`);
        if (response.ok) {
          const data = await response.json();
          decodedEmails = data.decoded_emails || [];
          if (decodedEmails.length > 0) {
            document.getElementById('email-categories').style.display = 'block';
            renderEmailCards();
          }
        }
      } catch (error) {
        console.error('Failed to load recent emails:', error);
      }
    }
    
    function showIntelCategory(category, button) {
      // Update active tab
      document.querySelectorAll('.intel-tab').forEach(btn => {
        btn.classList.remove('active');
      });
      button.classList.add('active');
      
      currentCategory = category;
      renderEmailInsights();
      
      if (navigator.vibrate) {
        navigator.vibrate(10);
      }
    }
    
    function renderEmailInsights() {
      const container = document.getElementById('translated-emails-mobile');
      
      let filteredEmails = decodedEmails;
      if (currentCategory !== 'all') {
        filteredEmails = decodedEmails.filter(email => email.category === currentCategory);
      }
      
      if (filteredEmails.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.6);">
            ${currentCategory === 'all' ? 'No emails analyzed yet' : `No ${currentCategory} insights found`}
          </div>
        `;
        return;
      }
      
      container.innerHTML = filteredEmails.map(email => {
        const priorityClass = email.priority === 'high' ? 'priority-high' : 
                             email.priority === 'medium' ? 'priority-medium' : 'priority-low';
        
        let categorySpecificContent = '';
        
        if (email.category === 'commerce' && email.commerce_intel) {
          categorySpecificContent = `
            <div class="commerce-intel">
              <div style="font-weight: 600; margin-bottom: 8px; color: #10b981;">üí∞ Commerce Intelligence</div>
              <div style="font-size: 13px; line-height: 1.4;">
                <div>‚Ä¢ Brand Loyalty: <span class="brand-loyalty">${email.commerce_intel.brand_loyalty}</span></div>
                <div>‚Ä¢ Pattern: ${email.commerce_intel.purchase_pattern}</div>
                <div>‚Ä¢ Recommendation: ${email.commerce_intel.recommendation}</div>
                <div>‚Ä¢ Similar Values-Based Brands: ${email.commerce_intel.similar_brands.join(', ')}</div>
              </div>
            </div>
          `;
        }
        
        return `
          <div class="email-insight-card" onclick="openEmailInsight('${email.id}')">
            <div class="insight-priority ${priorityClass}">${email.priority}</div>
            <div class="email-subject">${email.subject || 'No Subject'}</div>
            <div class="email-meta">
              <span>${email.sender || 'Unknown Sender'}</span>
              <span class="email-category">${email.category || 'General'}</span>
            </div>
            
            ${email.ai_translation ? `
              <div class="ai-translation">
                <strong>üß† AI Translation:</strong><br>
                ${email.ai_translation}
              </div>
            ` : ''}
            
            ${categorySpecificContent}
            
            ${email.action_items ? `
              <div style="margin-top: 12px;">
                <div style="font-weight: 600; font-size: 13px; margin-bottom: 6px; color: rgba(255,255,255,0.9);">‚ö° Action Items:</div>
                <div style="font-size: 12px; color: rgba(255,255,255,0.8);">
                  ${email.action_items.map(item => `‚Ä¢ ${item}`).join('<br>')}
                </div>
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }
    
    function openEmailInsight(emailId) {
      // Enhanced interaction for email insights
      const email = decodedEmails.find(e => e.id === emailId);
      if (email) {
        console.log('Opening detailed insight for:', email.subject);
        // Could open modal or detailed view
        if (navigator.vibrate) {
          navigator.vibrate(20);
        }
      }
    }
    
    // Calendar Functions
    function renderCalendar() {
      const calendarDays = document.getElementById('calendar-days');
      const monthEl = document.getElementById('current-month');
      
      if (!calendarDays || !monthEl) {
        console.warn('Calendar elements not found');
        return;
      }
      
      const months = ['January', 'February', 'March', 'April', 'May', 'June',
                     'July', 'August', 'September', 'October', 'November', 'December'];
      
      monthEl.textContent = `üìÖ ${months[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
      
      const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
      const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
      const startDate = new Date(firstDay);
      startDate.setDate(startDate.getDate() - firstDay.getDay());
      
      const today = new Date();
      const daysHtml = [];
      
      for (let i = 0; i < 42; i++) {
        const day = new Date(startDate);
        day.setDate(startDate.getDate() + i);
        
        const isToday = day.toDateString() === today.toDateString();
        const isCurrentMonth = day.getMonth() === currentDate.getMonth();
        const hasEvents = Math.random() > 0.7; // Simulate some events
        
        let classes = 'calendar-day';
        if (isToday) classes += ' today';
        if (!isCurrentMonth) classes += ' other-month';
        if (hasEvents && isCurrentMonth) classes += ' has-events';
        
        daysHtml.push(`<div class="${classes}" onclick="selectDate('${day.toISOString()}')">${day.getDate()}</div>`);
      }
      
      calendarDays.innerHTML = daysHtml.join('');
      console.log('Calendar rendered with', daysHtml.length, 'days');
    }
    
    function changeMonth(direction) {
      currentDate.setMonth(currentDate.getMonth() + direction);
      renderCalendar();
      
      if (navigator.vibrate) {
        navigator.vibrate(10);
      }
    }
    
    function selectDate(dateString) {
      console.log('Selected date:', dateString);
      if (navigator.vibrate) {
        navigator.vibrate(10);
      }
    }
    
    function addEventMobile() {
      const eventTitle = prompt('Event title:');
      if (eventTitle) {
        const todayList = document.getElementById('today-events-list');
        todayList.innerHTML += `
          <div class="event-item">
            <div class="event-title">${eventTitle}</div>
            <div class="event-time">Added just now</div>
          </div>
        `;
      }
    }
    
    async function callHomeOpsAI(message) {
      // Connect to your actual HomeOps AI with full capabilities
      try {
        const response = await fetch('/api/homeops-agent', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            message: message,
            context: {
              platform: 'mobile-chat',
              user_id: currentUserId || 'mobile-user',
              capabilities: ['calendar', 'email', 'commerce', 'scheduling', 'gift-recommendations'],
              current_view: document.querySelector('.mobile-view.active')?.id || 'chat-mobile',
              has_gmail_access: currentUserId ? true : false,
              decoded_emails: decodedEmails.length > 0 ? decodedEmails.slice(0, 5) : null
            },
            tone_model: 'homeops-chief-of-staff-v2',
            enable_actions: true,
            capabilities: [
              'calendar_injection',
              'email_surfacing', 
              'deal_detection',
              'gift_recommendations',
              'week_planning',
              'task_management'
            ]
          })
        });
        
        if (!response.ok) {
          throw new Error(`Backend error: ${response.status}`);
        }
        
        const data = await response.json();
        
        // Handle AI-suggested actions
        if (data.suggested_actions) {
          handleAISuggestedActions(data.suggested_actions);
        }
        
        return data.response || data.message || "I'm analyzing your request...";
        
      } catch (error) {
        console.error('HomeOps AI Backend Error:', error);
        
        // Use the action-oriented Chief of Staff responses
        return generateChiefOfStaffResponse(message);
      }
    }
    
    // Handle AI-suggested actions from backend
    function handleAISuggestedActions(actions) {
      actions.forEach(action => {
        switch(action.type) {
          case 'calendar_event':
            // Auto-inject calendar events
            console.log('AI suggests calendar event:', action.data);
            showCalendarSuggestion(action.data);
            break;
          case 'email_surface':
            // Surface important emails
            console.log('AI suggests surfacing email:', action.data);
            highlightImportantEmail(action.data);
            break;
          case 'deal_alert':
            // Show deal recommendations
            console.log('AI found relevant deal:', action.data);
            showDealAlert(action.data);
            break;
          case 'gift_recommendation':
            // Show gift suggestions
            console.log('AI gift recommendation:', action.data);
            showGiftSuggestion(action.data);
            break;
          case 'task_automation':
            // Automate routine tasks
            console.log('AI suggests automation:', action.data);
            executeTaskAutomation(action.data);
            break;
        }
      });
    }
    
    function showCalendarSuggestion(eventData) {
      // Show inline calendar injection option
      const messagesDiv = document.querySelector('.chat-messages-mobile');
      messagesDiv.innerHTML += `
        <div style="background: rgba(34, 197, 94, 0.2); border: 1px solid rgba(34, 197, 94, 0.4); border-radius: 12px; padding: 16px; margin: 12px 0;">
          <div style="font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
            üìÖ <span>Ready to add to calendar</span>
          </div>
          <div style="font-size: 14px; margin-bottom: 12px;">
            <strong>${eventData.title}</strong><br>
            ${eventData.date} at ${eventData.time}
          </div>
          <button onclick="executeCalendarAdd('${eventData.id}')" style="background: rgba(34, 197, 94, 0.3); border: 1px solid rgba(34, 197, 94, 0.6); border-radius: 8px; padding: 8px 16px; color: white; font-size: 14px; cursor: pointer;">
            Add to Calendar
          </button>
        </div>
      `;
    }
    
    function showDealAlert(dealData) {
      // Show relevant deal notifications
      const messagesDiv = document.querySelector('.chat-messages-mobile');
      messagesDiv.innerHTML += `
        <div style="background: rgba(251, 191, 36, 0.2); border: 1px solid rgba(251, 191, 36, 0.4); border-radius: 12px; padding: 16px; margin: 12px 0;">
          <div style="font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
            üõçÔ∏è <span>Deal Alert</span>
          </div>
          <div style="font-size:  14px; margin-bottom: 12px;">
            <strong>${dealData.item}</strong><br>
            ${dealData.discount} off - ${dealData.timeLeft} left
          </div>
          <button onclick="window.open('${dealData.link}', '_blank')" style="background: rgba(251, 191, 36, 0.3); border: 1px solid rgba(251, 191, 36, 0.6); border-radius: 8px; padding: 8px 16px; color: white; font-size: 14px; cursor: pointer;">
            View Deal
          </button>
        </div>
      `;
    }
    
    function injectCalendarEvent(eventId) {
      // Calendar injection functionality
      console.log('Injecting calendar event:', eventId);
      // Switch to calendar view and add event
      const calendarBtn = document.querySelector('.nav-btn[onclick*="calendar-mobile"]');
      showView('calendar-mobile', calendarBtn);
      // Show success feedback
      alert('Event added to calendar!');
    }
    
    // Enter key support for chat
    document.getElementById('chatInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });
    
    function generateChiefOfStaffResponse(message) {
      const msg = message.toLowerCase();
      
      // Calendar/scheduling requests - Enhanced detection
      if (msg.includes('golf') || msg.includes('calendar') || msg.includes('schedule') || msg.includes('add') || msg.includes('appointment') || msg.includes('event') || msg.includes('make a') || msg.includes('create')) {
        if (msg.includes('golf')) {
          if (msg.includes('tomorrow') || msg.includes('1pm')) {
            return `üèåÔ∏è **Golf Tomorrow 1pm - Calendar Injection Ready**
            
üìÖ **Event Details:**
‚Ä¢ Golf - Tomorrow at 1:00 PM
‚Ä¢ Duration: 4 hours (including travel)
‚Ä¢ Weather: Perfect conditions (73¬∞F)
            
‚ö†Ô∏è **Conflict Detection:**
‚Ä¢ No conflicts found for 1-5pm slot
‚Ä¢ Recommended: Block 12:30-5:30pm (prep + buffer)
            
üöó **Logistics:**
‚Ä¢ 30min drive to course
‚Ä¢ Suggest leaving at 12:30pm
‚Ä¢ Return by 5:30pm
            
**Ready to inject into calendar?** I can auto-block the time and set travel reminders.
            
*Say "add it" or "inject calendar event" to execute.*`;
          }
          return `Golf event detected - I need the specific time and date to inject this into your calendar. Tomorrow? What time? I'll handle travel time and conflict detection.`;
        }
        
        if (msg.includes('tomorrow') && (msg.includes('1pm') || msg.includes('1:00'))) {
          return `üìÖ **Calendar Event Ready for Injection**
          
**Event**: Tomorrow at 1:00 PM
**Duration**: I'll estimate 2 hours unless you specify
**Conflicts**: Checking your calendar now...
          
‚úÖ **Time slot available**
üöó **Travel time**: I can add buffer if needed
‚è∞ **Reminders**: 1 hour and 15 minutes before
          
Ready to add this to your calendar? Just say "add it" and I'll inject the event with smart defaults.`;
        }
        
        return `I can inject calendar events for you. Give me specifics: What event, what day, what time? I'll handle conflicts, travel time, and reminders automatically.`;
      }
      
      // Email/inbox management
      if (msg.includes('email') || msg.includes('inbox') || msg.includes('important')) {
        const urgentCount = decodedEmails.filter(e => e.priority === 'high').length;
        const familyCount = decodedEmails.filter(e => e.category === 'family').length;
        
        return `üìß **Inbox Intelligence Summary:**
        
üö® ${urgentCount} urgent items need your attention
üë®‚Äçüë©‚Äçüëß‚Äçüë¶ ${familyCount} family logistics requiring response
üõçÔ∏è 3 commerce opportunities (1 sale ends tonight)
        
**Top Priority**: School conference signup closes in 2 days
**Hidden Gem**: REI Co-op dividend expires this week ($47 available)
**Time Saver**: Amazon Subscribe & Save can handle your recurring orders
        
Want me to surface the actionable emails in priority order?`;
      }
      
      // Deal detection and commerce
      if (msg.includes('deal') || msg.includes('buy') || msg.includes('shopping') || msg.includes('gift')) {
        if (msg.includes('gift') || msg.includes('birthday')) {
          return `üéÅ **Gift Intelligence Activated**
          
For the birthday party - I'm analyzing the family's purchase patterns:
‚Ä¢ **Age range**: 6-8 year old detected from context
‚Ä¢ **Values alignment**: STEM toys, outdoor activities, books
‚Ä¢ **Budget sweet spot**: $25-40 based on your spending
‚Ä¢ **Trending picks**: Magna-Tiles (30% off at Target), National Geographic Break Open Geodes
          
**Pro move**: Order now with 2-day shipping, or I can add Target pickup to your grocery run route.
          
Should I compile the full gift recommendation with backup options?`;
        }
        return `üõçÔ∏è **Live Deal Radar:**
        
‚Ä¢ **Patagonia**: 40% off fleece (your brand loyalty score: 9/10)
‚Ä¢ **Whole Foods**: Prime member exclusive - organic produce 25% off
‚Ä¢ **REI Co-op**: Dividend claim deadline in 4 days ($47 waiting)
        
Based on your purchase patterns, the Patagonia deal aligns with your winter prep timeline. Want me to add it to cart?`;
      }
      
      // Week planning and overview
      if (msg.includes('week') || msg.includes('today') || msg.includes('tomorrow') || msg.includes('plan')) {
        return `üìä **Week Command Center:**
        
**Today's Critical Path:**
‚Ä¢ 3:00pm - School pickup (usual route clear)
‚Ä¢ 5:30pm - Grocery run (list optimized by store layout)
‚Ä¢ 7:00pm - Parent planning session (you blocked this time)
        
**This Week's Hotspots:**
‚Ä¢ Tuesday: Double-booked 2-3pm (meeting + soccer pickup)
‚Ä¢ Thursday: Birthday party gift needed (I have recommendations)
‚Ä¢ Weekend: Weather perfect for outdoor plans
        
**Optimization Suggestion**: Batch your Target run with Wednesday errands. Save 45 minutes.
        
Want me to restructure Tuesday's conflict?`;
      }
      
      // Task and productivity management
      if (msg.includes('overwhelm') || msg.includes('stressed') || msg.includes('too much') || msg.includes('help')) {
        return `üéØ **Load Balancing Protocol Activated**
        
I'm seeing 3 stress patterns in your data:
1. **Calendar density**: 85% booked (healthy max is 70%)
2. **Response lag**: 12 unopened family logistics emails
3. **Decision fatigue**: 8 pending RSVPs and purchases
        
**Immediate Relief Plan:**
‚Ä¢ Auto-decline 2 optional meetings this week
‚Ä¢ Batch-process family emails in 15-min block
‚Ä¢ I'll handle 3 routine purchases (recurring orders)
        
**The Real Issue**: You're managing everyone else's poor planning. Let's create some boundaries.
        
Should I execute the relief plan and show you the boundary scripts?`;
      }
      
      // Test/demo responses
      if (msg.includes('test') || msg.length < 10) {
        return `üß† **Systems Check Complete**
        
HomeOps Chief of Staff fully operational:
‚úÖ Calendar injection ready
‚úÖ Email intelligence active  
‚úÖ Commerce radar scanning
‚úÖ Gift recommendations loaded
‚úÖ Week planning algorithms running
        
I'm not just a chatbot - I'm your operational brain. Try asking me to:
‚Ä¢ "Add golf to my calendar tomorrow"
‚Ä¢ "What deals should I know about?"
‚Ä¢ "Help me plan this week"
‚Ä¢ "Find a gift for the birthday party"
        
What's your first mission for me?`;
      }
      
      // Default action-oriented response
      return `üéØ **Ready to Execute**
      
I heard: "${message}"
      
**Quick Actions Available:**
‚Ä¢ Say "Add [event] on [day] at [time]" for calendar injection
‚Ä¢ Say "Show urgent emails" for inbox intelligence  
‚Ä¢ Say "Find deals" for commerce opportunities
‚Ä¢ Say "Plan my week" for schedule optimization
      
**Example**: "I have a doctor appointment Tuesday at 3pm"
      
What action should I take for you?`;
    }
    
    // Deal Intelligence (RCS-style) - Smart deal detection with one-click actions
    function executeDealIntelligence(message, messagesDiv) {
      const msg = message.toLowerCase();
      
      // Smart deal categories based on current context
      const smartDeals = [
        {
          category: 'Tech & Electronics',
          merchant: 'Best Buy',
          offer: '30% off MacBook Air M3',
          originalPrice: '$1,299',
          dealPrice: '$909',
          savings: '$390',
          urgency: 'Ends Tonight',
          link: 'https://bestbuy.com/macbook-deal',
          icon: 'laptop'
        },
        {
          category: 'Home & Garden',
          merchant: 'Home Depot',
          offer: 'Summer Tool Sale',
          originalPrice: '$249',
          dealPrice: '$149',
          savings: '$100',
          urgency: '3 days left',
          link: 'https://homedepot.com/tool-sale',
          icon: 'hammer'
        },
        {
          category: 'Fashion',
          merchant: 'Nike',
          offer: 'Air Max Collection',
          originalPrice: '$150',
          dealPrice: '$89',
          savings: '$61',
          urgency: 'Limited sizes',
          link: 'https://nike.com/air-max-sale',
          icon: 'shirt'
        }
      ];
      
      messagesDiv.innerHTML += `
        <div style="background: rgba(251, 191, 36, 0.2); border: 1px solid rgba(251, 191, 36, 0.4); border-radius: 12px; padding: 16px; margin: 12px 0;">
          <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
            <i data-lucide="zap" style="width: 20px; height: 20px;"></i>
            <span>Deal Intelligence</span>
            <span style="background: rgba(34, 197, 94, 0.3); padding: 2px 6px; border-radius: 4px; font-size: 10px;">RCS POWERED</span>
          </div>
          
          <div style="margin-bottom: 12px;">
            ${smartDeals.map(deal => `
              <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin: 8px 0; display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                    <i data-lucide="${deal.icon}" style="width: 16px; height: 16px;"></i>
                    <span style="font-weight: 600; font-size: 14px;">${deal.offer}</span>
                  </div>
                  <div style="font-size: 12px; color: rgba(255,255,255,0.7);">${deal.merchant} ‚Ä¢ ${deal.category}</div>
                  <div style="margin-top: 4px;">
                    <span style="text-decoration: line-through; color: rgba(255,255,255,0.5); font-size: 13px;">${deal.originalPrice}</span>
                    <span style="font-weight: 700; font-size: 16px; margin-left: 8px; color: #4ade80;">${deal.dealPrice}</span>
                    <span style="background: rgba(34, 197, 94, 0.3); padding: 2px 4px; border-radius: 4px; font-size: 10px; margin-left: 6px;">Save ${deal.savings}</span>
                  </div>
                </div>
                <div style="text-align: right;">
                  <div style="background: rgba(239, 68, 68, 0.3); padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-bottom: 4px;">${deal.urgency}</div>
                </div>
              </div>
            `).join('')}
          </div>
          
          <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 6px; font-size: 12px; margin-top: 8px;">
            <i data-lucide="info" style="width: 14px; height: 14px; margin-right: 4px;"></i>
            Deals curated from your email intelligence and shopping patterns
          </div>
        </div>
      `;
      setTimeout(() => lucide.createIcons(), 100);
    }
    
    // Email Summary - Intelligent email digest
    function executeEmailSummary(message, messagesDiv) {
      // Show loading state first
      messagesDiv.innerHTML += `
        <div id="email-summary-loading" style="background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.4); border-radius: 12px; padding: 16px; margin: 12px 0; text-align: center;">
          <div class="typing-dots" style="margin-bottom: 8px;">
            <span>.</span><span>.</span><span>.</span>
          </div>
          <div>Scanning your inbox with AI intelligence...</div>
        </div>
      `;
      
      // Simulate processing time
      setTimeout(() => {
        document.getElementById('email-summary-loading').remove();
        
        // Use realistic email data (would connect to actual email decoder in production)
        const emailSummary = {
          totalEmails: 47,
          todayCount: 8,
          unreadCount: 12,
          urgentCount: 3,
          categories: {
            urgent: [
              { subject: 'Project deadline moved to Monday - URGENT', from: 'sarah@company.com', importance: 'high', time: '2:30 PM' },
              { subject: 'Security alert: New device login detected', from: 'security@chase.com', importance: 'high', time: '10:55 AM' },
              { subject: 'Kids soccer practice moved to 4pm Saturday', from: 'coach.martinez@soccerclub.org', importance: 'high', time: '12:45 PM' }
            ],
            deals: [
              { subject: '70% off Summer Collection - Ends Tonight!', from: 'deals@nordstrom.com', savings: 'Up to 70%', urgency: 'Tonight' },
              { subject: 'Amazon Prime Day Preview - Up to 50% off Tech', from: 'no-reply@amazon.com', savings: 'Up to 50%', urgency: 'Tomorrow' },
              { subject: 'Home Depot Tool Sale - 40% off Power Tools', from: 'deals@homedepot.com', savings: '40% off', urgency: '3 days' }
            ],
            family: [
              { subject: 'Birthday party invitation - Emma turns 8!', from: 'jenny.mom@gmail.com', time: '8:15 AM' },
              { subject: 'Kids soccer practice moved to 4pm Saturday', from: 'coach.martinez@soccerclub.org', time: '12:45 PM' }
            ],
            work: [
              { subject: 'Q3 Performance Review Scheduled', from: 'hr@company.com', time: '7:45 AM' },
              { subject: 'Project deadline moved to Monday - URGENT', from: 'sarah@company.com', time: '2:30 PM' }
            ]
          }
        };
        
        messagesDiv.innerHTML += `
          <div style="background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.4); border-radius: 12px; padding: 16px; margin: 12px 0;">
            <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
              <i data-lucide="mail-open" style="width: 20px; height: 20px;"></i>
              <span>Email Intelligence Summary</span>
              <span style="background: rgba(34, 197, 94, 0.3); padding: 2px 6px; border-radius: 4px; font-size: 10px;">LIVE</span>
            </div>
            
            <!-- Email Stats -->
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom: 16px;">
              <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 6px; text-align: center;">
                <div style="font-weight: 700; font-size: 16px;">${emailSummary.todayCount}</div>
                <div style="font-size: 10px; color: rgba(255,255,255,0.7);">Today</div>
              </div>
              <div style="background: rgba(251, 191, 36, 0.3); padding: 8px; border-radius: 6px; text-align: center;">
                <div style="font-weight: 700; font-size: 16px;">${emailSummary.unreadCount}</div>
                <div style="font-size: 10px; color: rgba(255,255,255,0.7);">Unread</div>
              </div>
              <div style="background: rgba(239, 68, 68, 0.3); padding: 8px; border-radius: 6px; text-align: center;">
                <div style="font-weight: 700; font-size: 16px;">${emailSummary.urgentCount}</div>
                <div style="font-size: 10px; color: rgba(255,255,255,0.7);">Urgent</div>
              </div>
              <div style="background: rgba(34, 197, 94, 0.3); padding: 8px; border-radius: 6px; text-align: center;">
                <div style="font-weight: 700; font-size: 16px;">${emailSummary.categories.deals.length}</div>
                <div style="font-size: 10px; color: rgba(255,255,255,0.7);">Deals</div>
              </div>
            </div>
            
            <!-- Priority Emails -->
            <div style="margin-bottom: 12px;">
              <div style="font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
                <i data-lucide="alert-triangle" style="width: 16px; height: 16px;"></i>
                Needs Immediate Attention
              </div>
              ${emailSummary.categories.urgent.map(email => `
                <div style="background: rgba(239, 68, 68, 0.2); padding: 10px; border-radius: 6px; margin: 6px 0; border-left: 3px solid rgba(239, 68, 68, 0.6);">
                  <div style="font-weight: 600; font-size: 13px; margin-bottom: 2px;">${email.subject}</div>
                  <div style="font-size: 11px; color: rgba(255,255,255,0.7); display: flex; justify-content: space-between;">
                    <span>From: ${email.from}</span>
                    <span>${email.time}</span>
                  </div>
                </div>
              `).join('')}
            </div>
            
            <!-- Deal Highlights -->
            <div style="margin-bottom: 12px;">
              <div style="font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
                <i data-lucide="tag" style="width: 16px; height: 16px;"></i>
                Deal Highlights
              </div>
              ${emailSummary.categories.deals.map(email => `
                <div style="background: rgba(34, 197, 94, 0.2); padding: 10px; border-radius: 6px; margin: 6px 0; border-left: 3px solid rgba(34, 197, 94, 0.6);">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                      <div style="font-weight: 600; font-size: 13px;">${email.subject}</div>
                      <div style="font-size: 11px; color: rgba(255,255,255,0.7);">${email.from}</div>
                    </div>
                    <div>
                      <div style="background: rgba(34, 197, 94, 0.3); padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-bottom: 4px;">${email.savings}</div>
                      <div style="font-size: 10px; color: rgba(255,255,255,0.7); text-align: center; margin-top: 2px;">${email.urgency}</div>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
            
            <div style="display: flex; gap: 8px;">
              <button onclick="openFullInbox()" style="background: rgba(59, 130, 246, 0.3); border: 1px solid rgba(59, 130, 246, 0.6); border-radius: 8px; padding: 8px 16px; color: white; font-size: 14px; cursor: pointer; flex: 1;">
                <i data-lucide="external-link" style="width: 16px; height: 16px; margin-right: 4px;"></i>
                Open Gmail
              </button>
              <button onclick="processLatestEmails()" style="background: rgba(16, 185, 129, 0.3); border: 1px solid rgba(16, 185, 129, 0.6); border-radius: 8px; padding: 8px 16px; color: white; font-size: 14px; cursor: pointer;">
                <i data-lucide="refresh-cw" style="width: 16px; height: 16px;"></i>
              </button>
            </div>
          </div>
        `;
        setTimeout(() => lucide.createIcons(), 100);
      }, 1500);
    }
    
    // Helper functions for new RCS-style functionality
    function browseDeals(category) {
      const messagesDiv = document.querySelector('.chat-messages-mobile');
      addSystemMessage(messagesDiv, `üõçÔ∏è Opening ${category} deals in browser...`);
      setTimeout(() => {
        window.open('https://deals.homeops.ai/' + category.toLowerCase().replace(/\s+/g, '-'), '_blank');
      }, 500);
    }
    
    function quickBuy(item, price) {
      const messagesDiv = document.querySelector('.chat-messages-mobile');
      addSystemMessage(messagesDiv, `‚ö° Quick Buy: "${item}" for ${price}. Redirecting to secure checkout...`);
      // In production, this would integrate with payment APIs
    }
    
    function openFullInbox() {
      const messagesDiv = document.querySelector('.chat-messages-mobile');
      addSystemMessage(messagesDiv, `üìß Opening Gmail in new tab...`);
      setTimeout(() => {
        window.open('https://mail.google.com', '_blank');
      }, 500);
    }
    
    function processLatestEmails() {
      const messagesDiv = document.querySelector('.chat-messages-mobile');
      addSystemMessage(messagesDiv, `üîÑ Refreshing email intelligence... This may take a moment.`);
      
      // Simulate processing
      setTimeout(() => {
        addSystemMessage(messagesDiv, `‚úÖ Email scan complete! Found 3 new urgent emails and 2 new deals.`);
      }, 2000);
    }
    
    // Calendar Functions - Enhanced with AI intelligence
    function addToCalendar(eventTitle, eventTime, eventType = 'meeting') {
      const messagesDiv = document.querySelector('.chat-messages-mobile');
      
      // Add to calendar with AI intelligence
      const aiInsights = generateEventInsights(eventTitle, eventType);
      
      addSystemMessage(messagesDiv, `‚úÖ Added "${eventTitle}" to your calendar for ${eventTime}`);
      
      // Show AI-powered event details
      setTimeout(() => {
        messagesDiv.innerHTML += `
          <div style="background: rgba(34, 197, 94, 0.2); border: 1px solid rgba(34, 197, 94, 0.4); border-radius: 12px; padding: 16px; margin: 12px 0;">
            <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
              <i data-lucide="calendar-check" style="width: 20px; height: 20px;"></i>
              <span>Smart Event Details</span>
            </div>
            
            <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
              <div style="font-weight: 600; font-size: 16px; margin-bottom: 4px;">${eventTitle}</div>
              <div style="font-size: 14px; color: rgba(255,255,255,0.8); margin-bottom: 8px;">${eventTime}</div>
              <div style="font-size: 12px; color: rgba(255,255,255,0.6);">
                <i data-lucide="brain" style="width: 12px; height: 12px; margin-right: 4px;"></i>
                ${aiInsights.reframe}
              </div>
            </div>
            
            <div style="margin-bottom: 12px;">
              <div style="font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
                <i data-lucide="check-circle" style="width: 16px; height: 16px;"></i>
                Smart Checklist
              </div>
              ${aiInsights.checklist.map(item => `
                <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 6px; margin: 4px 0; font-size: 13px;">
                  <i data-lucide="square" style="width: 12px; height: 12px; margin-right: 6px;"></i>
                  ${item}
                </div>
              `).join('')}
            </div>
            
            <button onclick="viewEventDetails('${eventTitle}', '${eventTime}')" style="background: rgba(34, 197, 94, 0.3); border: 1px solid rgba(34, 197, 94, 0.6); border-radius: 8px; padding: 8px 16px; color: white; font-size: 14px; cursor: pointer; width: 100%;">
              <i data-lucide="eye" style="width: 16px; height: 16px; margin-right: 4px;"></i>
              View Full Event Details
            </button>
          </div>
        `;
      }, 500);
    }
    
    function generateEventInsights(eventTitle, eventType) {
      const title = eventTitle.toLowerCase();
      
      // AI-powered insights based on event type and content
      const insights = {
        'golf': {
          reframe: "Perfect time to network and think strategically while enjoying the outdoors.",
          checklist: [
            "Check weather forecast and dress appropriately",
            "Bring business cards for networking opportunities", 
            "Confirm tee time and arrival 15 minutes early",
            "Pack sunscreen and stay hydrated"
          ]
        },
        'meeting': {
          reframe: "This is an opportunity to collaborate and move important projects forward.",
          checklist: [
            "Review agenda and prepare talking points",
            "Test video/audio setup if virtual meeting",
            "Gather relevant documents and data",
            "Set clear objectives for the discussion"
          ]
        },
        'dentist': {
          reframe: "Taking care of your health is an investment in your future well-being.",
          checklist: [
            "Arrive 10 minutes early for paperwork",
            "Bring insurance card and ID",
            "List any concerns or pain to discuss",
            "Schedule next cleaning before leaving"
          ]
        },
        'appointment': {
          reframe: "This dedicated time will help you make progress on important matters.",
          checklist: [
            "Confirm appointment time and location",
            "Prepare questions or topics to discuss",
            "Bring necessary documents or information",
            "Allow extra travel time"
          ]
        }
      };
      
      // Determine event type from title
      let detectedType = 'appointment';
      if (title.includes('golf')) detectedType = 'golf';
      else if (title.includes('meeting') || title.includes('standup') || title.includes('call')) detectedType = 'meeting';
      else if (title.includes('dentist') || title.includes('doctor') || title.includes('medical')) detectedType = 'dentist';
      
      return insights[detectedType] || insights['appointment'];
    }
    
    function viewEventDetails(title, time) {
      const messagesDiv = document.querySelector('.chat-messages-mobile');
      
      messagesDiv.innerHTML += `
        <div style="background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.4); border-radius: 12px; padding: 16px; margin: 12px 0;">
          <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
            <i data-lucide="calendar-days" style="width: 20px; height: 20px;"></i>
            <span>Full Event Analysis</span>
          </div>
          
          <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
            <div style="font-weight: 600; font-size: 16px; margin-bottom: 4px;">${title}</div>
            <div style="color: rgba(255,255,255,0.8); margin-bottom: 8px;">${time}</div>
            <div style="font-size: 12px; color: rgba(255,255,255,0.6);">
              <i data-lucide="clock" style="width: 12px; height: 12px; margin-right: 4px;"></i>
              Estimated duration: 1 hour
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
            <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 6px; text-align: center;">
              <i data-lucide="map-pin" style="width: 16px; height: 16px; margin-bottom: 4px;"></i>
              <div style="font-size: 12px;">Location TBD</div>
            </div>
            <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 6px; text-align: center;">
              <i data-lucide="users" style="width: 16px; height: 16px; margin-bottom: 4px;"></i>
              <div style="font-size: 12px;">Just you</div>
            </div>
          </div>
          
          <div style="display: flex; gap: 8px;">
            <button onclick="editEvent('${title}')" style="background: rgba(251, 191, 36, 0.3); border: 1px solid rgba(251, 191, 36, 0.6); border-radius: 8px; padding: 8px 16px; color: white; font-size: 14px; cursor: pointer; flex: 1;">
              <i data-lucide="edit" style="width: 16px; height: 16px; margin-right: 4px;"></i>
              Edit
            </button>
            <button onclick="deleteEvent('${title}')" style="background: rgba(239, 68, 68, 0.3); border: 1px solid rgba(239, 68, 68, 0.6); border-radius: 8px; padding: 8px 16px; color: white; font-size: 14px; cursor: pointer;">
              <i data-lucide="trash-2" style="width: 16px; height: 16px;"></i>
            </button>
          </div>
        </div>
      `;
      setTimeout(() => lucide.createIcons(), 100);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
    
    function editEvent(title) {
      const messagesDiv = document.querySelector('.chat-messages-mobile');
      addSystemMessage(messagesDiv, `‚úèÔ∏è Edit mode for "${title}". Say something like "Change the time to 3pm" or "Move to tomorrow"`);
    }
    
    function deleteEvent(title) {
      const messagesDiv = document.querySelector('.chat-messages-mobile');
      addSystemMessage(messagesDiv, `üóëÔ∏è Deleted "${title}" from your calendar`);
    }
    
    function editEventDetails(title, date, time) {
      const messagesDiv = document.querySelector('.chat-messages-mobile');
      
      messagesDiv.innerHTML += `
        <div style="background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.4); border-radius: 12px; padding: 16px; margin: 12px 0;">
          <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
            <i data-lucide="edit-3" style="width: 20px; height: 20px;"></i>
            <span>Edit Event Details</span>
          </div>
          
          <div style="margin-bottom: 12px;">
            <div style="margin-bottom: 8px;">
              <label style="font-weight: 600; font-size: 12px; display: block; margin-bottom: 4px;">Event Title</label>
              <input type="text" value="${title}" id="edit-title" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; font-size: 14px;">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
              <div>
                <label style="font-weight: 600; font-size: 12px; display: block; margin-bottom: 4px;">Date</label>
                <input type="text" value="${date}" id="edit-date" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; font-size: 14px;">
              </div>
              <div>
                <label style="font-weight: 600; font-size: 12px; display: block; margin-bottom: 4px;">Time</label>
                <input type="text" value="${time}" id="edit-time" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; font-size: 14px;">
              </div>
            </div>
          </div>
          
          <div style="display: flex; gap: 8px;">
            <button onclick="saveEventEdits()" style="background: rgba(34, 197, 94, 0.3); border: 1px solid rgba(34, 197, 94, 0.6); border-radius: 8px; padding: 8px 16px; color: white; font-size: 14px; cursor: pointer; flex: 1;">
              <i data-lucide="save" style="width: 16px; height: 16px; margin-right: 4px;"></i>
              Save Changes
            </button>
            <button onclick="cancelEventEdit()" style="background: rgba(239, 68, 68, 0.3); border: 1px solid rgba(239, 68, 68, 0.6); border-radius: 8px; padding: 8px 16px; color: white; font-size: 14px; cursor: pointer;">
              <i data-lucide="x" style="width: 16px; height: 16px;"></i>
            </button>
          </div>
        </div>
      `;
      setTimeout(() => lucide.createIcons(), 100);
    }
    
    function saveEventEdits() {
      const title = document.getElementById('edit-title').value;
      const date = document.getElementById('edit-date').value;
      const time = document.getElementById('edit-time').value;
      
      const messagesDiv = document.querySelector('.chat-messages-mobile');
      addSystemMessage(messagesDiv, `‚úÖ Updated event: "${title}" for ${date} at ${time}`);
      
      // Re-add to calendar with updated details
      executeCalendarAdd(title, date, time);
    }
    
    function cancelEventEdit() {
      const messagesDiv = document.querySelector('.chat-messages-mobile');
      addSystemMessage(messagesDiv, `‚ùå Edit cancelled`);
    }
    
    // ...existing code...
  </script>
</body>
</html>
